{% extends "base.html" %}

{% block title %}工资管理 - HRMS{% endblock %}

{% block extra_head %}
<script src="/static/js/schema-utils.js"></script>
{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-900">工资管理</h2>
        <p class="mt-1 text-sm text-gray-500">计算并生成工资单，查看历史工资记录</p>
    </div>

    <!-- Tab 导航 -->
    <div class="border-b border-gray-200 mb-6">
        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
            <button id="tab-generate" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600">
                生成工资单
            </button>
            <button id="tab-list" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                工资单列表
            </button>
        </nav>
    </div>

    <!-- Tab 1: 生成工资单 -->
    <div id="section-generate" class="tab-content">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">选择计算条件</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label for="generate-period" class="block text-sm font-medium text-gray-700 mb-1">工资周期</label>
                    <input type="month" id="generate-period" class="w-full px-3 py-2 border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="generate-company" class="block text-sm font-medium text-gray-700 mb-1">公司</label>
                    <select id="generate-company" class="w-full px-3 py-2 border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">请选择公司</option>
                    </select>
                </div>
                <div>
                    <label for="generate-person" class="block text-sm font-medium text-gray-700 mb-1">人员</label>
                    <select id="generate-person" class="w-full px-3 py-2 border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">请先选择公司</option>
                    </select>
                </div>
            </div>

            <div class="flex justify-end gap-3">
                <button id="calculate-btn" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">
                    计算工资
                </button>
            </div>
        </div>

        <!-- 计算结果预览 -->
        <div id="calculation-result" class="hidden mt-6 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">计算结果预览</h3>
                <button id="generate-payroll-btn" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700">
                    确认生成工资单
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 计算依据（快照） -->
                <div>
                    <h4 class="text-md font-semibold text-gray-900 mb-3">计算依据</h4>
                    <div class="bg-gray-50 rounded-lg p-4 space-y-2">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">基本薪资:</span>
                            <span id="preview-base-salary" class="text-sm font-medium text-gray-900">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">薪资类型:</span>
                            <span id="preview-salary-type" class="text-sm font-medium text-gray-900">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">考核等级:</span>
                            <span id="preview-assessment-grade" class="text-sm font-medium text-gray-900">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">社保基数:</span>
                            <span id="preview-social-base" class="text-sm font-medium text-gray-900">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">公积金基数:</span>
                            <span id="preview-housing-base" class="text-sm font-medium text-gray-900">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">专项附加扣除:</span>
                            <span id="preview-tax-deduction-total" class="text-sm font-medium text-gray-900">-</span>
                        </div>
                    </div>
                </div>

                <!-- 计算结果 -->
                <div>
                    <h4 class="text-md font-semibold text-gray-900 mb-3">计算结果</h4>
                    <div class="bg-gray-50 rounded-lg p-4 space-y-2">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">应发金额:</span>
                            <span id="preview-base-amount" class="text-sm font-medium text-indigo-600">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">绩效奖金:</span>
                            <span id="preview-performance-bonus" class="text-sm font-medium text-gray-900">-</span>
                        </div>
                        <div class="flex justify-between border-t pt-2">
                            <span class="text-sm text-gray-600">社保扣除:</span>
                            <span id="preview-social-deduction" class="text-sm font-medium text-red-600">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">公积金扣除:</span>
                            <span id="preview-housing-deduction" class="text-sm font-medium text-red-600">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">个税扣除:</span>
                            <span id="preview-tax-deduction" class="text-sm font-medium text-red-600">-</span>
                        </div>
                        <div class="flex justify-between border-t pt-2">
                            <span class="text-sm font-semibold text-gray-900">实发金额:</span>
                            <span id="preview-total-amount" class="text-lg font-bold text-green-600">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab 2: 工资单列表 -->
    <div id="section-list" class="tab-content hidden">
        <!-- 过滤器区域 -->
        <div id="filter-section" class="mb-6 bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-medium text-gray-700">筛选条件</h3>
                <button id="toggle-filter" class="text-sm text-indigo-600 hover:text-indigo-700">
                    <span id="filter-toggle-text">展开</span>
                    <svg id="filter-toggle-icon" class="inline-block w-4 h-4 ml-1 transform transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
            </div>
            <div id="filter-content" class="hidden">
                <div id="filter-fields" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label for="filter-period" class="block text-sm font-medium text-gray-700 mb-1">工资周期</label>
                        <input type="month" id="filter-period" class="w-full px-3 py-2 border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="filter-company" class="block text-sm font-medium text-gray-700 mb-1">公司</label>
                        <select id="filter-company" class="w-full px-3 py-2 border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">全部</option>
                        </select>
                    </div>
                    <div>
                        <label for="filter-person-name" class="block text-sm font-medium text-gray-700 mb-1">人员姓名</label>
                        <input type="text" id="filter-person-name" placeholder="请输入人员姓名" class="w-full px-3 py-2 border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="filter-status" class="block text-sm font-medium text-gray-700 mb-1">状态</label>
                        <select id="filter-status" class="w-full px-3 py-2 border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">全部</option>
                            <option value="待发放">待发放</option>
                            <option value="已发放">已发放</option>
                            <option value="已取消">已取消</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-4 pt-4 border-t">
                    <button id="reset-filter-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">重置</button>
                    <button id="apply-filter-btn" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">应用筛选</button>
                </div>
            </div>
        </div>

        <!-- 加载状态 -->
        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
            <p class="mt-2 text-sm text-gray-500">加载中...</p>
        </div>

        <!-- 错误提示 -->
        <div id="error" class="hidden bg-red-50 border border-red-200 rounded-md p-4 mb-4">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">加载失败</h3>
                    <p id="error-message" class="mt-2 text-sm text-red-700"></p>
                </div>
            </div>
        </div>

        <!-- 工资单表格 -->
        <div id="payroll-container" class="hidden overflow-x-auto shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
            <table class="min-w-full divide-y divide-gray-300">
                <thead class="bg-gray-50">
                    <tr id="table-header">
                        <!-- 动态生成表头 -->
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 bg-white" id="table-body">
                    <!-- 动态生成表格行 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 工资单详情模态框 -->
    <div id="payroll-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">工资单详情</h3>
                    <button id="close-modal" class="text-gray-400 hover:text-gray-500">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                
                <div id="payroll-detail-content">
                    <!-- 动态生成 -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Schema 定义（从后端传递）
const schema = {{ schema | tojson }};

// 确保字段顺序
ensureFieldOrder(schema);

// 当前计算参数
let currentCalculationParams = null;
let currentCalculationResult = null;

// Tab 切换逻辑
function switchTab(tab) {
    const generateTab = document.getElementById('tab-generate');
    const listTab = document.getElementById('tab-list');
    const sectionGenerate = document.getElementById('section-generate');
    const sectionList = document.getElementById('section-list');

    [generateTab, listTab].forEach(btn => {
        btn.classList.remove('border-indigo-500', 'text-indigo-600');
        btn.classList.add('border-transparent', 'text-gray-500');
    });

    [sectionGenerate, sectionList].forEach(section => {
        section.classList.add('hidden');
    });

    if (tab === 'generate') {
        generateTab.classList.add('border-indigo-500', 'text-indigo-600');
        generateTab.classList.remove('border-transparent', 'text-gray-500');
        sectionGenerate.classList.remove('hidden');
    } else if (tab === 'list') {
        listTab.classList.add('border-indigo-500', 'text-indigo-600');
        listTab.classList.remove('border-transparent', 'text-gray-500');
        sectionList.classList.remove('hidden');
        if (!window.listInitialized) {
            loadCompanies();
            loadPayrollList();
            window.listInitialized = true;
        }
    }
}

document.getElementById('tab-generate').addEventListener('click', () => switchTab('generate'));
document.getElementById('tab-list').addEventListener('click', () => switchTab('list'));

// ========== 生成工资单 Tab ==========

// 加载公司列表
async function loadCompanies() {
    try {
        const response = await fetch('/api/twins/company');
        const result = await response.json();
        if (result.success && result.data) {
            const companySelect = document.getElementById('generate-company');
            const filterCompanySelect = document.getElementById('filter-company');
            
            // 清空并填充选项
            [companySelect, filterCompanySelect].forEach(select => {
                if (select) {
                    const defaultOption = select.querySelector('option[value=""]');
                    select.innerHTML = '';
                    if (defaultOption) {
                        select.appendChild(defaultOption.cloneNode(true));
                    }
                    result.data.forEach(company => {
                        const option = document.createElement('option');
                        option.value = company.id;
                        option.textContent = company.name || `公司 ${company.id}`;
                        select.appendChild(option);
                    });
                }
            });
        }
    } catch (error) {
        console.error('加载公司列表失败:', error);
    }
}

// 根据公司加载人员列表
document.getElementById('generate-company').addEventListener('change', async function() {
    const companyId = this.value;
    const personSelect = document.getElementById('generate-person');
    
    if (!companyId) {
        personSelect.innerHTML = '<option value="">请先选择公司</option>';
        return;
    }

    try {
        const response = await fetch(`/api/twins/person_company_employment?company_id=${companyId}&enrich=person`);
        const result = await response.json();
        
        if (result.success && result.data) {
            personSelect.innerHTML = '<option value="">请选择人员</option>';
            
            // 获取每个人员的最新聘用记录（按 change_date 排序）
            const personMap = new Map();
            result.data.forEach(emp => {
                const personId = emp.person_id;
                if (!personMap.has(personId) || (emp.change_date && (!personMap.get(personId).change_date || emp.change_date > personMap.get(personId).change_date))) {
                    personMap.set(personId, emp);
                }
            });

            personMap.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.person_id;
                option.textContent = emp.person_name || `人员 ${emp.person_id}`;
                personSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('加载人员列表失败:', error);
        personSelect.innerHTML = '<option value="">加载失败</option>';
    }
});

// 计算工资
document.getElementById('calculate-btn').addEventListener('click', async function() {
    const period = document.getElementById('generate-period').value;
    const companyId = document.getElementById('generate-company').value;
    const personId = document.getElementById('generate-person').value;

    if (!period || !companyId || !personId) {
        alert('请填写完整的计算条件（周期、公司、人员）');
        return;
    }

    try {
        const response = await fetch('/api/payroll/calculate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                person_id: parseInt(personId),
                company_id: parseInt(companyId),
                period: period
            })
        });

        const result = await response.json();
        
        if (!result.success) {
            alert('计算失败: ' + result.error);
            return;
        }

        currentCalculationParams = { person_id: parseInt(personId), company_id: parseInt(companyId), period };
        currentCalculationResult = result.data;

        // 显示计算结果
        displayCalculationResult(result.data);
    } catch (error) {
        alert('计算失败: ' + error.message);
    }
});

// 显示计算结果
function displayCalculationResult(data) {
    document.getElementById('preview-base-salary').textContent = formatCurrency(data.base_salary) + (data.salary_type ? ` (${data.salary_type})` : '');
    document.getElementById('preview-salary-type').textContent = data.salary_type || '-';
    document.getElementById('preview-assessment-grade').textContent = data.assessment_grade || '-';
    document.getElementById('preview-social-base').textContent = formatCurrency(data.social_security_base);
    document.getElementById('preview-housing-base').textContent = formatCurrency(data.housing_fund_base);
    document.getElementById('preview-tax-deduction-total').textContent = formatCurrency(data.tax_deduction_total);

    document.getElementById('preview-base-amount').textContent = formatCurrency(data.base_amount);
    document.getElementById('preview-performance-bonus').textContent = formatCurrency(data.performance_bonus || 0);
    document.getElementById('preview-social-deduction').textContent = formatCurrency(data.social_security_deduction || 0);
    document.getElementById('preview-housing-deduction').textContent = formatCurrency(data.housing_fund_deduction || 0);
    document.getElementById('preview-tax-deduction').textContent = formatCurrency(data.tax_deduction || 0);
    document.getElementById('preview-total-amount').textContent = formatCurrency(data.total_amount);

    document.getElementById('calculation-result').classList.remove('hidden');
}

// 生成工资单
document.getElementById('generate-payroll-btn').addEventListener('click', async function() {
    if (!currentCalculationParams || !currentCalculationResult) {
        alert('请先计算工资');
        return;
    }

    if (!confirm('确认生成工资单？')) {
        return;
    }

    try {
        const response = await fetch('/api/payroll/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(currentCalculationParams)
        });

        const result = await response.json();
        
        if (!result.success) {
            alert('生成失败: ' + result.error);
            return;
        }

        alert('工资单生成成功！');
        
        // 清空表单和结果
        document.getElementById('generate-period').value = '';
        document.getElementById('generate-company').value = '';
        document.getElementById('generate-person').value = '';
        document.getElementById('calculation-result').classList.add('hidden');
        currentCalculationParams = null;
        currentCalculationResult = null;

        // 切换到列表 Tab 并刷新
        switchTab('list');
        loadPayrollList();
    } catch (error) {
        alert('生成失败: ' + error.message);
    }
});

// ========== 工资单列表 Tab ==========

let currentFilters = {};

// 切换过滤器可见性
function toggleFilter() {
    const filterContent = document.getElementById('filter-content');
    const toggleText = document.getElementById('filter-toggle-text');
    const toggleIcon = document.getElementById('filter-toggle-icon');
    
    filterContent.classList.toggle('hidden');
    if (filterContent.classList.contains('hidden')) {
        toggleText.textContent = '展开';
        toggleIcon.classList.remove('rotate-180');
    } else {
        toggleText.textContent = '收起';
        toggleIcon.classList.add('rotate-180');
    }
}

document.getElementById('toggle-filter').onclick = toggleFilter;

// 应用筛选
function applyFilters() {
    currentFilters = {};
    const period = document.getElementById('filter-period').value;
    const companyId = document.getElementById('filter-company').value;
    const personName = document.getElementById('filter-person-name').value;
    const status = document.getElementById('filter-status').value;

    if (period) currentFilters.period = period;
    if (companyId) currentFilters.company_id = companyId;
    if (personName) currentFilters.person_name = personName;
    if (status) currentFilters.status = status;

    loadPayrollList(currentFilters);
}

document.getElementById('apply-filter-btn').onclick = applyFilters;

// 重置筛选
function resetFilters() {
    document.getElementById('filter-period').value = '';
    document.getElementById('filter-company').value = '';
    document.getElementById('filter-person-name').value = '';
    document.getElementById('filter-status').value = '';
    currentFilters = {};
    loadPayrollList();
}

document.getElementById('reset-filter-btn').onclick = resetFilters;

// 加载工资单列表
async function loadPayrollList(filters = {}) {
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const container = document.getElementById('payroll-container');
    
    try {
        loading.classList.remove('hidden');
        error.classList.add('hidden');
        container.classList.add('hidden');
        
        let url = '/api/twins/person_company_payroll?enrich=person,company';
        const queryParams = new URLSearchParams();
        for (const key in filters) {
            queryParams.append(key, filters[key]);
        }
        if (queryParams.toString()) {
            url += `&${queryParams.toString()}`;
        }
        
        const response = await fetch(url);
        const result = await response.json();
        
        loading.classList.add('hidden');
        
        if (!result.success) {
            error.classList.remove('hidden');
            document.getElementById('error-message').textContent = result.error || '加载失败';
            return;
        }
        
        error.classList.add('hidden');
        container.classList.remove('hidden');
        
        if (result.data && result.data.length > 0) {
            renderTable(result.data);
        } else {
            container.innerHTML = '<div class="text-center py-12 text-gray-500">暂无数据</div>';
        }
    } catch (err) {
        loading.classList.add('hidden');
        error.classList.remove('hidden');
        document.getElementById('error-message').textContent = err.message || '加载失败，请刷新页面重试';
    }
}

// 渲染表格
function renderTable(records) {
    const headerRow = document.getElementById('table-header');
    const tbody = document.getElementById('table-body');
    
    if (!headerRow || !tbody) return;
    
    headerRow.innerHTML = '';
    tbody.innerHTML = '';
    
    const columns = [
        { key: 'period', label: '工资周期' },
        { key: 'person_name', label: '人员姓名' },
        { key: 'company_name', label: '公司名称' },
        { key: 'base_amount', label: '应发金额' },
        { key: 'total_amount', label: '实发金额' },
        { key: 'status', label: '状态' },
        { key: 'payment_date', label: '发放日期' }
    ];
    
    columns.forEach(col => {
        const th = document.createElement('th');
        th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
        th.textContent = col.label;
        headerRow.appendChild(th);
    });
    
    records.forEach(record => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50 cursor-pointer';
        tr.onclick = () => showPayrollDetail(record.id);
        
        columns.forEach(col => {
            const td = document.createElement('td');
            td.className = 'whitespace-nowrap px-6 py-4 text-sm text-gray-900';
            
            let value = record[col.key];
            if (col.key === 'base_amount' || col.key === 'total_amount') {
                td.textContent = formatCurrency(value);
                if (col.key === 'total_amount') {
                    td.className += ' font-semibold text-green-600';
                }
            } else if (col.key === 'status' && value) {
                const statusColor = value === '已发放' ? 'bg-green-100 text-green-800' : 
                                  value === '待发放' ? 'bg-yellow-100 text-yellow-800' : 
                                  'bg-gray-100 text-gray-800';
                td.innerHTML = `<span class="px-2 py-1 rounded-full text-xs font-medium ${statusColor}">${value}</span>`;
            } else if (col.key === 'payment_date' && value) {
                td.textContent = new Date(value).toLocaleDateString('zh-CN');
            } else {
                td.textContent = value || '-';
            }
            
            tr.appendChild(td);
        });
        
        tbody.appendChild(tr);
    });
}

// 显示工资单详情
async function showPayrollDetail(payrollId) {
    try {
        const response = await fetch(`/api/twins/person_company_payroll/${payrollId}`);
        const result = await response.json();
        
        if (!result.success) {
            alert('加载失败: ' + result.error);
            return;
        }
        
        const data = result.data;
        const modal = document.getElementById('payroll-modal');
        const content = document.getElementById('payroll-detail-content');
        
        let html = '<div class="space-y-6">';
        
        // 当前信息
        html += '<div><h4 class="text-md font-semibold text-gray-900 mb-3">工资单信息</h4>';
        html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-6">';
        
        // 计算依据
        html += '<div class="bg-gray-50 rounded-lg p-4"><h5 class="text-sm font-semibold text-gray-700 mb-2">计算依据</h5><div class="space-y-2">';
        html += `<div class="flex justify-between"><span class="text-sm text-gray-600">基本薪资:</span><span class="text-sm font-medium">${formatCurrency(data.current.base_salary)} ${data.current.salary_type || ''}</span></div>`;
        html += `<div class="flex justify-between"><span class="text-sm text-gray-600">考核等级:</span><span class="text-sm font-medium">${data.current.assessment_grade || '-'}</span></div>`;
        html += `<div class="flex justify-between"><span class="text-sm text-gray-600">社保基数:</span><span class="text-sm font-medium">${formatCurrency(data.current.social_security_base)}</span></div>`;
        html += `<div class="flex justify-between"><span class="text-sm text-gray-600">公积金基数:</span><span class="text-sm font-medium">${formatCurrency(data.current.housing_fund_base)}</span></div>`;
        html += `<div class="flex justify-between"><span class="text-sm text-gray-600">专项附加扣除:</span><span class="text-sm font-medium">${formatCurrency(data.current.tax_deduction_total)}</span></div>`;
        html += '</div></div>';
        
        // 计算结果
        html += '<div class="bg-gray-50 rounded-lg p-4"><h5 class="text-sm font-semibold text-gray-700 mb-2">计算结果</h5><div class="space-y-2">';
        html += `<div class="flex justify-between"><span class="text-sm text-gray-600">应发金额:</span><span class="text-sm font-medium text-indigo-600">${formatCurrency(data.current.base_amount)}</span></div>`;
        html += `<div class="flex justify-between"><span class="text-sm text-gray-600">绩效奖金:</span><span class="text-sm font-medium">${formatCurrency(data.current.performance_bonus || 0)}</span></div>`;
        html += `<div class="flex justify-between border-t pt-2"><span class="text-sm text-gray-600">社保扣除:</span><span class="text-sm font-medium text-red-600">${formatCurrency(data.current.social_security_deduction || 0)}</span></div>`;
        html += `<div class="flex justify-between"><span class="text-sm text-gray-600">公积金扣除:</span><span class="text-sm font-medium text-red-600">${formatCurrency(data.current.housing_fund_deduction || 0)}</span></div>`;
        html += `<div class="flex justify-between"><span class="text-sm text-gray-600">个税扣除:</span><span class="text-sm font-medium text-red-600">${formatCurrency(data.current.tax_deduction || 0)}</span></div>`;
        html += `<div class="flex justify-between border-t pt-2"><span class="text-sm font-semibold">实发金额:</span><span class="text-lg font-bold text-green-600">${formatCurrency(data.current.total_amount)}</span></div>`;
        html += '</div></div>';
        
        html += '</div></div>';
        
        // 状态信息
        html += '<div><h4 class="text-md font-semibold text-gray-900 mb-3">状态信息</h4>';
        html += '<div class="bg-gray-50 rounded-lg p-4 space-y-2">';
        html += `<div class="flex justify-between"><span class="text-sm text-gray-600">工资周期:</span><span class="text-sm font-medium">${data.current.period}</span></div>`;
        html += `<div class="flex justify-between"><span class="text-sm text-gray-600">状态:</span><span class="text-sm font-medium">${data.current.status || '待发放'}</span></div>`;
        if (data.current.payment_date) {
            html += `<div class="flex justify-between"><span class="text-sm text-gray-600">发放日期:</span><span class="text-sm font-medium">${new Date(data.current.payment_date).toLocaleDateString('zh-CN')}</span></div>`;
        }
        if (data.current.remarks) {
            html += `<div class="flex justify-between"><span class="text-sm text-gray-600">备注:</span><span class="text-sm font-medium">${data.current.remarks}</span></div>`;
        }
        html += '</div></div>';
        
        html += '</div>';
        
        content.innerHTML = html;
        modal.classList.remove('hidden');
    } catch (error) {
        alert('加载失败: ' + error.message);
    }
}

// 关闭模态框
document.getElementById('close-modal').onclick = () => {
    document.getElementById('payroll-modal').classList.add('hidden');
};

// 格式化货币
function formatCurrency(value) {
    if (value === null || value === undefined || value === '') return '-';
    const num = parseFloat(value);
    if (isNaN(num)) return '-';
    return `¥${num.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
}

// 初始化
window.addEventListener('DOMContentLoaded', () => {
    // 设置默认周期为当前月份
    const now = new Date();
    const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    document.getElementById('generate-period').value = currentMonth;
    
    loadCompanies();
    switchTab('generate');
});
</script>
{% endblock %}
