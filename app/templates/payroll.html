{% extends "base.html" %}

{% block title %}工资管理 - HRMS{% endblock %}

{% block extra_head %}
<script src="/static/js/schema-utils.js"></script>
{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-900">工资管理</h2>
        <p class="mt-1 text-sm text-gray-500">计算并生成工资单，查看历史工资记录</p>
    </div>

    <!-- Tab 导航 -->
    <div class="border-b border-gray-200 mb-6">
        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
            <button id="tab-generate" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600">
                生成工资单
            </button>
            <button id="tab-list" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                工资单列表
            </button>
        </nav>
    </div>

    <!-- Tab 1: 生成工资单 -->
    <div id="section-generate" class="tab-content">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">选择计算条件</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label for="generate-period" class="block text-sm font-medium text-gray-700 mb-1">工资周期</label>
                    <input type="month" id="generate-period" class="w-full px-3 py-2 border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="generate-company" class="block text-sm font-medium text-gray-700 mb-1">公司</label>
                    <select id="generate-company" class="w-full px-3 py-2 border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">请选择公司</option>
                    </select>
                </div>
                <div>
                    <label for="generate-person" class="block text-sm font-medium text-gray-700 mb-1">人员</label>
                    <select id="generate-person" class="w-full px-3 py-2 border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">请先选择公司</option>
                    </select>
                </div>
            </div>

            <div class="flex justify-end gap-3">
                <button id="calculate-btn" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">
                    计算工资
                </button>
            </div>
        </div>

        <!-- 公式试算（可选） -->
        <div class="mt-6 bg-white rounded-lg shadow-sm border border-dashed border-indigo-300 p-6">
            <div class="flex items-center justify-between mb-3">
                <div>
                    <h3 class="text-md font-semibold text-gray-900">公式试算（临时）</h3>
                    <p class="mt-1 text-xs text-gray-500">
                        从左侧拖动或点击变量（中文名称），右侧编辑公式（使用变量名），基于当前选择的人员与周期进行一次性试算，不会写入工资单。
                    </p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- 变量列表 -->
                <div class="md:col-span-1">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">可用变量</h4>
                    <div id="formula-variable-list" class="max-h-72 overflow-y-auto space-y-2 border border-gray-200 rounded-md p-2 bg-gray-50 text-xs text-gray-700">
                        <div class="text-gray-400 text-xs">加载中...</div>
                    </div>
                </div>

                <!-- 公式编辑与结果 -->
                <div class="md:col-span-2 flex flex-col gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            应发薪资计算公式（中文变量 Token）
                        </label>
                        <div id="formula-editor" contenteditable="true" class="w-full min-h-[100px] px-3 py-2 border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400">
                        </div>
                        <input type="hidden" id="formula-expression">
                        <p class="mt-1 text-xs text-gray-400">
                            在此区域编辑应发公式：可输入数字、+ - * / 和括号，点击左侧变量插入<strong>中文变量 Token</strong>，系统会映射到内部变量名并计算。
                        </p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            社保公积金扣除计算公式（中文变量 Token）
                        </label>
                        <div id="deduction-formula-editor" contenteditable="true" class="w-full min-h-[100px] px-3 py-2 border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400">
                        </div>
                        <input type="hidden" id="deduction-formula-expression">
                        <p class="mt-1 text-xs text-gray-400">
                            在此区域编辑社保、公积金等扣除的合计表达式，同样使用左侧变量与函数。
                        </p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            个税扣除计算公式（中文变量 Token）
                        </label>
                        <div id="tax-formula-editor" contenteditable="true" class="w-full min-h-[100px] px-3 py-2 border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400">
                        </div>
                        <input type="hidden" id="tax-formula-expression">
                        <p class="mt-1 text-xs text-gray-400">
                            在此区域编辑个人所得税扣除的表达式，同样使用左侧变量与函数。
                        </p>
                        <div class="mt-2">
                            <button id="formula-save-btn" class="inline-flex items-center px-3 py-1.5 border border-green-600 text-xs font-medium rounded-md text-green-600 bg-white hover:bg-green-50">
                                保存公式
                            </button>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-xs font-medium text-gray-700 mb-1">可用函数</h4>
                        <div class="flex flex-wrap gap-2 items-center">
                            <button type="button" id="fn-grade-coef" class="px-2 py-0.5 bg-white border border-gray-300 rounded-full text-[11px] text-gray-700 hover:bg-indigo-50 hover:border-indigo-400" title="将绩效等级（A-E）转换为系数：A=1.2, B=1.0, C=0.8, D=0.6, E=0.4">
                                绩效等级系数：grade_coef(等级)
                            </button>
                            <button type="button" id="fn-prorate" class="px-2 py-0.5 bg-white border border-gray-300 rounded-full text-[11px] text-gray-700 hover:bg-indigo-50 hover:border-indigo-400" title="对薪资进行折算（用于中途入职或中途转正等情况）：prorate(薪资)">
                                薪资折算：prorate(薪资)
                            </button>
                            <button type="button" id="fn-position-base-coef" class="px-2 py-0.5 bg-white border border-gray-300 rounded-full text-[11px] text-gray-700 hover:bg-indigo-50 hover:border-indigo-400" title="根据岗位返回基础薪资系数：position_base_coef(岗位)">
                                岗位基础薪资系数：position_base_coef(岗位)
                            </button>
                            <button type="button" id="fn-position-perf-coef" class="px-2 py-0.5 bg-white border border-gray-300 rounded-full text-[11px] text-gray-700 hover:bg-indigo-50 hover:border-indigo-400" title="根据岗位返回绩效薪资系数：position_perf_coef(岗位)">
                                岗位绩效薪资系数：position_perf_coef(岗位)
                            </button>
                            <span class="text-[11px] text-gray-400 self-center">例如：基本薪资 × grade_coef(人员考核活动.考核等级) 或 prorate(基本薪资)</span>
                        </div>
                    </div>

                    <div class="flex items-center justify-between mt-1">
                        <button id="formula-eval-btn" class="inline-flex items-center px-3 py-1.5 border border-indigo-600 text-xs font-medium rounded-md text-indigo-600 bg-white hover:bg-indigo-50">
                            试算当前工资
                        </button>
                        <div class="text-xs text-gray-500">
                            试算结果：
                            <span id="formula-result-value" class="font-semibold text-indigo-600">-</span>
                            <span id="formula-result-error" class="ml-2 text-red-500 hidden"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 计算结果预览 -->
        <div id="calculation-result" class="hidden mt-6 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">计算结果预览</h3>
                <button id="generate-payroll-btn" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700">
                    确认生成工资单
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 计算依据（快照） -->
                <div>
                    <h4 class="text-md font-semibold text-gray-900 mb-3">计算依据</h4>
                    <div class="bg-gray-50 rounded-lg p-4 space-y-2">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">基本薪资:</span>
                            <span id="preview-base-salary" class="text-sm font-medium text-gray-900">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">薪资类型:</span>
                            <span id="preview-salary-type" class="text-sm font-medium text-gray-900">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">考核等级:</span>
                            <span id="preview-assessment-grade" class="text-sm font-medium text-gray-900">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">社保基数:</span>
                            <span id="preview-social-base" class="text-sm font-medium text-gray-900">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">公积金基数:</span>
                            <span id="preview-housing-base" class="text-sm font-medium text-gray-900">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">专项附加扣除:</span>
                            <span id="preview-tax-deduction-total" class="text-sm font-medium text-gray-900">-</span>
                        </div>
                    </div>
                </div>

                <!-- 计算结果 -->
                <div>
                    <h4 class="text-md font-semibold text-gray-900 mb-3">计算结果</h4>
                    <div class="bg-gray-50 rounded-lg p-4 space-y-2">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">应发金额:</span>
                            <span id="preview-base-amount" class="text-sm font-medium text-indigo-600">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">绩效奖金:</span>
                            <span id="preview-performance-bonus" class="text-sm font-medium text-gray-900">-</span>
                        </div>
                        <div class="flex justify-between border-t pt-2">
                            <span class="text-sm text-gray-600">社保扣除:</span>
                            <span id="preview-social-deduction" class="text-sm font-medium text-red-600">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">公积金扣除:</span>
                            <span id="preview-housing-deduction" class="text-sm font-medium text-red-600">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">个税扣除:</span>
                            <span id="preview-tax-deduction" class="text-sm font-medium text-red-600">-</span>
                        </div>
                        <div class="flex justify-between border-t pt-2">
                            <span class="text-sm font-semibold text-gray-900">实发金额:</span>
                            <span id="preview-total-amount" class="text-lg font-bold text-green-600">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab 2: 工资单列表 -->
    <div id="section-list" class="tab-content hidden">
        <!-- 过滤器区域 -->
        <div id="filter-section" class="mb-6 bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-medium text-gray-700">筛选条件</h3>
                <button id="toggle-filter" class="text-sm text-indigo-600 hover:text-indigo-700">
                    <span id="filter-toggle-text">展开</span>
                    <svg id="filter-toggle-icon" class="inline-block w-4 h-4 ml-1 transform transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
            </div>
            <div id="filter-content" class="hidden">
                <div id="filter-fields" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label for="filter-period" class="block text-sm font-medium text-gray-700 mb-1">工资周期</label>
                        <input type="month" id="filter-period" class="w-full px-3 py-2 border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="filter-company" class="block text-sm font-medium text-gray-700 mb-1">公司</label>
                        <select id="filter-company" class="w-full px-3 py-2 border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">全部</option>
                        </select>
                    </div>
                    <div>
                        <label for="filter-person-name" class="block text-sm font-medium text-gray-700 mb-1">人员姓名</label>
                        <input type="text" id="filter-person-name" placeholder="请输入人员姓名" class="w-full px-3 py-2 border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="filter-status" class="block text-sm font-medium text-gray-700 mb-1">状态</label>
                        <select id="filter-status" class="w-full px-3 py-2 border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">全部</option>
                            <option value="待发放">待发放</option>
                            <option value="已发放">已发放</option>
                            <option value="已取消">已取消</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-4 pt-4 border-t">
                    <button id="reset-filter-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">重置</button>
                    <button id="apply-filter-btn" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">应用筛选</button>
                </div>
            </div>
        </div>

        <!-- 加载状态 -->
        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
            <p class="mt-2 text-sm text-gray-500">加载中...</p>
        </div>

        <!-- 错误提示 -->
        <div id="error" class="hidden bg-red-50 border border-red-200 rounded-md p-4 mb-4">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">加载失败</h3>
                    <p id="error-message" class="mt-2 text-sm text-red-700"></p>
                </div>
            </div>
        </div>

        <!-- 工资单表格 -->
        <div id="payroll-container" class="hidden overflow-x-auto shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
            <table class="min-w-full divide-y divide-gray-300">
                <thead class="bg-gray-50">
                    <tr id="table-header">
                        <!-- 动态生成表头 -->
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 bg-white" id="table-body">
                    <!-- 动态生成表格行 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 工资单详情模态框 -->
    <div id="payroll-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">工资单详情</h3>
                    <button id="close-modal" class="text-gray-400 hover:text-gray-500">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                
                <div id="payroll-detail-content">
                    <!-- 动态生成 -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 当前计算参数
let currentCalculationParams = null;
let currentCalculationResult = null;
let formulaVariablesLoaded = false;

// Tab 切换逻辑
function switchTab(tab) {
    const generateTab = document.getElementById('tab-generate');
    const listTab = document.getElementById('tab-list');
    const sectionGenerate = document.getElementById('section-generate');
    const sectionList = document.getElementById('section-list');

    [generateTab, listTab].forEach(btn => {
        btn.classList.remove('border-indigo-500', 'text-indigo-600');
        btn.classList.add('border-transparent', 'text-gray-500');
    });

    [sectionGenerate, sectionList].forEach(section => {
        section.classList.add('hidden');
    });

    if (tab === 'generate') {
        generateTab.classList.add('border-indigo-500', 'text-indigo-600');
        generateTab.classList.remove('border-transparent', 'text-gray-500');
        sectionGenerate.classList.remove('hidden');
    } else if (tab === 'list') {
        listTab.classList.add('border-indigo-500', 'text-indigo-600');
        listTab.classList.remove('border-transparent', 'text-gray-500');
        sectionList.classList.remove('hidden');
        if (!window.listInitialized) {
            loadCompanies();
            loadPayrollList();
            window.listInitialized = true;
        }
    }
}

document.getElementById('tab-generate').addEventListener('click', () => switchTab('generate'));
document.getElementById('tab-list').addEventListener('click', () => switchTab('list'));

// ========== 生成工资单 Tab ==========

// 加载公式变量列表
async function loadFormulaVariables() {
    if (formulaVariablesLoaded) return;
    const container = document.getElementById('formula-variable-list');
    if (!container) return;

    try {
        const response = await fetch('/api/schema/variables');
        const result = await response.json();
        container.innerHTML = '';

        if (!result.success || !result.data || result.data.length === 0) {
            container.innerHTML = '<div class="text-gray-400 text-xs">暂无可用变量</div>';
            return;
        }

        result.data.forEach(group => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'mb-2';

            const title = document.createElement('div');
            title.className = 'text-xs font-semibold text-gray-700 mb-1';
            title.textContent = group.twin_label || group.twin;
            groupDiv.appendChild(title);

            const fieldList = document.createElement('div');
            fieldList.className = 'flex flex-wrap gap-1';

            (group.fields || []).forEach(field => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'px-2 py-0.5 bg-white border border-gray-300 rounded-full text-[11px] text-gray-700 hover:bg-indigo-50 hover:border-indigo-400';
                btn.textContent = field.full_label || field.label || field.key;
                btn.title = `变量名: ${field.key}`;
                btn.dataset.variableKey = field.key;
                btn.dataset.evalKey = field.eval_key || field.key;
                btn.onclick = () => insertVariableIntoFormula(field.full_label || field.label || field.key, field.eval_key || field.key);
                fieldList.appendChild(btn);
            });

            groupDiv.appendChild(fieldList);
            container.appendChild(groupDiv);
        });

        formulaVariablesLoaded = true;
    } catch (error) {
        console.error('加载公式变量失败:', error);
        container.innerHTML = '<div class="text-red-500 text-xs">加载变量失败，请刷新页面重试</div>';
    }
}

// 记录最后获得焦点的公式编辑器（点击变量时焦点在按钮上，用此判断插入到哪个编辑框）
let lastFocusedFormulaEditor = null;
function getActiveFormulaEditor() {
    const gross = document.getElementById('formula-editor');
    const deduction = document.getElementById('deduction-formula-editor');
    const tax = document.getElementById('tax-formula-editor');
    const active = document.activeElement;
    if (active === gross || active === deduction || active === tax) return active;
    return lastFocusedFormulaEditor || gross || deduction || tax;
}
function initFormulaEditorFocusTracking() {
    const gross = document.getElementById('formula-editor');
    const deduction = document.getElementById('deduction-formula-editor');
    const tax = document.getElementById('tax-formula-editor');
    if (gross) gross.addEventListener('focus', () => { lastFocusedFormulaEditor = gross; });
    if (deduction) deduction.addEventListener('focus', () => { lastFocusedFormulaEditor = deduction; });
    if (tax) tax.addEventListener('focus', () => { lastFocusedFormulaEditor = tax; });
}

// 将变量 Token 插入到公式编辑器中（不可拆分的中文 Token）
function insertVariableIntoFormula(displayLabel, evalKey) {
    const editor = getActiveFormulaEditor();
    if (!editor) return;
    editor.focus();

    const token = document.createElement('span');
    token.className = 'inline-flex items-center px-1.5 py-0.5 mx-[1px] my-[1px] rounded bg-indigo-50 border border-indigo-300 text-[11px] text-indigo-700 align-middle';
    token.textContent = displayLabel;
    token.setAttribute('data-eval-key', evalKey);
    token.setAttribute('contenteditable', 'false');

    const space = document.createTextNode(' ');

    const selection = window.getSelection();
    if (selection && selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        if (editor.contains(range.startContainer)) {
            range.deleteContents();
            range.insertNode(space);
            range.insertNode(token);
            range.setStartAfter(space);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
            return;
        }
    }

    // 如果没有有效的光标位置，则追加到末尾
    editor.appendChild(token);
    editor.appendChild(space);
}

// 加载公司列表
async function loadCompanies() {
    try {
        const response = await fetch('/api/twins/company');
        const result = await response.json();
        if (result.success && result.data) {
            const companySelect = document.getElementById('generate-company');
            const filterCompanySelect = document.getElementById('filter-company');
            
            // 清空并填充选项
            [companySelect, filterCompanySelect].forEach(select => {
                if (select) {
                    const defaultOption = select.querySelector('option[value=""]');
                    select.innerHTML = '';
                    if (defaultOption) {
                        select.appendChild(defaultOption.cloneNode(true));
                    }
                    result.data.forEach(company => {
                        const option = document.createElement('option');
                        option.value = company.id;
                        option.textContent = company.name || `公司 ${company.id}`;
                        select.appendChild(option);
                    });
                }
            });
        }
    } catch (error) {
        console.error('加载公司列表失败:', error);
    }
}

// 根据公司加载人员列表
document.getElementById('generate-company').addEventListener('change', async function() {
    const companyId = this.value;
    const personSelect = document.getElementById('generate-person');
    
    if (!companyId) {
        personSelect.innerHTML = '<option value="">请先选择公司</option>';
        return;
    }

    try {
        const response = await fetch(`/api/twins/person_company_employment?company_id=${companyId}&enrich=person`);
        const result = await response.json();
        
        if (result.success && result.data) {
            personSelect.innerHTML = '<option value="">请选择人员</option>';
            
            // 获取每个人员的最新聘用记录（按 change_date 排序）
            const personMap = new Map();
            result.data.forEach(emp => {
                const personId = emp.person_id;
                if (!personMap.has(personId) || (emp.change_date && (!personMap.get(personId).change_date || emp.change_date > personMap.get(personId).change_date))) {
                    personMap.set(personId, emp);
                }
            });

            personMap.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.person_id;
                option.textContent = emp.person_name || `人员 ${emp.person_id}`;
                personSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('加载人员列表失败:', error);
        personSelect.innerHTML = '<option value="">加载失败</option>';
    }
});

// 计算工资
document.getElementById('calculate-btn').addEventListener('click', async function() {
    const period = document.getElementById('generate-period').value;
    const companyId = document.getElementById('generate-company').value;
    const personId = document.getElementById('generate-person').value;

    if (!period || !companyId || !personId) {
        alert('请填写完整的计算条件（周期、公司、人员）');
        return;
    }

    try {
        const response = await fetch('/api/payroll/calculate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                person_id: parseInt(personId),
                company_id: parseInt(companyId),
                period: period
            })
        });

        const result = await response.json();
        
        if (!result.success) {
            alert('计算失败: ' + result.error);
            return;
        }

        currentCalculationParams = { person_id: parseInt(personId), company_id: parseInt(companyId), period };
        currentCalculationResult = result.data;

        // 显示计算结果
        displayCalculationResult(result.data);
    } catch (error) {
        alert('计算失败: ' + error.message);
    }
});

// 显示计算结果
function displayCalculationResult(data) {
    document.getElementById('preview-base-salary').textContent = formatCurrency(data.base_salary) + (data.salary_type ? ` (${data.salary_type})` : '');
    document.getElementById('preview-salary-type').textContent = data.salary_type || '-';
    document.getElementById('preview-assessment-grade').textContent = data.assessment_grade || '-';
    document.getElementById('preview-social-base').textContent = formatCurrency(data.social_security_base);
    document.getElementById('preview-housing-base').textContent = formatCurrency(data.housing_fund_base);
    document.getElementById('preview-tax-deduction-total').textContent = formatCurrency(data.tax_deduction_total);

    document.getElementById('preview-base-amount').textContent = formatCurrency(data.base_amount);
    document.getElementById('preview-performance-bonus').textContent = formatCurrency(data.performance_bonus || 0);
    document.getElementById('preview-social-deduction').textContent = formatCurrency(data.social_security_deduction || 0);
    document.getElementById('preview-housing-deduction').textContent = formatCurrency(data.housing_fund_deduction || 0);
    document.getElementById('preview-tax-deduction').textContent = formatCurrency(data.tax_deduction || 0);
    document.getElementById('preview-total-amount').textContent = formatCurrency(data.total_amount);

    document.getElementById('calculation-result').classList.remove('hidden');
}

// 生成工资单
document.getElementById('generate-payroll-btn').addEventListener('click', async function() {
    if (!currentCalculationParams || !currentCalculationResult) {
        alert('请先计算工资');
        return;
    }

    if (!confirm('确认生成工资单？')) {
        return;
    }

    try {
        const response = await fetch('/api/payroll/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(currentCalculationParams)
        });

        const result = await response.json();
        
        if (!result.success) {
            alert('生成失败: ' + result.error);
            return;
        }

        alert('工资单生成成功！');
        
        // 清空表单和结果
        document.getElementById('generate-period').value = '';
        document.getElementById('generate-company').value = '';
        document.getElementById('generate-person').value = '';
        document.getElementById('calculation-result').classList.add('hidden');
        currentCalculationParams = null;
        currentCalculationResult = null;

        // 切换到列表 Tab 并刷新
        switchTab('list');
        loadPayrollList();
    } catch (error) {
        alert('生成失败: ' + error.message);
    }
});

// ========== 工资单列表 Tab ==========

let currentFilters = {};

// 切换过滤器可见性
function toggleFilter() {
    const filterContent = document.getElementById('filter-content');
    const toggleText = document.getElementById('filter-toggle-text');
    const toggleIcon = document.getElementById('filter-toggle-icon');
    
    filterContent.classList.toggle('hidden');
    if (filterContent.classList.contains('hidden')) {
        toggleText.textContent = '展开';
        toggleIcon.classList.remove('rotate-180');
    } else {
        toggleText.textContent = '收起';
        toggleIcon.classList.add('rotate-180');
    }
}

document.getElementById('toggle-filter').onclick = toggleFilter;

// 应用筛选
function applyFilters() {
    currentFilters = {};
    const period = document.getElementById('filter-period').value;
    const companyId = document.getElementById('filter-company').value;
    const personName = document.getElementById('filter-person-name').value;
    const status = document.getElementById('filter-status').value;

    if (period) currentFilters.period = period;
    if (companyId) currentFilters.company_id = companyId;
    if (personName) currentFilters.person_name = personName;
    if (status) currentFilters.status = status;

    loadPayrollList(currentFilters);
}

document.getElementById('apply-filter-btn').onclick = applyFilters;

// 重置筛选
function resetFilters() {
    document.getElementById('filter-period').value = '';
    document.getElementById('filter-company').value = '';
    document.getElementById('filter-person-name').value = '';
    document.getElementById('filter-status').value = '';
    currentFilters = {};
    loadPayrollList();
}

document.getElementById('reset-filter-btn').onclick = resetFilters;

// 加载工资单列表
async function loadPayrollList(filters = {}) {
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const container = document.getElementById('payroll-container');
    
    try {
        loading.classList.remove('hidden');
        error.classList.add('hidden');
        container.classList.add('hidden');
        
        let url = '/api/twins/person_company_payroll?enrich=person,company';
        const queryParams = new URLSearchParams();
        for (const key in filters) {
            queryParams.append(key, filters[key]);
        }
        if (queryParams.toString()) {
            url += `&${queryParams.toString()}`;
        }
        
        const response = await fetch(url);
        const result = await response.json();
        
        loading.classList.add('hidden');
        
        if (!result.success) {
            error.classList.remove('hidden');
            document.getElementById('error-message').textContent = result.error || '加载失败';
            return;
        }
        
        error.classList.add('hidden');
        container.classList.remove('hidden');
        
        if (result.data && result.data.length > 0) {
            renderTable(result.data);
        } else {
            container.innerHTML = '<div class="text-center py-12 text-gray-500">暂无数据</div>';
        }
    } catch (err) {
        loading.classList.add('hidden');
        error.classList.remove('hidden');
        document.getElementById('error-message').textContent = err.message || '加载失败，请刷新页面重试';
    }
}

// 渲染表格
function renderTable(records) {
    const headerRow = document.getElementById('table-header');
    const tbody = document.getElementById('table-body');
    
    if (!headerRow || !tbody) return;
    
    headerRow.innerHTML = '';
    tbody.innerHTML = '';
    
    const columns = [
        { key: 'period', label: '工资周期' },
        { key: 'person_name', label: '人员姓名' },
        { key: 'company_name', label: '公司名称' },
        { key: 'base_amount', label: '应发金额' },
        { key: 'total_amount', label: '实发金额' },
        { key: 'status', label: '状态' },
        { key: 'payment_date', label: '发放日期' }
    ];
    
    columns.forEach(col => {
        const th = document.createElement('th');
        th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
        th.textContent = col.label;
        headerRow.appendChild(th);
    });
    
    records.forEach(record => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50 cursor-pointer';
        tr.onclick = () => showPayrollDetail(record.id);
        
        columns.forEach(col => {
            const td = document.createElement('td');
            td.className = 'whitespace-nowrap px-6 py-4 text-sm text-gray-900';
            
            let value = record[col.key];
            if (col.key === 'base_amount' || col.key === 'total_amount') {
                td.textContent = formatCurrency(value);
                if (col.key === 'total_amount') {
                    td.className += ' font-semibold text-green-600';
                }
            } else if (col.key === 'status' && value) {
                const statusColor = value === '已发放' ? 'bg-green-100 text-green-800' : 
                                  value === '待发放' ? 'bg-yellow-100 text-yellow-800' : 
                                  'bg-gray-100 text-gray-800';
                td.innerHTML = `<span class="px-2 py-1 rounded-full text-xs font-medium ${statusColor}">${value}</span>`;
            } else if (col.key === 'payment_date' && value) {
                td.textContent = new Date(value).toLocaleDateString('zh-CN');
            } else {
                td.textContent = value || '-';
            }
            
            tr.appendChild(td);
        });
        
        tbody.appendChild(tr);
    });
}

// 显示工资单详情
async function showPayrollDetail(payrollId) {
    try {
        const response = await fetch(`/api/twins/person_company_payroll/${payrollId}`);
        const result = await response.json();
        
        if (!result.success) {
            alert('加载失败: ' + result.error);
            return;
        }
        
        const data = result.data;
        const modal = document.getElementById('payroll-modal');
        const content = document.getElementById('payroll-detail-content');
        
        let html = '<div class="space-y-6">';
        
        // 当前信息
        html += '<div><h4 class="text-md font-semibold text-gray-900 mb-3">工资单信息</h4>';
        html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-6">';
        
        // 计算依据
        html += '<div class="bg-gray-50 rounded-lg p-4"><h5 class="text-sm font-semibold text-gray-700 mb-2">计算依据</h5><div class="space-y-2">';
        html += `<div class="flex justify-between"><span class="text-sm text-gray-600">基本薪资:</span><span class="text-sm font-medium">${formatCurrency(data.current.base_salary)} ${data.current.salary_type || ''}</span></div>`;
        html += `<div class="flex justify-between"><span class="text-sm text-gray-600">考核等级:</span><span class="text-sm font-medium">${data.current.assessment_grade || '-'}</span></div>`;
        html += `<div class="flex justify-between"><span class="text-sm text-gray-600">社保基数:</span><span class="text-sm font-medium">${formatCurrency(data.current.social_security_base)}</span></div>`;
        html += `<div class="flex justify-between"><span class="text-sm text-gray-600">公积金基数:</span><span class="text-sm font-medium">${formatCurrency(data.current.housing_fund_base)}</span></div>`;
        html += `<div class="flex justify-between"><span class="text-sm text-gray-600">专项附加扣除:</span><span class="text-sm font-medium">${formatCurrency(data.current.tax_deduction_total)}</span></div>`;
        html += '</div></div>';
        
        // 计算结果
        html += '<div class="bg-gray-50 rounded-lg p-4"><h5 class="text-sm font-semibold text-gray-700 mb-2">计算结果</h5><div class="space-y-2">';
        html += `<div class="flex justify-between"><span class="text-sm text-gray-600">应发金额:</span><span class="text-sm font-medium text-indigo-600">${formatCurrency(data.current.base_amount)}</span></div>`;
        html += `<div class="flex justify-between"><span class="text-sm text-gray-600">绩效奖金:</span><span class="text-sm font-medium">${formatCurrency(data.current.performance_bonus || 0)}</span></div>`;
        html += `<div class="flex justify-between border-t pt-2"><span class="text-sm text-gray-600">社保扣除:</span><span class="text-sm font-medium text-red-600">${formatCurrency(data.current.social_security_deduction || 0)}</span></div>`;
        html += `<div class="flex justify-between"><span class="text-sm text-gray-600">公积金扣除:</span><span class="text-sm font-medium text-red-600">${formatCurrency(data.current.housing_fund_deduction || 0)}</span></div>`;
        html += `<div class="flex justify-between"><span class="text-sm text-gray-600">个税扣除:</span><span class="text-sm font-medium text-red-600">${formatCurrency(data.current.tax_deduction || 0)}</span></div>`;
        html += `<div class="flex justify-between border-t pt-2"><span class="text-sm font-semibold">实发金额:</span><span class="text-lg font-bold text-green-600">${formatCurrency(data.current.total_amount)}</span></div>`;
        html += '</div></div>';
        
        html += '</div></div>';
        
        // 状态信息
        html += '<div><h4 class="text-md font-semibold text-gray-900 mb-3">状态信息</h4>';
        html += '<div class="bg-gray-50 rounded-lg p-4 space-y-2">';
        html += `<div class="flex justify-between"><span class="text-sm text-gray-600">工资周期:</span><span class="text-sm font-medium">${data.current.period}</span></div>`;
        html += `<div class="flex justify-between"><span class="text-sm text-gray-600">状态:</span><span class="text-sm font-medium">${data.current.status || '待发放'}</span></div>`;
        if (data.current.payment_date) {
            html += `<div class="flex justify-between"><span class="text-sm text-gray-600">发放日期:</span><span class="text-sm font-medium">${new Date(data.current.payment_date).toLocaleDateString('zh-CN')}</span></div>`;
        }
        if (data.current.remarks) {
            html += `<div class="flex justify-between"><span class="text-sm text-gray-600">备注:</span><span class="text-sm font-medium">${data.current.remarks}</span></div>`;
        }
        html += '</div></div>';
        
        html += '</div>';
        
        content.innerHTML = html;
        modal.classList.remove('hidden');
    } catch (error) {
        alert('加载失败: ' + error.message);
    }
}

// 关闭模态框
document.getElementById('close-modal').onclick = () => {
    document.getElementById('payroll-modal').classList.add('hidden');
};

// 格式化货币
function formatCurrency(value) {
    if (value === null || value === undefined || value === '') return '-';
    const num = parseFloat(value);
    if (isNaN(num)) return '-';
    return `¥${num.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
}

// 初始化
window.addEventListener('DOMContentLoaded', () => {
    // 设置默认周期为当前月份
    const now = new Date();
    const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    document.getElementById('generate-period').value = currentMonth;
    
    loadCompanies();
    loadFormulaVariables();
    initFormulaEditorFocusTracking();
    switchTab('generate');
    // 预置示例公式
    setupInitialFormula();
    // 加载保存的公式
    loadSavedFormula();
});

// 从公式编辑器构建表达式字符串（将 Token 替换为 eval_key）
function buildExpressionFromEditor() {
    const editor = document.getElementById('formula-editor');
    if (!editor) return '';
    
    let expression = '';
    
    function walk(node) {
        if (node.nodeType === Node.TEXT_NODE) {
            expression += node.textContent;
            return;
        }
        if (node.nodeType === Node.ELEMENT_NODE) {
            const el = node;
            const evalKey = el.getAttribute && el.getAttribute('data-eval-key');
            if (evalKey) {
                expression += evalKey;
                return;
            }
            const children = el.childNodes;
            for (let i = 0; i < children.length; i++) {
                walk(children[i]);
            }
        }
    }
    
    walk(editor);
    return expression.trim();
}

// 预置一个示例公式到编辑器中（仅在编辑器为空时）
function setupInitialFormula() {
    // 不再初始化公式，保持空白
    const editor = document.getElementById('formula-editor');
    if (!editor) return;
    // 确保编辑器为空
    editor.innerHTML = '';
}

// 在公式编辑器插入函数模板（如 grade_coef()）
function insertFunctionIntoEditor(template) {
    const editor = getActiveFormulaEditor();
    if (!editor) return;
    editor.focus();

    const selection = window.getSelection();
    const textNode = document.createTextNode(template);

    if (selection && selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        if (editor.contains(range.startContainer)) {
            range.deleteContents();
            range.insertNode(textNode);
            // 将光标放在插入文本的括号中间
            const pos = template.indexOf('(') + 1;
            const newRange = document.createRange();
            newRange.setStart(textNode, pos > 0 ? pos : textNode.length);
            newRange.collapse(true);
            selection.removeAllRanges();
            selection.addRange(newRange);
            return;
        }
    }

    editor.appendChild(textNode);
}

// 公式试算按钮
const formulaEvalBtn = document.getElementById('formula-eval-btn');
if (formulaEvalBtn) {
    formulaEvalBtn.addEventListener('click', async () => {
        const exprHidden = document.getElementById('formula-expression');
        const errorEl = document.getElementById('formula-result-error');
        const valueEl = document.getElementById('formula-result-value');

        if (!exprHidden || !errorEl || !valueEl) return;

        errorEl.classList.add('hidden');
        errorEl.textContent = '';

        const expression = buildExpressionFromEditor();
        exprHidden.value = expression;

        if (!expression) {
            errorEl.textContent = '请先输入公式（插入变量并添加运算符）';
            errorEl.classList.remove('hidden');
            return;
        }

        if (!currentCalculationParams) {
            errorEl.textContent = '请先选择周期、公司、人员并点击“计算工资”，再进行公式试算。';
            errorEl.classList.remove('hidden');
            return;
        }

        try {
            const response = await fetch('/api/payroll/eval-formula', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ...currentCalculationParams,
                    expression
                })
            });
            const result = await response.json();
            if (!result.success) {
                errorEl.textContent = result.error || '试算失败';
                errorEl.classList.remove('hidden');
                return;
            }
            const val = result.data && typeof result.data.value !== 'undefined'
                ? result.data.value
                : null;
            valueEl.textContent = val === null ? '-' : formatCurrency(val);
        } catch (err) {
            errorEl.textContent = err.message || '试算失败';
            errorEl.classList.remove('hidden');
        }
    });
}

// 绩效等级系数函数按钮
const gradeCoefBtn = document.getElementById('fn-grade-coef');
if (gradeCoefBtn) {
    gradeCoefBtn.addEventListener('click', () => {
        insertFunctionIntoEditor('grade_coef()');
    });
}

// 薪资折算函数按钮
const prorateBtn = document.getElementById('fn-prorate');
if (prorateBtn) {
    prorateBtn.addEventListener('click', () => {
        insertFunctionIntoEditor('prorate(薪资)');
    });
}

// 岗位基础薪资系数函数按钮
const positionBaseCoefBtn = document.getElementById('fn-position-base-coef');
if (positionBaseCoefBtn) {
    positionBaseCoefBtn.addEventListener('click', () => {
        insertFunctionIntoEditor('position_base_coef(岗位)');
    });
}

// 岗位绩效薪资系数函数按钮
const positionPerfCoefBtn = document.getElementById('fn-position-perf-coef');
if (positionPerfCoefBtn) {
    positionPerfCoefBtn.addEventListener('click', () => {
        insertFunctionIntoEditor('position_perf_coef(岗位)');
    });
}

// 从公式编辑器获取HTML内容（保留token样式）
function getFormulaHTML() {
    const editor = document.getElementById('formula-editor');
    if (!editor) return '';
    return editor.innerHTML || '';
}
function getDeductionFormulaHTML() {
    const editor = document.getElementById('deduction-formula-editor');
    if (!editor) return '';
    return editor.innerHTML || '';
}
function getTaxFormulaHTML() {
    const editor = document.getElementById('tax-formula-editor');
    if (!editor) return '';
    return editor.innerHTML || '';
}

// 从公式编辑器获取纯文本内容（用于构建表达式）
function getFormulaText() {
    const editor = document.getElementById('formula-editor');
    if (!editor) return '';
    return editor.textContent || editor.innerText || '';
}

// 加载保存的公式（应发 + 社保公积金扣除 + 个税扣除）
async function loadSavedFormula() {
    try {
        const response = await fetch('/api/payroll/formula');
        const result = await response.json();
        if (!result.success || !result.data) return;
        const data = result.data;
        const grossHTML = data.gross_formula != null ? data.gross_formula : (data.formula || '');
        const deductionHTML = data.deduction_formula || '';
        const taxHTML = data.tax_formula || '';
        const grossEditor = document.getElementById('formula-editor');
        const deductionEditor = document.getElementById('deduction-formula-editor');
        const taxEditor = document.getElementById('tax-formula-editor');
        if (grossEditor) grossEditor.innerHTML = grossHTML;
        if (deductionEditor) deductionEditor.innerHTML = deductionHTML;
        if (taxEditor) taxEditor.innerHTML = taxHTML;
    } catch (error) {
        console.error('加载公式失败:', error);
    }
}

// 保存公式按钮（同时保存应发、社保公积金扣除、个税扣除公式）
const saveFormulaBtn = document.getElementById('formula-save-btn');
if (saveFormulaBtn) {
    saveFormulaBtn.addEventListener('click', async () => {
        const grossHTML = getFormulaHTML();
        const deductionHTML = getDeductionFormulaHTML();
        const taxHTML = getTaxFormulaHTML();
        const grossText = getFormulaText();
        const deductionText = (document.getElementById('deduction-formula-editor') || {}).textContent || '';
        const taxText = (document.getElementById('tax-formula-editor') || {}).textContent || '';
        if (!grossText.trim() && !deductionText.trim() && !taxText.trim()) {
            alert('请至少填写一项公式（应发薪资、社保公积金扣除或个税扣除）');
            return;
        }
        try {
            const response = await fetch('/api/payroll/formula', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ gross_formula: grossHTML, deduction_formula: deductionHTML, tax_formula: taxHTML })
            });
            const result = await response.json();
            if (result.success) {
                alert('公式已保存');
            } else {
                alert('保存失败: ' + (result.error || '未知错误'));
            }
        } catch (error) {
            alert('保存失败: ' + error.message);
        }
    });
}

</script>
{% endblock %}
