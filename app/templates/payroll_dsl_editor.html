{% extends "layout.html" %}
{% block title %}薪资计算规则编辑器{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/material.min.css">
<style>
    .CodeMirror {
        border: 1px solid #ddd;
        border-radius: 4px;
        height: 600px;
        font-size: 14px;
    }
    .rule-card {
        margin-bottom: 16px;
    }
    .rule-active {
        border-left: 4px solid #4caf50;
    }
    .rule-inactive {
        border-left: 4px solid #9e9e9e;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col s12">
        <h4>薪资计算规则编辑器</h4>
        <p class="grey-text">配置薪资计算参数（绩效系数、拆分比例等）。计算逻辑由系统固定，用户只需修改配置映射。</p>
    </div>
</div>

<div class="row">
    <!-- 规则列表 -->
    <div class="col s12 m4">
        <div class="card">
            <div class="card-content">
                <span class="card-title">规则列表</span>
                <button class="btn waves-effect waves-light btn-small" onclick="loadRules()">
                    <i class="material-icons left">refresh</i>刷新
                </button>
                <button class="btn waves-effect waves-light btn-small green" onclick="createNewRule()" style="margin-left: 8px;">
                    <i class="material-icons left">add</i>新建
                </button>
            </div>
            <div class="card-content" id="rules-list">
                <p class="grey-text">加载中...</p>
            </div>
        </div>
    </div>

    <!-- 编辑器 -->
    <div class="col s12 m8">
        <div class="card">
            <div class="card-content">
                <span class="card-title">规则编辑器</span>
                <div class="row">
                    <div class="input-field col s6">
                        <input type="text" id="rule-name" placeholder="规则名称">
                        <label for="rule-name">规则名称</label>
                    </div>
                    <div class="input-field col s3">
                        <input type="text" id="rule-version" value="1.0" placeholder="版本">
                        <label for="rule-version">版本</label>
                    </div>
                    <div class="input-field col s3">
                        <input type="text" id="rule-effective-date" class="datepicker" placeholder="生效日期">
                        <label for="rule-effective-date">生效日期</label>
                    </div>
                </div>
                <div class="input-field col s12">
                    <textarea id="rule-description" class="materialize-textarea" placeholder="规则描述"></textarea>
                    <label for="rule-description">规则描述</label>
                </div>
                <div id="dsl-editor-container">
                    <textarea id="dsl-editor"></textarea>
                </div>
                <div class="card-action" style="margin-top: 16px;">
                    <button class="btn waves-effect waves-light" onclick="validateDSL()">
                        <i class="material-icons left">check</i>验证语法
                    </button>
                    <button class="btn waves-effect waves-light blue" onclick="saveRule()" id="save-btn" disabled>
                        <i class="material-icons left">save</i>保存规则
                    </button>
                    <button class="btn waves-effect waves-light green" onclick="activateRule()" id="activate-btn" disabled>
                        <i class="material-icons left">power</i>激活规则
                    </button>
                    <button class="btn waves-effect waves-light red" onclick="deleteRule()" id="delete-btn" disabled>
                        <i class="material-icons left">delete</i>删除规则
                    </button>
                </div>
                <div id="validation-result" style="margin-top: 16px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- 规则详情 Modal -->
<div id="rule-detail-modal" class="modal">
    <div class="modal-content">
        <h4>规则详情</h4>
        <div id="rule-detail-content"></div>
    </div>
    <div class="modal-footer">
        <a href="#!" class="modal-close btn">关闭</a>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/yaml/yaml.min.js"></script>
<script src="/static/js/payroll_dsl_editor.js"></script>
{% endblock %}

