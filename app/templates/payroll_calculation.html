{% extends "base.html" %}

{% block title %}工资计算 - HRMS{% endblock %}

{% block extra_head %}
<style>
  .step-row { cursor: pointer; position: relative; }
  .step-row:hover { background-color: #f3f4f6; }
  .source-tag { font-size: 0.7rem; padding: 0.1rem 0.35rem; border-radius: 4px; }
  .source-formula { background: #dbeafe; color: #1e40af; }
  .source-prev_month { background: #e5e7eb; color: #4b5563; }
  .source-tax_bracket { background: #fef3c7; color: #92400e; }
  .section-title { font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; padding: 0.5rem 1rem; background: #f9fafb; border-bottom: 1px solid #e5e7eb; cursor: pointer; user-select: none; display: flex; align-items: center; justify-content: space-between; }
  .section-title:hover { background: #f3f4f6; }
  .section-title .chevron { transition: transform 0.2s; }
  .section-title.collapsed .chevron { transform: rotate(-90deg); }
  .section-body.collapsed { display: none; }
  .step-desc-text { white-space: pre-line; }
  .section-card { display: flex; flex-direction: column; min-height: 0; }
  .section-card .section-body { flex: 1; min-height: 0; display: flex; flex-direction: column; }
  .section-card .section-body ul { flex: 1; min-height: 0; overflow-y: auto; }
  .section-footer { padding: 0.75rem 1rem; background: #f9fafb; border-top: 1px solid #e5e7eb; text-align: right; }
  .section-footer-value { font-size: 1.25rem; font-weight: 700; color: #1f2937; }
  .section-footer-value.empty { color: #9ca3af; font-weight: 500; }
  #step-tooltip { position: fixed; z-index: 100; max-width: 340px; padding: 0.75rem 1rem; background: rgba(55, 65, 81, 0.92); color: #f3f4f6; border-radius: 8px; font-size: 0.8125rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.15); pointer-events: none; white-space: pre-line; display: none; }
  #step-tooltip.visible { display: block; }
  #step-tooltip .tooltip-title { font-weight: 600; margin-bottom: 0.35rem; }
  #step-tooltip .tooltip-desc { color: #e5e7eb; line-height: 1.45; margin-bottom: 0.5rem; }
  #step-tooltip .tooltip-value { font-weight: 600; color: #fde68a; }
</style>
{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-900">工资计算</h2>
        <p class="mt-1 text-sm text-gray-500">应发薪资、社保公积金扣除、个税三项计算步骤一览；选择发放周期与员工后可预览各步结果</p>
    </div>

    <!-- 筛选与预览 -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
            <div>
                <label for="tax-period" class="block text-sm font-medium text-gray-700 mb-1">发放周期</label>
                <input type="month" id="tax-period" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm">
            </div>
            <div>
                <label for="tax-company" class="block text-sm font-medium text-gray-700 mb-1">公司</label>
                <select id="tax-company" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm">
                    <option value="">请选择公司</option>
                </select>
            </div>
            <div>
                <label for="tax-department" class="block text-sm font-medium text-gray-700 mb-1">部门</label>
                <select id="tax-department" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm">
                    <option value="">请先选择公司</option>
                </select>
            </div>
            <div>
                <label for="tax-person" class="block text-sm font-medium text-gray-700 mb-1">人员</label>
                <select id="tax-person" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm">
                    <option value="">请先选择公司</option>
                </select>
            </div>
            <div>
                <button id="tax-preview-btn" class="w-full px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">预览各步结果</button>
            </div>
        </div>
    </div>

    <!-- 三块水平排列，每块为 card，底部显示本块最终结果；步骤详情用 tooltip 展示 -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- 应发薪资计算 -->
        <div id="section-gross-card" class="section-card bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden flex flex-col" style="min-height: 320px;">
            <div id="section-gross-title" class="section-title" data-section="gross" aria-expanded="true">
                <span>应发薪资计算</span>
                <span class="chevron text-gray-400">▼</span>
            </div>
            <div id="section-gross-body" class="section-body">
                <ul id="gross-step-list" class="divide-y divide-gray-200 max-h-52 overflow-y-auto">
                    <!-- 动态填充 -->
                </ul>
            </div>
            <div class="section-footer">
                <span class="text-xs text-gray-500 block mb-0.5">应发金额</span>
                <span id="gross-footer-value" class="section-footer-value empty">—</span>
            </div>
        </div>
        <!-- 社保公积金扣除计算 -->
        <div id="section-social-card" class="section-card bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden flex flex-col" style="min-height: 320px;">
            <div id="section-social-title" class="section-title" data-section="social" aria-expanded="true">
                <span>社保公积金扣除计算</span>
                <span class="chevron text-gray-400">▼</span>
            </div>
            <div id="section-social-body" class="section-body">
                <ul id="social-housing-step-list" class="divide-y divide-gray-200 max-h-52 overflow-y-auto">
                    <!-- 动态填充 -->
                </ul>
            </div>
            <div class="section-footer">
                <span class="text-xs text-gray-500 block mb-0.5">扣除合计</span>
                <span id="social-footer-value" class="section-footer-value empty">—</span>
            </div>
        </div>
        <!-- 个税计算 -->
        <div id="section-tax-card" class="section-card bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden flex flex-col" style="min-height: 320px;">
            <div id="section-tax-title" class="section-title" data-section="tax" aria-expanded="true">
                <span>个税计算</span>
                <span class="chevron text-gray-400">▼</span>
            </div>
            <div id="section-tax-body" class="section-body">
                <ul id="step-list" class="divide-y divide-gray-200 max-h-52 overflow-y-auto">
                    <!-- 动态填充 -->
                </ul>
            </div>
            <div class="section-footer">
                <span class="text-xs text-gray-500 block mb-0.5">本月个税</span>
                <span id="tax-footer-value" class="section-footer-value empty">—</span>
            </div>
        </div>
    </div>

    <!-- 步骤详情 tooltip（悬停时显示） -->
    <div id="step-tooltip">
        <div class="tooltip-title" id="step-tooltip-title"></div>
        <div class="tooltip-desc step-desc-text" id="step-tooltip-desc"></div>
        <div class="tooltip-value" id="step-tooltip-value"></div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
  const grossStepListEl = document.getElementById('gross-step-list');
  const socialHousingStepListEl = document.getElementById('social-housing-step-list');
  const stepListEl = document.getElementById('step-list');
  const stepTooltip = document.getElementById('step-tooltip');
  const stepTooltipTitle = document.getElementById('step-tooltip-title');
  const stepTooltipDesc = document.getElementById('step-tooltip-desc');
  const stepTooltipValue = document.getElementById('step-tooltip-value');
  const grossFooterValue = document.getElementById('gross-footer-value');
  const socialFooterValue = document.getElementById('social-footer-value');
  const taxFooterValue = document.getElementById('tax-footer-value');

  let grossSteps = [];
  let socialSteps = [];
  let steps = [];
  let grossValues = {};
  let socialValues = {};
  let stepValues = {};
  let tooltipHideTimer = null;
  let companyEmployments = [];

  function escapeHtml(s) {
    if (s == null) return '';
    var div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }

  function showStepTooltip(rowEl, title, desc, valueStr) {
    if (tooltipHideTimer) { clearTimeout(tooltipHideTimer); tooltipHideTimer = null; }
    stepTooltipTitle.textContent = title;
    stepTooltipDesc.textContent = desc;
    stepTooltipValue.textContent = valueStr;
    stepTooltip.classList.add('visible');
    function position() {
      var rect = rowEl.getBoundingClientRect();
      var ttRect = stepTooltip.getBoundingClientRect();
      var gap = 8;
      var x = rect.right + gap;
      var y = rect.top;
      if (x + ttRect.width > window.innerWidth - 12) x = rect.left - ttRect.width - gap;
      if (x < 12) x = 12;
      if (y + ttRect.height > window.innerHeight - 12) y = window.innerHeight - ttRect.height - 12;
      if (y < 12) y = 12;
      stepTooltip.style.left = x + 'px';
      stepTooltip.style.top = y + 'px';
    }
    position();
    requestAnimationFrame(position);
  }

  function hideStepTooltip() {
    if (tooltipHideTimer) clearTimeout(tooltipHideTimer);
    tooltipHideTimer = setTimeout(function() {
      stepTooltip.classList.remove('visible');
      tooltipHideTimer = null;
    }, 80);
  }

  function updateFooterValues() {
    var gLast = grossSteps.length ? grossValues[String(grossSteps[grossSteps.length - 1].step)] : undefined;
    var sLast = socialSteps.length ? socialValues[String(socialSteps[socialSteps.length - 1].step)] : undefined;
    var tLast = stepValues['tax_14'];
    if (gLast !== undefined && gLast !== null) {
      grossFooterValue.textContent = Number(gLast).toFixed(2) + ' 元';
      grossFooterValue.classList.remove('empty');
    } else {
      grossFooterValue.textContent = '—';
      grossFooterValue.classList.add('empty');
    }
    if (sLast !== undefined && sLast !== null) {
      socialFooterValue.textContent = Number(sLast).toFixed(2) + ' 元';
      socialFooterValue.classList.remove('empty');
    } else {
      socialFooterValue.textContent = '—';
      socialFooterValue.classList.add('empty');
    }
    if (tLast !== undefined && tLast !== null) {
      taxFooterValue.textContent = Number(tLast).toFixed(2) + ' 元';
      taxFooterValue.classList.remove('empty');
    } else {
      taxFooterValue.textContent = '—';
      taxFooterValue.classList.add('empty');
    }
  }

  function renderGrossStepList() {
    grossStepListEl.innerHTML = grossSteps.map(function(s, i) {
      const stepKey = String(s.step);
      const val = grossValues[stepKey];
      const valStr = val !== undefined && val !== null ? Number(val).toFixed(2) : '—';
      return '<li class="step-row px-4 py-2.5 flex items-center justify-between gap-2" data-step="' + s.step + '" data-index="' + i + '">' +
        '<span class="text-sm font-medium text-gray-900 truncate">' + escapeHtml((i + 1) + '. ' + (s.field_name || '')) + '</span>' +
        '<span class="text-sm text-gray-500 tabular-nums flex-shrink-0">' + valStr + '</span>' +
      '</li>';
    }).join('');
  }
  function renderSocialHousingStepList() {
    socialHousingStepListEl.innerHTML = socialSteps.map(function(s, i) {
      const stepKey = String(s.step);
      const val = socialValues[stepKey];
      const valStr = val !== undefined && val !== null ? Number(val).toFixed(2) : '—';
      return '<li class="step-row px-4 py-2.5 flex items-center justify-between gap-2" data-step="' + s.step + '" data-index="' + i + '">' +
        '<span class="text-sm font-medium text-gray-900 truncate">' + escapeHtml((i + 1) + '. ' + (s.field_name || '')) + '</span>' +
        '<span class="text-sm text-gray-500 tabular-nums flex-shrink-0">' + valStr + '</span>' +
      '</li>';
    }).join('');
  }

  function setDefaultPeriod() {
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, '0');
    const period = document.getElementById('tax-period');
    if (period && !period.value) period.value = y + '-' + m;
  }

  function renderStepList() {
    stepListEl.innerHTML = steps.map((s, i) => {
      const val = stepValues['tax_' + s.step];
      const valStr = val !== undefined ? Number(val).toFixed(2) : '—';
      return '<li class="step-row px-4 py-2.5 flex items-center justify-between gap-2" data-step="' + s.step + '" data-index="' + i + '">' +
        '<span class="text-sm font-medium text-gray-900 truncate">' + escapeHtml(s.step + '. ' + s.field_name) + '</span>' +
        '<span class="text-sm text-gray-500 tabular-nums flex-shrink-0">' + valStr + '</span>' +
      '</li>';
    }).join('');
  }

  function loadSteps() {
    fetch('/api/payroll/calculation-steps')
      .then(r => r.json())
      .then(res => {
        if (!res.success || !res.data) return;
        grossSteps = res.data.gross || [];
        socialSteps = res.data.social || [];
        steps = res.data.tax || [];
        renderGrossStepList();
        renderSocialHousingStepList();
        renderStepList();
        updateFooterValues();
      })
      .catch(() => {});
  }

  function loadCompanies() {
    fetch('/api/twins/company')
      .then(r => r.json())
      .then(res => {
        if (!res.success || !res.data) return;
        const sel = document.getElementById('tax-company');
        sel.innerHTML = '<option value="">请选择公司</option>';
        res.data.forEach(c => {
          const id = c.id;
          const name = (c.name != null) ? c.name : ('ID ' + id);
          sel.appendChild(new Option(name, id));
        });
      })
      .catch(() => {});
  }

  function buildPersonOptions(employments, departmentFilter) {
    const personSelect = document.getElementById('tax-person');
    personSelect.innerHTML = '<option value="">请选择人员</option>';
    const seen = new Set();
    employments.forEach(row => {
      if (departmentFilter && (row.department || '') !== departmentFilter) return;
      const pid = row.person_id != null ? row.person_id : row.id;
      if (seen.has(pid)) return;
      seen.add(pid);
      const name = (row.person_name != null ? row.person_name : (row.name != null ? row.name : ('人员 ' + pid)));
      personSelect.appendChild(new Option(name, pid));
    });
  }

  document.getElementById('tax-company').addEventListener('change', function() {
    const companyId = this.value;
    const departmentSelect = document.getElementById('tax-department');
    const personSelect = document.getElementById('tax-person');
    departmentSelect.innerHTML = '<option value="">请先选择公司</option>';
    personSelect.innerHTML = '<option value="">请先选择公司</option>';
    companyEmployments = [];
    if (!companyId) return;
    fetch('/api/twins/person_company_employment?company_id=' + companyId + '&enrich=person')
      .then(r => r.json())
      .then(res => {
        if (!res.success || !res.data) return;
        companyEmployments = res.data;
        const deptSet = new Set();
        res.data.forEach(row => {
          const d = (row.department || '').trim();
          if (d) deptSet.add(d);
        });
        departmentSelect.innerHTML = '<option value="">全部部门</option>';
        Array.from(deptSet).sort().forEach(d => {
          departmentSelect.appendChild(new Option(d, d));
        });
        buildPersonOptions(companyEmployments, '');
      })
      .catch(() => {});
  });

  document.getElementById('tax-department').addEventListener('change', function() {
    const departmentFilter = this.value || '';
    buildPersonOptions(companyEmployments, departmentFilter);
  });

  document.getElementById('tax-preview-btn').addEventListener('click', function() {
    const period = document.getElementById('tax-period').value;
    const companyId = document.getElementById('tax-company').value;
    const personId = document.getElementById('tax-person').value;
    if (!period || !companyId || !personId) {
      alert('请选择发放周期、公司、人员后再预览');
      return;
    }
    fetch('/api/payroll/calculation-steps/preview', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ person_id: parseInt(personId, 10), company_id: parseInt(companyId, 10), period: period })
    })
      .then(r => r.json())
      .then(res => {
        if (!res.success) {
          alert(res.error || '预览失败');
          return;
        }
        var d = res.data;
        if (d.gross) {
          grossSteps = d.gross.steps || grossSteps;
          grossValues = d.gross.values || {};
        }
        if (d.social) {
          socialSteps = d.social.steps || socialSteps;
          socialValues = d.social.values || {};
        }
        if (d.tax) {
          steps = d.tax.steps || steps;
          stepValues = d.tax.values || {};
        }
        renderGrossStepList();
        renderSocialHousingStepList();
        renderStepList();
        updateFooterValues();
      })
      .catch(() => alert('请求失败'));
  });

  function onGrossRowOver(ev) {
    var row = ev.target.closest('.step-row[data-step]');
    if (!row || !row.closest('#gross-step-list')) { hideStepTooltip(); return; }
    var i = parseInt(row.getAttribute('data-index'), 10);
    var s = grossSteps[i];
    if (!s) return;
    var val = grossValues[String(s.step)];
    var valStr = val !== undefined && val !== null ? Number(val).toFixed(2) + ' 元' : '—';
    showStepTooltip(row, s.field_name || '', s.desc || '', valStr);
  }
  function onSocialRowOver(ev) {
    var row = ev.target.closest('.step-row[data-step]');
    if (!row || !row.closest('#social-housing-step-list')) { hideStepTooltip(); return; }
    var i = parseInt(row.getAttribute('data-index'), 10);
    var s = socialSteps[i];
    if (!s) return;
    var val = socialValues[String(s.step)];
    var valStr = val !== undefined && val !== null ? Number(val).toFixed(2) + ' 元' : '—';
    showStepTooltip(row, s.field_name || '', s.desc || '', valStr);
  }
  function onTaxRowOver(ev) {
    var row = ev.target.closest('.step-row');
    if (!row || !row.closest('#step-list')) { hideStepTooltip(); return; }
    var i = parseInt(row.getAttribute('data-index'), 10);
    var s = steps[i];
    if (!s) return;
    var v = stepValues['tax_' + s.step];
    var valueStr = v !== undefined ? Number(v).toFixed(2) + ' 元' : '—';
    if (s.source === 'prev_month') valueStr = (v !== undefined ? Number(v).toFixed(2) : '0') + '（上月带入暂为 0）';
    var desc = (s.desc != null && s.desc !== '') ? ('第' + s.step + '步：' + s.desc) : (s.field_name || '');
    showStepTooltip(row, s.field_name || '', desc, valueStr);
  }
  function onListOut(ev) {
    var list = ev.currentTarget;
    if (list.contains(ev.relatedTarget)) return;
    hideStepTooltip();
  }

  grossStepListEl.addEventListener('mouseover', onGrossRowOver);
  grossStepListEl.addEventListener('mouseout', onListOut);
  socialHousingStepListEl.addEventListener('mouseover', onSocialRowOver);
  socialHousingStepListEl.addEventListener('mouseout', onListOut);
  stepListEl.addEventListener('mouseover', onTaxRowOver);
  stepListEl.addEventListener('mouseout', onListOut);

  function toggleSection(sectionId) {
    var title = document.getElementById('section-' + sectionId + '-title');
    var body = document.getElementById('section-' + sectionId + '-body');
    if (!title || !body) return;
    var isCollapsed = title.classList.contains('collapsed');
    if (isCollapsed) {
      title.classList.remove('collapsed');
      body.classList.remove('collapsed');
      title.setAttribute('aria-expanded', 'true');
    } else {
      title.classList.add('collapsed');
      body.classList.add('collapsed');
      title.setAttribute('aria-expanded', 'false');
    }
  }

  document.getElementById('section-gross-title').addEventListener('click', function() { toggleSection('gross'); });
  document.getElementById('section-social-title').addEventListener('click', function() { toggleSection('social'); });
  document.getElementById('section-tax-title').addEventListener('click', function() { toggleSection('tax'); });

  setDefaultPeriod();
  loadSteps();
  loadCompanies();
})();
</script>
{% endblock %}
