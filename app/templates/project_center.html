{% extends "base.html" %}

{% block title %}项目管理中心 - HRMS{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-900">项目管理中心</h2>
        <p class="mt-1 text-sm text-gray-500">统一管理客户合同、款项及内部项目关联关系</p>
    </div>

    <!-- 加载状态 -->
    <div id="loading" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
        <p class="mt-2 text-sm text-gray-500">加载中...</p>
    </div>

    <!-- 错误提示 -->
    <div id="error" class="hidden bg-red-50 border border-red-200 rounded-md p-4 mb-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">加载失败</h3>
                <p id="error-message" class="mt-2 text-sm text-red-700"></p>
            </div>
        </div>
    </div>

    <!-- 三栏展示 -->
    <div id="main-container" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- 内部项目栏 -->
            <div class="bg-white rounded-lg shadow border border-gray-200">
                <div class="px-4 py-3 bg-gray-50 border-b border-gray-200 rounded-t-lg flex justify-between items-center">
                    <h3 class="text-sm font-semibold text-gray-900">内部项目</h3>
                    <button onclick="addProject()" class="text-xs bg-indigo-600 hover:bg-indigo-700 text-white px-2 py-1 rounded transition-colors">
                        + 新建
                    </button>
                </div>
                <div id="projects-column" class="divide-y divide-gray-100 max-h-[70vh] overflow-y-auto"></div>
            </div>

            <!-- 款项栏 -->
            <div class="bg-white rounded-lg shadow border border-gray-200">
                <div class="px-4 py-3 bg-gray-50 border-b border-gray-200 rounded-t-lg flex justify-between items-center">
                    <h3 class="text-sm font-semibold text-gray-900">款项</h3>
                    <button onclick="createPaymentItem(null)" class="text-xs bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded transition-colors">
                        + 新建款项
                    </button>
                </div>
                <div id="payment-items-column" class="divide-y divide-gray-100 max-h-[70vh] overflow-y-auto"></div>
            </div>

            <!-- 客户合同栏 -->
            <div class="bg-white rounded-lg shadow border border-gray-200">
                <div class="px-4 py-3 bg-gray-50 border-b border-gray-200 rounded-t-lg flex justify-between items-center">
                    <h3 class="text-sm font-semibold text-gray-900">客户合同</h3>
                    <button onclick="addContract()" class="text-xs bg-indigo-600 hover:bg-indigo-700 text-white px-2 py-1 rounded transition-colors">
                        + 新建
                    </button>
                </div>
                <div id="contracts-column" class="divide-y divide-gray-100 max-h-[70vh] overflow-y-auto"></div>
            </div>

        </div>
    </div>
</div>

<!-- ===== 模态框：通用实体表单（项目/合同） ===== -->
<div id="form-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-full max-w-xl shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 id="form-modal-title" class="text-lg font-semibold text-gray-900"></h3>
            <button onclick="document.getElementById('form-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <form id="entity-form" onsubmit="submitEntityForm(event)">
            <div id="form-fields" class="space-y-1 max-h-[60vh] overflow-y-auto pr-1"></div>
            <div class="mt-4 flex justify-end gap-3">
                <button type="button" onclick="document.getElementById('form-modal').classList.add('hidden')"
                    class="px-4 py-2 text-sm border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">取消</button>
                <button type="submit" class="px-4 py-2 text-sm bg-indigo-600 text-white rounded-md hover:bg-indigo-700">保存</button>
            </div>
        </form>
    </div>
</div>

<!-- ===== 模态框：新建/编辑款项 ===== -->
<div id="payment-item-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-full max-w-xl shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 id="payment-item-modal-title" class="text-lg font-semibold text-gray-900">新建款项</h3>
            <button onclick="document.getElementById('payment-item-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <form id="payment-item-form" onsubmit="submitPaymentItemForm(event)">
            <input type="hidden" id="payment-item-id" value="">
            <div class="space-y-1 max-h-[60vh] overflow-y-auto pr-1">
                <!-- 所属合同（特殊下拉） -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start py-2">
                    <div class="md:col-span-1">
                        <label for="pi-client_contract_id" class="block text-sm font-medium text-gray-700 pt-2 text-right">
                            所属合同 <span class="text-red-500">*</span>
                        </label>
                    </div>
                    <div class="md:col-span-2">
                        <select id="pi-client_contract_id" name="client_contract_id" required
                            class="block w-full px-3 py-2 bg-white border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">请选择合同</option>
                        </select>
                    </div>
                </div>
                <!-- 其余字段（排除 client_contract_id） -->
                <div id="payment-item-form-fields"></div>
            </div>
            <div class="mt-4 flex justify-end gap-3">
                <button type="button" onclick="document.getElementById('payment-item-modal').classList.add('hidden')"
                    class="px-4 py-2 text-sm border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">取消</button>
                <button type="submit" class="px-4 py-2 text-sm bg-green-600 text-white rounded-md hover:bg-green-700">保存</button>
            </div>
        </form>
    </div>
</div>

<!-- ===== 模态框：关联内部项目 ===== -->
<div id="associate-project-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900">关联内部项目</h3>
            <button onclick="document.getElementById('associate-project-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <form id="associate-project-form" onsubmit="submitAssociateProjectForm(event)">
            <input type="hidden" id="associate-payment-item-id" value="">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">选择内部项目</label>
                <select id="associate-project-id" name="project_id" required
                    class="block w-full px-3 py-2 border-2 border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">请选择项目</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">备注</label>
                <textarea id="associate-notes" name="notes" rows="2"
                    class="block w-full px-3 py-2 border-2 border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="document.getElementById('associate-project-modal').classList.add('hidden')"
                    class="px-4 py-2 text-sm border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">取消</button>
                <button type="submit" class="px-4 py-2 text-sm bg-indigo-600 text-white rounded-md hover:bg-indigo-700">关联</button>
            </div>
        </form>
    </div>
</div>

<script>
// ===== Schema（来自后端） =====
const paymentItemSchema = {{ payment_item_schema | tojson }};
const contractSchema    = {{ contract_schema | tojson }};
const projectSchema     = {{ project_schema | tojson }};

// ===== 全局状态 =====
let allContracts = [];
let allPaymentItems = [];
let allProjects = [];
let projectPaymentAssocs = []; // internal_project_payment activities

// ===== 数据加载 =====
async function loadAllData() {
    try {
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('main-container').classList.add('hidden');

        const [contractsRes, paymentItemsRes, projectsRes, assocRes] = await Promise.all([
            fetch('/api/twins/client_contract'),
            fetch('/api/twins/payment_item'),
            fetch('/api/twins/internal_project'),
            fetch('/api/twins/internal_project_payment?enrich=internal_project,payment_item'),
        ]);

        const [contractsData, paymentItemsData, projectsData, assocData] = await Promise.all([
            contractsRes.json(),
            paymentItemsRes.json(),
            projectsRes.json(),
            assocRes.json(),
        ]);

        allContracts    = contractsData.success ? contractsData.data : [];
        allPaymentItems = paymentItemsData.success ? paymentItemsData.data : [];
        allProjects     = projectsData.success ? projectsData.data : [];
        projectPaymentAssocs = assocData.success ? assocData.data : [];

        renderAll();
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('main-container').classList.remove('hidden');
    } catch (err) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('error').classList.remove('hidden');
        document.getElementById('error-message').textContent = err.message;
    }
}

// 工具：合同 ID → 合同名
function contractName(contractId) {
    const c = allContracts.find(x => x.id == contractId);
    return c ? (c.contract_name || `合同 ${c.id}`) : `合同 ${contractId}`;
}

// 工具：款项 ID → 关联项目名列表
function paymentItemProjects(paymentItemId) {
    return projectPaymentAssocs
        .filter(a => a.payment_item_id == paymentItemId)
        .map(a => {
            const p = allProjects.find(x => x.id == a.internal_project_id);
            return p ? (p.name || `项目 ${p.id}`) : `项目 ${a.internal_project_id}`;
        });
}

// 工具：项目 ID → 关联款项列表
function projectPaymentItems(projectId) {
    const assocs = projectPaymentAssocs.filter(a => a.internal_project_id == projectId);
    return assocs.map(a => allPaymentItems.find(pi => pi.id == a.payment_item_id)).filter(Boolean);
}

// ===== 渲染三栏 =====
function renderAll() {
    renderProjectsColumn();
    renderPaymentItemsColumn();
    renderContractsColumn();
}

function renderProjectsColumn() {
    const container = document.getElementById('projects-column');
    if (!allProjects.length) {
        container.innerHTML = '<p class="text-sm text-gray-400 text-center py-6">暂无内部项目</p>';
        return;
    }
    container.innerHTML = allProjects.map(p => {
        const pis = projectPaymentItems(p.id);
        const total = pis.reduce((s, pi) => s + (parseFloat(pi.amount) || 0), 0);
        const statusColors = {
            '筹备中': 'bg-yellow-100 text-yellow-800',
            '进行中': 'bg-green-100 text-green-800',
            '已暂停': 'bg-gray-100 text-gray-600',
            '已完成': 'bg-blue-100 text-blue-800',
            '已取消': 'bg-red-100 text-red-700',
        };
        const statusClass = statusColors[p.status] || 'bg-gray-100 text-gray-600';
        return `
        <div class="px-4 py-3 hover:bg-gray-50 transition-colors" data-id="${p.id}" data-type="project">
            <div class="flex justify-between items-start">
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 truncate">${p.name || '未命名项目'}</p>
                    <p class="text-xs text-gray-500 mt-0.5">${p.department || ''} ${p.project_manager ? '· ' + p.project_manager : ''}</p>
                    <div class="flex items-center gap-2 mt-1">
                        ${p.status ? `<span class="text-xs px-1.5 py-0.5 rounded ${statusClass}">${p.status}</span>` : ''}
                        <span class="text-xs text-gray-500">${pis.length} 笔款项${total > 0 ? ' · ¥' + total.toLocaleString() : ''}</span>
                    </div>
                </div>
                <div class="flex gap-1 ml-2 flex-shrink-0">
                    <button onclick="editProject(${p.id})" class="text-xs text-indigo-600 hover:text-indigo-800 px-1.5 py-0.5 rounded hover:bg-indigo-50">编辑</button>
                </div>
            </div>
        </div>`;
    }).join('');
}

function renderPaymentItemsColumn() {
    const container = document.getElementById('payment-items-column');
    if (!allPaymentItems.length) {
        container.innerHTML = '<p class="text-sm text-gray-400 text-center py-6">暂无款项</p>';
        return;
    }
    container.innerHTML = allPaymentItems.map(pi => {
        const cName = contractName(pi.client_contract_id);
        const projects = paymentItemProjects(pi.id);
        const statusColors = {
            '待付款': 'bg-yellow-100 text-yellow-800',
            '已付款': 'bg-green-100 text-green-800',
        };
        const statusClass = statusColors[pi.status] || 'bg-gray-100 text-gray-500';
        const amount = pi.amount ? '¥' + parseFloat(pi.amount).toLocaleString() : '金额未填';
        return `
        <div class="px-4 py-3 hover:bg-gray-50 transition-colors" data-id="${pi.id}" data-type="payment_item">
            <div class="flex justify-between items-start">
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2">
                        <p class="text-sm font-medium text-gray-900">${amount}</p>
                        ${pi.period ? `<span class="text-xs text-gray-500">${pi.period}</span>` : ''}
                        ${pi.status ? `<span class="text-xs px-1.5 py-0.5 rounded ${statusClass}">${pi.status}</span>` : ''}
                    </div>
                    <p class="text-xs text-gray-500 mt-0.5 truncate">合同：${cName}</p>
                    ${projects.length ? `<p class="text-xs text-indigo-600 mt-0.5">项目：${projects.join('、')}</p>` : '<p class="text-xs text-gray-400 mt-0.5">未关联项目</p>'}
                    ${pi.planned_payment_date ? `<p class="text-xs text-gray-400 mt-0.5">预计付款：${pi.planned_payment_date}</p>` : ''}
                </div>
                <div class="flex flex-col gap-1 ml-2 flex-shrink-0">
                    <button onclick="editPaymentItem(${pi.id})" class="text-xs text-indigo-600 hover:text-indigo-800 px-1.5 py-0.5 rounded hover:bg-indigo-50">编辑</button>
                    <button onclick="associateProjectToPaymentItem(${pi.id})" class="text-xs text-green-600 hover:text-green-800 px-1.5 py-0.5 rounded hover:bg-green-50">关联项目</button>
                </div>
            </div>
        </div>`;
    }).join('');
}

function renderContractsColumn() {
    const container = document.getElementById('contracts-column');
    if (!allContracts.length) {
        container.innerHTML = '<p class="text-sm text-gray-400 text-center py-6">暂无客户合同</p>';
        return;
    }
    container.innerHTML = allContracts.map(c => {
        const piCount = allPaymentItems.filter(pi => pi.client_contract_id == c.id).length;
        const piTotal = allPaymentItems
            .filter(pi => pi.client_contract_id == c.id)
            .reduce((s, pi) => s + (parseFloat(pi.amount) || 0), 0);
        const contractAmount = c.contract_amount ? '¥' + parseFloat(c.contract_amount).toLocaleString() : '';
        const statusColors = {
            '草稿': 'bg-gray-100 text-gray-500',
            '已签订': 'bg-blue-100 text-blue-700',
            '执行中': 'bg-green-100 text-green-700',
            '已完成': 'bg-indigo-100 text-indigo-700',
            '已终止': 'bg-red-100 text-red-700',
            '已取消': 'bg-gray-100 text-gray-500',
        };
        const statusClass = statusColors[c.status] || 'bg-gray-100 text-gray-500';
        return `
        <div class="px-4 py-3 hover:bg-gray-50 transition-colors" data-id="${c.id}" data-type="contract">
            <div class="flex justify-between items-start">
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 truncate">${c.contract_name || '未命名合同'}</p>
                    <p class="text-xs text-gray-500 mt-0.5">${c.client_company || ''} ${c.contract_number ? '· ' + c.contract_number : ''}</p>
                    <div class="flex items-center gap-2 mt-1">
                        ${c.status ? `<span class="text-xs px-1.5 py-0.5 rounded ${statusClass}">${c.status}</span>` : ''}
                        ${contractAmount ? `<span class="text-xs text-gray-600 font-medium">${contractAmount}</span>` : ''}
                    </div>
                    <p class="text-xs text-gray-500 mt-0.5">
                        已拆分 ${piCount} 笔款项${piTotal > 0 ? '，合计 ¥' + piTotal.toLocaleString() : ''}
                    </p>
                </div>
                <div class="flex flex-col gap-1 ml-2 flex-shrink-0">
                    <button onclick="editContract(${c.id})" class="text-xs text-indigo-600 hover:text-indigo-800 px-1.5 py-0.5 rounded hover:bg-indigo-50">编辑</button>
                    <button onclick="createPaymentItem(${c.id})" class="text-xs text-green-600 hover:text-green-800 px-1.5 py-0.5 rounded hover:bg-green-50">新建款项</button>
                </div>
            </div>
        </div>`;
    }).join('');
}

// ===== 通用表单渲染 =====
function renderFormFields(schema, data = {}, prefix = '', targetContainerId = 'form-fields') {
    const fields = schema.fields || {};
    const formFields = document.getElementById(targetContainerId);
    if (!formFields) return;
    formFields.innerHTML = '';

    const inputBaseClasses = "block w-full px-3 py-2 bg-white border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 hover:border-gray-400 transition-colors";

    for (const fieldName of Object.keys(fields)) {
        const fieldDef = fields[fieldName];
        if (fieldDef.ui?.component === 'entity_select') continue; // 单独处理
        if (fieldDef.type === 'reference') continue;

        const label = fieldDef.label || fieldName;
        let value = data[fieldName] ?? '';
        if (!value && fieldDef.auto === 'date') value = new Date().toISOString().split('T')[0];

        const required = fieldDef.required || false;
        const fieldType = fieldDef.type || 'string';
        const uiComponent = fieldDef.ui?.component || 'text_input';
        const fieldId = prefix ? `${prefix}-${fieldName}` : fieldName;

        let fieldHtml = '<div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start py-2">';
        fieldHtml += `<div class="md:col-span-1"><label for="${fieldId}" class="block text-sm font-medium text-gray-700 pt-2 text-right">${label}${required ? ' <span class="text-red-500">*</span>' : ''}</label></div>`;
        fieldHtml += '<div class="md:col-span-2">';

        if (uiComponent === 'textarea') {
            fieldHtml += `<textarea id="${fieldId}" name="${fieldName}" rows="3" class="${inputBaseClasses}" ${required ? 'required' : ''}>${value}</textarea>`;
        } else if (fieldType === 'enum' && fieldDef.options) {
            fieldHtml += `<select id="${fieldId}" name="${fieldName}" class="${inputBaseClasses}" ${required ? 'required' : ''}><option value="">请选择</option>`;
            for (const opt of fieldDef.options) {
                fieldHtml += `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`;
            }
            fieldHtml += '</select>';
        } else if (fieldType === 'date') {
            fieldHtml += `<input type="date" id="${fieldId}" name="${fieldName}" value="${value}" class="${inputBaseClasses}" ${required ? 'required' : ''}>`;
        } else if (fieldType === 'decimal' || fieldType === 'number' || fieldType === 'integer') {
            const step = fieldType === 'decimal' ? '0.01' : '1';
            const min = fieldDef.validation?.min ?? '';
            fieldHtml += `<div class="flex items-center gap-2"><input type="number" id="${fieldId}" name="${fieldName}" value="${value}" step="${step}" ${min !== '' ? `min="${min}"` : ''} placeholder="请输入${label}" class="${inputBaseClasses}" ${required ? 'required' : ''}>`;
            if (fieldDef.ui?.suffix) fieldHtml += `<span class="text-sm text-gray-500 whitespace-nowrap">${fieldDef.ui.suffix}</span>`;
            fieldHtml += '</div>';
        } else {
            fieldHtml += `<input type="text" id="${fieldId}" name="${fieldName}" value="${value}" placeholder="请输入${label}" class="${inputBaseClasses}" ${required ? 'required' : ''}>`;
        }

        if (fieldDef.description) fieldHtml += `<p class="mt-1 text-xs text-gray-500">${fieldDef.description}</p>`;
        fieldHtml += '</div></div>';
        formFields.innerHTML += fieldHtml;
    }
}

// ===== 项目 CRUD =====
let currentEditEntity = { type: null, id: null };

async function addProject() {
    currentEditEntity = { type: 'project', id: null };
    document.getElementById('form-modal-title').textContent = '新增内部项目';
    renderFormFields(projectSchema, {});
    document.getElementById('form-modal').classList.remove('hidden');
}

async function editProject(projectId) {
    try {
        const res = await fetch(`/api/twins/internal_project/${projectId}`);
        const result = await res.json();
        if (!result.success) { alert('加载失败'); return; }
        currentEditEntity = { type: 'project', id: projectId };
        document.getElementById('form-modal-title').textContent = '编辑内部项目';
        renderFormFields(projectSchema, result.data.current);
        document.getElementById('form-modal').classList.remove('hidden');
    } catch (err) { alert('加载失败: ' + err.message); }
}

// ===== 合同 CRUD =====
async function addContract() {
    currentEditEntity = { type: 'contract', id: null };
    document.getElementById('form-modal-title').textContent = '新增客户合同';
    renderFormFields(contractSchema, {});
    document.getElementById('form-modal').classList.remove('hidden');
}

async function editContract(contractId) {
    try {
        const res = await fetch(`/api/twins/client_contract/${contractId}`);
        const result = await res.json();
        if (!result.success) { alert('加载失败'); return; }
        currentEditEntity = { type: 'contract', id: contractId };
        document.getElementById('form-modal-title').textContent = '编辑客户合同';
        renderFormFields(contractSchema, result.data.current);
        document.getElementById('form-modal').classList.remove('hidden');
    } catch (err) { alert('加载失败: ' + err.message); }
}

// ===== 通用表单提交（项目/合同） =====
async function submitEntityForm(event) {
    event.preventDefault();
    const { type, id } = currentEditEntity;
    if (!type) return;

    const schema = type === 'project' ? projectSchema : contractSchema;
    const entityName = type === 'project' ? 'internal_project' : 'client_contract';
    const form = event.target;
    const formData = new FormData(form);
    const data = {};

    for (const [fieldName, fieldDef] of Object.entries(schema.fields || {})) {
        const value = formData.get(fieldName);
        if (value !== null && value !== '') {
            data[fieldName] = (fieldDef.type === 'decimal' || fieldDef.type === 'number')
                ? parseFloat(value) : value.trim();
        }
    }

    try {
        const url = id ? `/api/twins/${entityName}/${id}` : `/api/twins/${entityName}`;
        const res = await fetch(url, {
            method: id ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        });
        const result = await res.json();
        if (!result.success) { alert('保存失败: ' + result.error); return; }
        document.getElementById('form-modal').classList.add('hidden');
        await loadAllData();
    } catch (err) { alert('保存失败: ' + err.message); }
}

// ===== 款项 CRUD =====
function populateContractSelect(selectedId) {
    const select = document.getElementById('pi-client_contract_id');
    select.innerHTML = '<option value="">请选择合同</option>';
    allContracts.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.contract_name || `合同 ${c.id}`;
        if (c.id == selectedId) opt.selected = true;
        select.appendChild(opt);
    });
}

async function createPaymentItem(presetContractId) {
    document.getElementById('payment-item-modal-title').textContent = '新建款项';
    document.getElementById('payment-item-id').value = '';
    populateContractSelect(presetContractId);
    renderFormFields(paymentItemSchema, {}, '', 'payment-item-form-fields');
    document.getElementById('payment-item-modal').classList.remove('hidden');
}

async function editPaymentItem(paymentItemId) {
    try {
        const res = await fetch(`/api/twins/payment_item/${paymentItemId}`);
        const result = await res.json();
        if (!result.success) { alert('加载失败'); return; }
        const data = result.data.current;
        document.getElementById('payment-item-modal-title').textContent = '编辑款项';
        document.getElementById('payment-item-id').value = paymentItemId;
        populateContractSelect(data.client_contract_id);
        renderFormFields(paymentItemSchema, data, '', 'payment-item-form-fields');
        document.getElementById('payment-item-modal').classList.remove('hidden');
    } catch (err) { alert('加载失败: ' + err.message); }
}

async function submitPaymentItemForm(event) {
    event.preventDefault();
    const id = document.getElementById('payment-item-id').value || null;
    const formData = new FormData(event.target);
    const data = {};

    // 合同 ID
    const contractId = formData.get('client_contract_id');
    if (!contractId) { alert('请选择所属合同'); return; }
    data.client_contract_id = parseInt(contractId);

    // 其余字段
    for (const [fieldName, fieldDef] of Object.entries(paymentItemSchema.fields || {})) {
        if (fieldName === 'client_contract_id') continue;
        if (fieldDef.ui?.component === 'entity_select') continue;
        if (fieldDef.type === 'reference') continue;
        const value = formData.get(fieldName);
        if (value !== null && value !== '') {
            data[fieldName] = (fieldDef.type === 'decimal' || fieldDef.type === 'number' || fieldDef.type === 'integer')
                ? parseFloat(value) : value.trim();
        }
    }

    try {
        const url = id ? `/api/twins/payment_item/${id}` : '/api/twins/payment_item';
        const res = await fetch(url, {
            method: id ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        });
        const result = await res.json();
        if (!result.success) { alert('保存失败: ' + result.error); return; }
        document.getElementById('payment-item-modal').classList.add('hidden');
        await loadAllData();
    } catch (err) { alert('保存失败: ' + err.message); }
}

// ===== 关联内部项目 =====
async function associateProjectToPaymentItem(paymentItemId) {
    document.getElementById('associate-payment-item-id').value = paymentItemId;
    document.getElementById('associate-notes').value = '';

    const select = document.getElementById('associate-project-id');
    select.innerHTML = '<option value="">请选择项目</option>';
    allProjects.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name || `项目 ${p.id}`;
        select.appendChild(opt);
    });

    document.getElementById('associate-project-modal').classList.remove('hidden');
}

async function submitAssociateProjectForm(event) {
    event.preventDefault();
    const paymentItemId = parseInt(document.getElementById('associate-payment-item-id').value);
    const projectId = parseInt(document.getElementById('associate-project-id').value);
    const notes = document.getElementById('associate-notes').value.trim();

    if (!projectId) { alert('请选择项目'); return; }

    try {
        const res = await fetch('/api/twins/internal_project_payment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                internal_project_id: projectId,
                payment_item_id: paymentItemId,
                association_date: new Date().toISOString().split('T')[0],
                notes: notes || undefined,
            }),
        });
        const result = await res.json();
        if (!result.success) { alert('关联失败: ' + result.error); return; }
        document.getElementById('associate-project-modal').classList.add('hidden');
        await loadAllData();
    } catch (err) { alert('关联失败: ' + err.message); }
}

// ===== 初始化 =====
document.addEventListener('DOMContentLoaded', loadAllData);
</script>
{% endblock %}
