{% extends "base.html" %}

{% block title %}聘用管理 - HRMS{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <div class="mb-6 flex justify-between items-center">
        <div>
            <h2 class="text-2xl font-bold text-gray-900">聘用管理</h2>
            <p class="mt-1 text-sm text-gray-500">根据 Schema 动态渲染的聘用管理信息</p>
        </div>
        <button id="add-employment-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-md shadow-sm">
            + 新增聘用
        </button>
    </div>

    <!-- 过滤器区域 -->
    <div id="filter-section" class="mb-6 bg-white rounded-lg shadow-sm border border-gray-200 p-4">
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-sm font-medium text-gray-700">筛选条件</h3>
            <button id="toggle-filter" class="text-sm text-indigo-600 hover:text-indigo-700">
                <span id="filter-toggle-text">展开</span>
                <svg id="filter-toggle-icon" class="inline-block w-4 h-4 ml-1 transform transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </button>
        </div>
        <div id="filter-content" class="hidden">
            <div id="filter-fields" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- 动态生成过滤器字段 -->
            </div>
            <div class="flex justify-end gap-3 mt-4 pt-4 border-t">
                <button id="reset-filter-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                    重置
                </button>
                <button id="apply-filter-btn" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">
                    应用筛选
                </button>
            </div>
        </div>
    </div>

    <!-- 加载状态 -->
    <div id="loading" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
        <p class="mt-2 text-sm text-gray-500">加载中...</p>
    </div>

    <!-- 错误提示 -->
    <div id="error" class="hidden bg-red-50 border border-red-200 rounded-md p-4 mb-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">加载失败</h3>
                <p id="error-message" class="mt-2 text-sm text-red-700"></p>
            </div>
        </div>
    </div>

    <!-- 聘用管理表格 -->
    <div id="employments-container" class="hidden overflow-x-auto shadow border border-gray-200 md:rounded-lg">
        <table class="min-w-full divide-y divide-gray-300">
            <thead class="bg-gray-50">
                <tr id="table-header">
                    <!-- 动态生成表头 -->
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 bg-white" id="table-body">
                <!-- 动态生成表格行 -->
            </tbody>
        </table>
    </div>

    <!-- 聘用管理详情模态框 -->
    <div id="employment-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" style="background-color: rgba(0,0,0,0.5);">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">聘用详情</h3>
                    <div class="flex items-center gap-2">
                        <button type="button" id="edit-employment-btn" class="text-indigo-600 hover:text-indigo-700 text-sm font-medium hidden">编辑</button>
                        <button id="close-modal" class="text-gray-400 hover:text-gray-500">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                    </div>
                </div>
                
                <div id="employment-detail-content">
                    <!-- 动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 新增/编辑聘用表单模态框 -->
    <div id="employment-form-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" style="background-color: rgba(0,0,0,0.5);">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white max-h-[90vh] overflow-y-auto">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="employment-form-modal-title" class="text-lg font-medium text-gray-900">新增聘用</h3>
                    <button id="close-form-modal" class="text-gray-400 hover:text-gray-500">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <form id="employment-form" class="space-y-4">
                    <div id="employment-form-fields">
                        <!-- 动态生成：人员、公司、职位、部门等 -->
                    </div>
                    <div class="flex justify-end gap-3 pt-4 border-t">
                        <button type="button" id="cancel-employment-form-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">取消</button>
                        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Schema 定义（从后端传递）
const schema = {{ schema | tojson }};

// 编辑时当前聘用记录 id，新增时为 null
let currentEditEmploymentId = null;

// 显示人员的所有聘用记录
async function showPersonEmployments(personId) {
    try {
        // 并行获取人员信息和聘用记录
        const [personResponse, employmentsResponse] = await Promise.all([
            fetch(`/api/twins/person/${personId}`),
            fetch(`/api/twins/person_company_employment?person_id=${personId}&enrich=person,company`)
        ]);
        
        const personResult = await personResponse.json();
        const employmentsResult = await employmentsResponse.json();
        
        if (!personResult.success) {
            alert('加载人员信息失败: ' + personResult.error);
            return;
        }
        if (!employmentsResult.success) {
            alert('加载聘用记录失败: ' + employmentsResult.error);
            return;
        }
        
        const person = personResult.data;
        const employments = employmentsResult.data || [];
        
        // 构建数据对象以兼容原有代码
        const data = {
            person: person.current,
            employments: employments
        };
        const modal = document.getElementById('employment-modal');
        const content = document.getElementById('employment-detail-content');
        
        let html = '<div class="space-y-6">';
        
        // 人员基本信息
        html += '<div>';
        html += '<h4 class="text-md font-semibold text-gray-900 mb-3">人员信息</h4>';
        html += '<div class="bg-gray-50 rounded-lg p-4 space-y-3">';
        html += `<div class="flex">
            <span class="text-sm font-medium text-gray-700 w-32">姓名:</span>
            <span class="text-sm text-gray-900 flex-1">${data.person.name || '-'}</span>
        </div>`;
        html += `<div class="flex">
            <span class="text-sm font-medium text-gray-700 w-32">电话:</span>
            <span class="text-sm text-gray-900 flex-1">${data.person.phone || '-'}</span>
        </div>`;
        html += `<div class="flex">
            <span class="text-sm font-medium text-gray-700 w-32">邮箱:</span>
            <span class="text-sm text-gray-900 flex-1">${data.person.email || '-'}</span>
        </div>`;
        html += '</div></div>';
        
        // 所有聘用记录
        html += '<div>';
        html += '<h4 class="text-md font-semibold text-gray-900 mb-3">聘用记录</h4>';
        
        if (data.employments && data.employments.length > 0) {
            html += '<div class="overflow-x-auto">';
            html += '<table class="min-w-full divide-y divide-gray-200">';
            html += '<thead class="bg-gray-50">';
            html += '<tr>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">公司</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">职位</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">部门</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">员工号</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">员工类别</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">岗位类别</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">职位级别</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">薪资类型</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">薪资</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">变动类型</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">变动日期</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">操作</th>';
            html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            
            // 按变动日期排序（最新的在前）
            const sortedEmployments = [...data.employments].sort((a, b) => {
                const dateA = a.change_date || '';
                const dateB = b.change_date || '';
                return dateB.localeCompare(dateA);
            });
            
            sortedEmployments.forEach(emp => {
                const changeTypeColors = {
                    '入职': 'bg-green-100 text-green-800',
                    '转岗': 'bg-blue-100 text-blue-800',
                    '转公司': 'bg-purple-100 text-purple-800',
                    '离职': 'bg-red-100 text-red-800'
                };
                const colorClass = changeTypeColors[emp.change_type] || 'bg-gray-100 text-gray-800';
                const employeeTypeColors = { '实习': 'bg-amber-100 text-amber-800', '试用': 'bg-sky-100 text-sky-800', '外聘': 'bg-violet-100 text-violet-800', '正式': 'bg-green-100 text-green-800' };
                const positionCategoryColors = { '普通员工': 'bg-slate-100 text-slate-800', '部门负责人': 'bg-indigo-100 text-indigo-800', 'BOSS': 'bg-amber-100 text-amber-800' };
                const jobLevelColors = { '初级': 'bg-teal-100 text-teal-800', '中级': 'bg-blue-100 text-blue-800', '高级': 'bg-purple-100 text-purple-800', '其他': 'bg-gray-100 text-gray-800' };
                
                const empTypeVal = emp.employee_type || '-';
                const empTypeSpan = empTypeVal !== '-' ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${employeeTypeColors[empTypeVal] || 'bg-gray-100 text-gray-800'}">${empTypeVal}</span>` : '-';
                const posCatVal = emp.position_category || '-';
                const posCatSpan = posCatVal !== '-' ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${positionCategoryColors[posCatVal] || 'bg-gray-100 text-gray-800'}">${posCatVal}</span>` : '-';
                const jobLvlVal = emp.job_level || '-';
                const jobLvlSpan = jobLvlVal !== '-' ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${jobLevelColors[jobLvlVal] || 'bg-gray-100 text-gray-800'}">${jobLvlVal}</span>` : '-';
                
                html += '<tr class="hover:bg-gray-50">';
                html += `<td class="px-4 py-3 text-sm text-gray-900">${emp.company_name || '-'}</td>`;
                html += `<td class="px-4 py-3 text-sm text-gray-900">${emp.position || '-'}</td>`;
                html += `<td class="px-4 py-3 text-sm text-gray-900">${emp.department || '-'}</td>`;
                html += `<td class="px-4 py-3 text-sm text-gray-900">${emp.employee_number || '-'}</td>`;
                html += `<td class="px-4 py-3 text-sm">${empTypeSpan}</td>`;
                html += `<td class="px-4 py-3 text-sm">${posCatSpan}</td>`;
                html += `<td class="px-4 py-3 text-sm">${jobLvlSpan}</td>`;
                // 薪资类型
                html += `<td class="px-4 py-3 text-sm text-gray-900">${emp.salary_type || '-'}</td>`;
                // 薪资金额（带单位）
                let salaryDisplay = '-';
                if (emp.salary !== undefined && emp.salary !== null) {
                    const amount = parseFloat(emp.salary);
                    if (!isNaN(amount)) {
                        const type = emp.salary_type || '';
                        if (type === '年薪') {
                            salaryDisplay = `¥${amount.toLocaleString()} / 年`;
                        } else if (type === '月薪') {
                            salaryDisplay = `¥${amount.toLocaleString()} / 月`;
                        } else if (type === '日薪') {
                            salaryDisplay = `¥${amount.toLocaleString()} / 日`;
                        } else {
                            salaryDisplay = `¥${amount.toLocaleString()}`;
                        }
                    }
                }
                html += `<td class="px-4 py-3 text-sm text-gray-900">${salaryDisplay}</td>`;
                html += `<td class="px-4 py-3 text-sm">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${colorClass}">
                        ${emp.change_type || '-'}
                    </span>
                </td>`;
                html += `<td class="px-4 py-3 text-sm text-gray-900">${emp.change_date || '-'}</td>`;
                html += `<td class="px-4 py-3 text-sm"><button type="button" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium" onclick="event.stopPropagation(); showEmploymentDetail(${emp.id}, ${personId})">详情</button></td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
        } else {
            html += '<p class="text-sm text-gray-500">暂无聘用记录</p>';
        }
        
        html += '</div>';
        html += '</div>';
        
        content.innerHTML = html;
        modal.classList.remove('hidden');
    } catch (error) {
        alert('加载失败: ' + error.message);
    }
}

// 单条聘用详情（含历史记录），历史表中展示岗位类别、职位级别并带颜色
async function showEmploymentDetail(employmentId, personId) {
    const modal = document.getElementById('employment-modal');
    const content = document.getElementById('employment-detail-content');
    try {
        const response = await fetch(`/api/twins/person_company_employment/${employmentId}?enrich=person,company`);
        const result = await response.json();
        if (!result.success) {
            alert('加载聘用详情失败: ' + (result.error || '未知错误'));
            return;
        }
        const employment = result.data;
        const current = employment.current || {};
        const history = employment.history || [];
        const employeeTypeColors = { '实习': 'bg-amber-100 text-amber-800', '试用': 'bg-sky-100 text-sky-800', '外聘': 'bg-violet-100 text-violet-800', '正式': 'bg-green-100 text-green-800' };
        const positionCategoryColors = { '普通员工': 'bg-slate-100 text-slate-800', '部门负责人': 'bg-indigo-100 text-indigo-800', 'BOSS': 'bg-amber-100 text-amber-800' };
        const jobLevelColors = { '初级': 'bg-teal-100 text-teal-800', '中级': 'bg-blue-100 text-blue-800', '高级': 'bg-purple-100 text-purple-800', '其他': 'bg-gray-100 text-gray-800' };
        const changeTypeColors = { '入职': 'bg-green-100 text-green-800', '转岗': 'bg-blue-100 text-blue-800', '转公司': 'bg-purple-100 text-purple-800', '离职': 'bg-red-100 text-red-800' };
        function badge(val, colorMap) {
            if (!val || val === '-') return '-';
            const c = colorMap[val] || 'bg-gray-100 text-gray-800';
            return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${c}">${val}</span>`;
        }
        function salaryCell(data) {
            const salary = data.salary;
            const type = data.salary_type || '';
            if (salary === undefined || salary === null) return '-';
            const amount = parseFloat(salary);
            if (isNaN(amount)) return '-';
            if (type === '年薪') return `¥${amount.toLocaleString()} / 年`;
            if (type === '月薪') return `¥${amount.toLocaleString()} / 月`;
            if (type === '日薪') return `¥${amount.toLocaleString()} / 日`;
            return `¥${amount.toLocaleString()}`;
        }
        let html = '<div class="space-y-6">';
        html += '<div class="flex justify-between items-center"><button type="button" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium" onclick="showPersonEmployments(' + personId + ')">← 返回聘用记录</button></div>';
        html += '<div><h4 class="text-md font-semibold text-gray-900 mb-3">当前聘用信息</h4>';
        html += '<div class="bg-gray-50 rounded-lg p-4 space-y-3">';
        html += `<div class="flex"><span class="text-sm font-medium text-gray-700 w-32">公司:</span><span class="text-sm text-gray-900 flex-1">${employment.company_name || current.company_name || '-'}</span></div>`;
        html += `<div class="flex"><span class="text-sm font-medium text-gray-700 w-32">职位:</span><span class="text-sm text-gray-900 flex-1">${current.position || '-'}</span></div>`;
        html += `<div class="flex"><span class="text-sm font-medium text-gray-700 w-32">部门:</span><span class="text-sm text-gray-900 flex-1">${current.department || '-'}</span></div>`;
        html += `<div class="flex"><span class="text-sm font-medium text-gray-700 w-32">员工号:</span><span class="text-sm text-gray-900 flex-1">${current.employee_number || '-'}</span></div>`;
        html += `<div class="flex"><span class="text-sm font-medium text-gray-700 w-32">员工类别:</span><span class="text-sm flex-1">${badge(current.employee_type, employeeTypeColors)}</span></div>`;
        html += `<div class="flex"><span class="text-sm font-medium text-gray-700 w-32">岗位类别:</span><span class="text-sm flex-1">${badge(current.position_category, positionCategoryColors)}</span></div>`;
        html += `<div class="flex"><span class="text-sm font-medium text-gray-700 w-32">职位级别:</span><span class="text-sm flex-1">${badge(current.job_level, jobLevelColors)}</span></div>`;
        html += `<div class="flex"><span class="text-sm font-medium text-gray-700 w-32">薪资类型:</span><span class="text-sm text-gray-900 flex-1">${current.salary_type || '-'}</span></div>`;
        html += `<div class="flex"><span class="text-sm font-medium text-gray-700 w-32">薪资:</span><span class="text-sm text-gray-900 flex-1">${salaryCell(current)}</span></div>`;
        html += `<div class="flex"><span class="text-sm font-medium text-gray-700 w-32">变动类型:</span><span class="text-sm flex-1">${badge(current.change_type, changeTypeColors)}</span></div>`;
        html += `<div class="flex"><span class="text-sm font-medium text-gray-700 w-32">变动日期:</span><span class="text-sm text-gray-900 flex-1">${current.change_date || '-'}</span></div>`;
        html += '</div></div>';
        // 历史记录表（含岗位类别、职位级别及颜色）
        if (history.length > 0) {
            html += '<div><h4 class="text-md font-semibold text-gray-900 mb-3">历史记录</h4>';
            html += '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200">';
            html += '<thead class="bg-gray-50"><tr>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">版本</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">时间</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">职位</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">部门</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">员工号</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">员工类别</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">岗位类别</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">职位级别</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">薪资类型</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">薪资</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">变动类型</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">变动日期</th>';
            html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            history.forEach(record => {
                const d = record.data || {};
                html += '<tr class="hover:bg-gray-50">';
                html += `<td class="px-4 py-3 text-sm text-gray-900">${record.version ?? record.time_key ?? '-'}</td>`;
                html += `<td class="px-4 py-3 text-sm text-gray-500">${record.ts ? new Date(record.ts).toLocaleString() : '-'}</td>`;
                html += `<td class="px-4 py-3 text-sm text-gray-900">${d.position || '-'}</td>`;
                html += `<td class="px-4 py-3 text-sm text-gray-900">${d.department || '-'}</td>`;
                html += `<td class="px-4 py-3 text-sm text-gray-900">${d.employee_number || '-'}</td>`;
                html += `<td class="px-4 py-3 text-sm">${badge(d.employee_type, employeeTypeColors)}</td>`;
                html += `<td class="px-4 py-3 text-sm">${badge(d.position_category, positionCategoryColors)}</td>`;
                html += `<td class="px-4 py-3 text-sm">${badge(d.job_level, jobLevelColors)}</td>`;
                html += `<td class="px-4 py-3 text-sm text-gray-900">${d.salary_type || '-'}</td>`;
                html += `<td class="px-4 py-3 text-sm text-gray-900">${salaryCell(d)}</td>`;
                html += `<td class="px-4 py-3 text-sm">${badge(d.change_type, changeTypeColors)}</td>`;
                html += `<td class="px-4 py-3 text-sm text-gray-900">${d.change_date || '-'}</td>`;
                html += '</tr>';
            });
            html += '</tbody></table></div></div>';
        }
        html += '</div>';
        content.innerHTML = html;
        const editBtn = document.getElementById('edit-employment-btn');
        if (editBtn) {
            editBtn.classList.remove('hidden');
            editBtn.onclick = () => {
                modal.classList.add('hidden');
                openEditEmploymentForm(employmentId, personId);
            };
        }
        modal.classList.remove('hidden');
    } catch (error) {
        alert('加载失败: ' + error.message);
    }
}

// 关闭模态框
document.getElementById('close-modal').onclick = () => {
    document.getElementById('employment-modal').classList.add('hidden');
    const editBtn = document.getElementById('edit-employment-btn');
    if (editBtn) editBtn.classList.add('hidden');
};

// 渲染聘用表单字段 HTML（新增时 initialData 为 null，编辑时传入当前数据）
function buildEmploymentFormHtml(persons, companies, initialData) {
    const fields = schema.fields || {};
    let html = '';
    html += '<div><label class="block text-sm font-medium text-gray-700 mb-1">人员 <span class="text-red-500">*</span></label>';
    html += '<select name="person_id" required class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">';
    html += '<option value="">请选择人员</option>';
    const selPersonId = initialData && initialData.person_id != null ? String(initialData.person_id) : '';
    persons.forEach(p => {
        const name = p.name || p.current?.name || `#${p.id}`;
        const sel = String(p.id) === selPersonId ? ' selected' : '';
        html += `<option value="${p.id}"${sel}>${name}</option>`;
    });
    html += '</select></div>';
    html += '<div><label class="block text-sm font-medium text-gray-700 mb-1">公司 <span class="text-red-500">*</span></label>';
    html += '<select name="company_id" required class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">';
    html += '<option value="">请选择公司</option>';
    const selCompanyId = initialData && initialData.company_id != null ? String(initialData.company_id) : '';
    companies.forEach(c => {
        const name = c.name || c.current?.name || `#${c.id}`;
        const sel = String(c.id) === selCompanyId ? ' selected' : '';
        html += `<option value="${c.id}"${sel}>${name}</option>`;
    });
    html += '</select></div>';
    const fieldNames = Object.keys(fields).filter(k => {
        const fd = fields[k];
        return fd && k !== 'person_id' && k !== 'company_id' && fd.type !== 'reference';
    });
    for (const key of fieldNames) {
        const fd = fields[key];
        if (!fd) continue;
        const label = fd.label || key;
        const required = fd.required ? ' <span class="text-red-500">*</span>' : '';
        const baseClass = 'block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500';
        const val = initialData && key in initialData ? initialData[key] : '';
        const esc = (v) => (v == null ? '' : String(v).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;'));
        if (fd.type === 'enum' && fd.options) {
            html += `<div><label class="block text-sm font-medium text-gray-700 mb-1">${label}${required}</label>`;
            html += `<select name="${key}" ${fd.required ? 'required' : ''} class="${baseClass}">`;
            html += '<option value="">请选择</option>';
            fd.options.forEach(opt => { html += `<option value="${opt}"${val === opt ? ' selected' : ''}>${opt}</option>`; });
            html += '</select></div>';
        } else if (fd.type === 'date') {
            html += `<div><label class="block text-sm font-medium text-gray-700 mb-1">${label}${required}</label>`;
            html += `<input type="date" name="${key}" ${fd.required ? 'required' : ''} value="${esc(val)}" class="${baseClass}">`;
            html += '</div>';
        } else if (fd.type === 'decimal' || fd.type === 'number') {
            html += `<div><label class="block text-sm font-medium text-gray-700 mb-1">${label}${required}</label>`;
            html += `<input type="number" step="any" name="${key}" ${fd.required ? 'required' : ''} value="${esc(val)}" class="${baseClass}" placeholder="${fd.suffix || ''}">`;
            html += '</div>';
        } else {
            html += `<div><label class="block text-sm font-medium text-gray-700 mb-1">${label}${required}</label>`;
            html += `<input type="text" name="${key}" ${fd.required ? 'required' : ''} value="${esc(val)}" class="${baseClass}">`;
            html += '</div>';
        }
    }
    return html;
}

// 新增聘用：打开表单并拉取人员、公司列表
async function openAddEmploymentForm() {
    currentEditEmploymentId = null;
    const titleEl = document.getElementById('employment-form-modal-title');
    if (titleEl) titleEl.textContent = '新增聘用';
    const container = document.getElementById('employment-form-fields');
    const formModal = document.getElementById('employment-form-modal');
    if (!container || !formModal) return;
    container.innerHTML = '<p class="text-sm text-gray-500">加载中...</p>';
    formModal.classList.remove('hidden');
    try {
        const [personsRes, companiesRes] = await Promise.all([
            fetch('/api/twins/person'),
            fetch('/api/config/companies')
        ]);
        const personsData = await personsRes.json();
        const companiesData = await companiesRes.json();
        if (!personsData.success || !companiesData.success) {
            if (container) container.innerHTML = '<p class="text-sm text-red-600">加载人员或公司列表失败</p>';
            return;
        }
        const persons = personsData.data || [];
        const companies = companiesData.data || [];
        if (container) container.innerHTML = buildEmploymentFormHtml(persons, companies, null);
    } catch (e) {
        if (container) container.innerHTML = '<p class="text-sm text-red-600">加载失败: ' + (e.message || '') + '</p>';
    }
}

// 编辑聘用：打开表单并预填当前数据
async function openEditEmploymentForm(employmentId, personId) {
    currentEditEmploymentId = employmentId;
    const titleEl = document.getElementById('employment-form-modal-title');
    if (titleEl) titleEl.textContent = '编辑聘用';
    const container = document.getElementById('employment-form-fields');
    const formModal = document.getElementById('employment-form-modal');
    if (!container || !formModal) return;
    container.innerHTML = '<p class="text-sm text-gray-500">加载中...</p>';
    formModal.classList.remove('hidden');
    try {
        const [employmentRes, personsRes, companiesRes] = await Promise.all([
            fetch(`/api/twins/person_company_employment/${employmentId}`),
            fetch('/api/twins/person'),
            fetch('/api/config/companies')
        ]);
        const employmentData = await employmentRes.json();
        const personsData = await personsRes.json();
        const companiesData = await companiesRes.json();
        if (!employmentData.success || !personsData.success || !companiesData.success) {
            if (container) container.innerHTML = '<p class="text-sm text-red-600">加载数据失败</p>';
            return;
        }
        const employment = employmentData.data;
        const current = employment.current || {};
        const initialData = {
            person_id: employment.person_id != null ? employment.person_id : personId,
            company_id: employment.company_id,
            position: current.position,
            department: current.department,
            employee_number: current.employee_number,
            employee_type: current.employee_type,
            position_category: current.position_category,
            job_level: current.job_level,
            salary_type: current.salary_type,
            salary: current.salary,
            change_type: current.change_type,
            change_date: current.change_date
        };
        const persons = personsData.data || [];
        const companies = companiesData.data || [];
        if (container) container.innerHTML = buildEmploymentFormHtml(persons, companies, initialData);
    } catch (e) {
        if (container) container.innerHTML = '<p class="text-sm text-red-600">加载失败: ' + (e.message || '') + '</p>';
    }
}

function closeEmploymentFormModal() {
    currentEditEmploymentId = null;
    const titleEl = document.getElementById('employment-form-modal-title');
    if (titleEl) titleEl.textContent = '新增聘用';
    document.getElementById('employment-form-modal').classList.add('hidden');
}

// 提交新增聘用
document.getElementById('add-employment-btn').onclick = openAddEmploymentForm;
document.getElementById('close-form-modal').onclick = closeEmploymentFormModal;
document.getElementById('cancel-employment-form-btn').onclick = closeEmploymentFormModal;

document.getElementById('employment-form').onsubmit = async function(e) {
    e.preventDefault();
    const form = e.target;
    const fd = new FormData(form);
    const body = {};
    for (const [k, v] of fd.entries()) {
        if (v === '') continue;
        if (k === 'salary') body[k] = parseFloat(v) || null;
        else body[k] = v;
    }
    try {
        const url = currentEditEmploymentId
            ? `/api/twins/person_company_employment/${currentEditEmploymentId}`
            : '/api/twins/person_company_employment';
        const method = currentEditEmploymentId ? 'PUT' : 'POST';
        const res = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const result = await res.json();
        if (!result.success) {
            alert('保存失败: ' + (result.error || '未知错误'));
            return;
        }
        currentEditEmploymentId = null;
        closeEmploymentFormModal();
        loadEmployments();
    } catch (err) {
        alert('保存失败: ' + (err.message || ''));
    }
};

// 渲染表格
function renderTable(employments) {
    const headerRow = document.getElementById('table-header');
    const tbody = document.getElementById('table-body');
    
    // 清空
    headerRow.innerHTML = '';
    tbody.innerHTML = '';
    
    // 定义表格列（只显示聘用管理相关信息，人员联系方式在详情中显示）
    const columns = [
        { key: 'person_name', label: '姓名', type: 'person' },
        { key: 'company_name', label: '公司', type: 'company' },
        { key: 'position', label: '职位', type: 'employment' },
        { key: 'department', label: '部门', type: 'employment' },
        { key: 'employee_number', label: '员工号', type: 'employment' },
        { key: 'employee_type', label: '员工类别', type: 'employment' },
        { key: 'position_category', label: '岗位类别', type: 'employment' },
        { key: 'job_level', label: '职位级别', type: 'employment' },
        { key: 'salary_type', label: '薪资类型', type: 'employment' },
        { key: 'salary', label: '薪资', type: 'employment' },
        { key: 'change_type', label: '变动类型', type: 'employment' },
        { key: 'change_date', label: '变动日期', type: 'employment' },
    ];
    
    // 生成表头
    columns.forEach(col => {
        const th = document.createElement('th');
        th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
        th.textContent = col.label;
        headerRow.appendChild(th);
    });
    
    // 按 person_id 分组，只保留最新的聘用记录
    const employmentByPerson = {};
    employments.forEach(emp => {
        const personId = emp.person_id;
        if (!personId) return;
        
        if (!employmentByPerson[personId]) {
            employmentByPerson[personId] = emp;
        } else {
            // 比较 change_date，保留最新的
            const currentDate = employmentByPerson[personId].change_date || '';
            const newDate = emp.change_date || '';
            if (newDate > currentDate) {
                employmentByPerson[personId] = emp;
            }
        }
    });
    
    // 转换为数组并排序（按姓名）
    const sortedEmployments = Object.values(employmentByPerson).sort((a, b) => {
        const nameA = a.person_name || '';
        const nameB = b.person_name || '';
        return nameA.localeCompare(nameB, 'zh-CN');
    });
    
    // 生成表格行
    sortedEmployments.forEach(emp => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50 cursor-pointer';
        tr.onclick = () => showPersonEmployments(emp.person_id);
        
        columns.forEach(col => {
            const td = document.createElement('td');
            td.className = 'whitespace-nowrap px-6 py-4 text-sm text-gray-900';
            
            let value = emp[col.key] || '';
            
            // 特殊处理：员工类别、岗位类别、职位级别、变动类型（添加颜色标签）
            if (col.key === 'employee_type' && value) {
                const colors = { '实习': 'bg-amber-100 text-amber-800', '试用': 'bg-sky-100 text-sky-800', '外聘': 'bg-violet-100 text-violet-800', '正式': 'bg-green-100 text-green-800' };
                const colorClass = colors[value] || 'bg-gray-100 text-gray-800';
                td.innerHTML = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${colorClass}">${value}</span>`;
            } else if (col.key === 'position_category' && value) {
                const colors = { '普通员工': 'bg-slate-100 text-slate-800', '部门负责人': 'bg-indigo-100 text-indigo-800', 'BOSS': 'bg-amber-100 text-amber-800' };
                const colorClass = colors[value] || 'bg-gray-100 text-gray-800';
                td.innerHTML = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${colorClass}">${value}</span>`;
            } else if (col.key === 'job_level' && value) {
                const colors = { '初级': 'bg-teal-100 text-teal-800', '中级': 'bg-blue-100 text-blue-800', '高级': 'bg-purple-100 text-purple-800', '其他': 'bg-gray-100 text-gray-800' };
                const colorClass = colors[value] || 'bg-gray-100 text-gray-800';
                td.innerHTML = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${colorClass}">${value}</span>`;
            } else if (col.key === 'change_type' && value) {
                const changeTypeColors = {
                    '入职': 'bg-green-100 text-green-800',
                    '转岗': 'bg-blue-100 text-blue-800',
                    '转公司': 'bg-purple-100 text-purple-800',
                    '离职': 'bg-red-100 text-red-800'
                };
                const colorClass = changeTypeColors[value] || 'bg-gray-100 text-gray-800';
                td.innerHTML = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${colorClass}">${value}</span>`;
            } else if (col.key === 'salary') {
                // 薪资金额（带单位）
                let salaryDisplay = '-';
                if (emp.salary !== undefined && emp.salary !== null) {
                    const amount = parseFloat(emp.salary);
                    if (!isNaN(amount)) {
                        const type = emp.salary_type || '';
                        if (type === '年薪') {
                            salaryDisplay = `¥${amount.toLocaleString()} / 年`;
                        } else if (type === '月薪') {
                            salaryDisplay = `¥${amount.toLocaleString()} / 月`;
                        } else if (type === '日薪') {
                            salaryDisplay = `¥${amount.toLocaleString()} / 日`;
                        } else {
                            salaryDisplay = `¥${amount.toLocaleString()}`;
                        }
                    }
                }
                td.textContent = salaryDisplay;
            } else {
                td.textContent = value || '-';
            }
            
            tr.appendChild(td);
        });
        
        tbody.appendChild(tr);
    });
}

// 当前过滤条件
let currentFilters = {};

// 基于 Schema 动态渲染过滤器字段
function renderFilterFields() {
    const fields = schema.fields || {};
    const filterFields = document.getElementById('filter-fields');
    filterFields.innerHTML = '';
    
    // 定义适合过滤的字段（排除 reference 类型和不需要过滤的字段）
    const filterableFields = {
        'person_name': { label: '姓名', type: 'text' },
        'company_name': { label: '公司', type: 'text' },
        'position': { label: '职位', type: 'text' },
        'department': { label: '部门', type: 'text' },
        'employee_type': { label: '员工类别', type: 'select', options: ['实习', '试用', '外聘', '正式'] },
        'position_category': { label: '岗位类别', type: 'select', options: ['普通员工', '部门负责人', 'BOSS'] },
        'job_level': { label: '职位级别', type: 'select', options: ['初级', '中级', '高级', '其他'] },
        'change_type': { label: '变动类型', type: 'select', options: ['入职', '转岗', '调部门', '转公司', '停薪留职', '返岗', '离职'] }
    };
    
    // 使用 Object.keys() 确保按照 schema 定义的顺序遍历
    const fieldNames = Object.keys(filterableFields);
    for (const fieldName of fieldNames) {
        const fieldConfig = filterableFields[fieldName];
        const label = fieldConfig.label || fieldName;
        const value = currentFilters[fieldName] || '';
        
        let fieldHtml = '<div class="flex flex-col">';
        fieldHtml += `<label for="filter-${fieldName}" class="text-sm font-medium text-gray-700 mb-1">${label}</label>`;
        
        if (fieldConfig.type === 'select') {
            fieldHtml += `<select id="filter-${fieldName}" name="${fieldName}" class="px-3 py-2 bg-white border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 hover:border-gray-400 transition-colors">`;
            fieldHtml += `<option value="">全部</option>`;
            fieldConfig.options.forEach(option => {
                const selected = value === option ? 'selected' : '';
                fieldHtml += `<option value="${option}" ${selected}>${option}</option>`;
            });
            fieldHtml += '</select>';
        } else {
            fieldHtml += `<input type="text" id="filter-${fieldName}" name="${fieldName}" value="${value}" placeholder="请输入${label}" class="px-3 py-2 bg-white border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 hover:border-gray-400 transition-colors">`;
        }
        
        fieldHtml += '</div>';
        filterFields.innerHTML += fieldHtml;
    }
}

// 应用筛选
function applyFilters() {
    const filterFields = document.getElementById('filter-fields');
    const filters = {};
    
    // 收集所有过滤字段的值
    filterFields.querySelectorAll('input, select').forEach(input => {
        const value = input.value.trim();
        if (value) {
            filters[input.name] = value;
        }
    });
    
    currentFilters = filters;
    loadEmployments(filters);
}

// 重置筛选
function resetFilters() {
    currentFilters = {};
    renderFilterFields();
    loadEmployments();
}

// 加载聘用管理（表格形式）
async function loadEmployments(filters = {}) {
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const container = document.getElementById('employments-container');
    
    try {
        // 构建查询参数
        const params = new URLSearchParams();
        params.append('enrich', 'true');
        
        // 添加过滤条件
        for (const [key, value] of Object.entries(filters)) {
            if (value) {
                params.append(key, value);
            }
        }
        
        const response = await fetch(`/api/twins/person_company_employment?${params.toString()}`);
        const result = await response.json();
        
        loading.classList.add('hidden');
        
        if (!result.success) {
            error.classList.remove('hidden');
            document.getElementById('error-message').textContent = result.error;
            return;
        }
        
        error.classList.add('hidden');
        container.classList.remove('hidden');
        
        // 渲染表格
        if (result.data && result.data.length > 0) {
            renderTable(result.data);
        } else {
            container.innerHTML = '<div class="text-center py-12 text-gray-500">暂无数据</div>';
        }
    } catch (err) {
        loading.classList.add('hidden');
        error.classList.remove('hidden');
        document.getElementById('error-message').textContent = err.message;
    }
}

// 切换过滤器显示/隐藏
document.getElementById('toggle-filter').onclick = () => {
    const content = document.getElementById('filter-content');
    const icon = document.getElementById('filter-toggle-icon');
    const text = document.getElementById('filter-toggle-text');
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.classList.add('rotate-180');
        text.textContent = '收起';
    } else {
        content.classList.add('hidden');
        icon.classList.remove('rotate-180');
        text.textContent = '展开';
    }
};

// 应用筛选按钮
document.getElementById('apply-filter-btn').onclick = applyFilters;

// 重置筛选按钮
document.getElementById('reset-filter-btn').onclick = resetFilters;

// 过滤器输入框支持回车键应用
document.addEventListener('DOMContentLoaded', () => {
    // 初始化过滤器字段
    renderFilterFields();
    
    // 为过滤器输入框添加回车键事件
    const filterFields = document.getElementById('filter-fields');
    if (filterFields) {
        filterFields.addEventListener('keypress', (e) => {
            if (e.target.tagName === 'INPUT' && e.key === 'Enter') {
                e.preventDefault();
                applyFilters();
            }
        });
    }
    
    // 页面加载时获取数据
    loadEmployments();
});
</script>
{% endblock %}
