{% extends "base.html" %}

{% block title %}雇佣关系管理 - HRMS{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-900">雇佣关系列表</h2>
        <p class="mt-1 text-sm text-gray-500">根据 Schema 动态渲染的雇佣关系信息</p>
    </div>

    <!-- 加载状态 -->
    <div id="loading" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
        <p class="mt-2 text-sm text-gray-500">加载中...</p>
    </div>

    <!-- 错误提示 -->
    <div id="error" class="hidden bg-red-50 border border-red-200 rounded-md p-4 mb-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">加载失败</h3>
                <p id="error-message" class="mt-2 text-sm text-red-700"></p>
            </div>
        </div>
    </div>

    <!-- 雇佣关系表格 -->
    <div id="employments-container" class="hidden overflow-x-auto shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
        <table class="min-w-full divide-y divide-gray-300">
            <thead class="bg-gray-50">
                <tr id="table-header">
                    <!-- 动态生成表头 -->
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 bg-white" id="table-body">
                <!-- 动态生成表格行 -->
            </tbody>
        </table>
    </div>

    <!-- 雇佣关系详情模态框 -->
    <div id="employment-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">雇佣关系详情</h3>
                    <button id="close-modal" class="text-gray-400 hover:text-gray-500">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                
                <div id="employment-detail-content">
                    <!-- 动态生成 -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Schema 定义（从后端传递）
const schema = {{ schema | tojson }};

// 显示人员的所有雇佣关系
async function showPersonEmployments(personId) {
    try {
        const response = await fetch(`/api/persons/${personId}/employments`);
        const result = await response.json();
        
        if (!result.success) {
            alert('加载失败: ' + result.error);
            return;
        }
        
        const data = result.data;
        const modal = document.getElementById('employment-modal');
        const content = document.getElementById('employment-detail-content');
        
        let html = '<div class="space-y-6">';
        
        // 人员基本信息
        html += '<div>';
        html += '<h4 class="text-md font-semibold text-gray-900 mb-3">人员信息</h4>';
        html += '<div class="bg-gray-50 rounded-lg p-4 space-y-3">';
        html += `<div class="flex">
            <span class="text-sm font-medium text-gray-700 w-32">姓名:</span>
            <span class="text-sm text-gray-900 flex-1">${data.person.name || '-'}</span>
        </div>`;
        html += `<div class="flex">
            <span class="text-sm font-medium text-gray-700 w-32">电话:</span>
            <span class="text-sm text-gray-900 flex-1">${data.person.phone || '-'}</span>
        </div>`;
        html += `<div class="flex">
            <span class="text-sm font-medium text-gray-700 w-32">邮箱:</span>
            <span class="text-sm text-gray-900 flex-1">${data.person.email || '-'}</span>
        </div>`;
        html += '</div></div>';
        
        // 所有雇佣记录
        html += '<div>';
        html += '<h4 class="text-md font-semibold text-gray-900 mb-3">雇佣记录</h4>';
        
        if (data.employments && data.employments.length > 0) {
            html += '<div class="overflow-x-auto">';
            html += '<table class="min-w-full divide-y divide-gray-200">';
            html += '<thead class="bg-gray-50">';
            html += '<tr>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">公司</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">职位</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">部门</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">员工号</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">员工类别</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">变动类型</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">变动日期</th>';
            html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            
            // 按变动日期排序（最新的在前）
            const sortedEmployments = [...data.employments].sort((a, b) => {
                const dateA = a.change_date || '';
                const dateB = b.change_date || '';
                return dateB.localeCompare(dateA);
            });
            
            sortedEmployments.forEach(emp => {
                const changeTypeColors = {
                    '入职': 'bg-green-100 text-green-800',
                    '转岗': 'bg-blue-100 text-blue-800',
                    '转公司': 'bg-purple-100 text-purple-800',
                    '离职': 'bg-red-100 text-red-800'
                };
                const colorClass = changeTypeColors[emp.change_type] || 'bg-gray-100 text-gray-800';
                
                html += '<tr class="hover:bg-gray-50">';
                html += `<td class="px-4 py-3 text-sm text-gray-900">${emp.company_name || '-'}</td>`;
                html += `<td class="px-4 py-3 text-sm text-gray-900">${emp.position || '-'}</td>`;
                html += `<td class="px-4 py-3 text-sm text-gray-900">${emp.department || '-'}</td>`;
                html += `<td class="px-4 py-3 text-sm text-gray-900">${emp.employee_number || '-'}</td>`;
                html += `<td class="px-4 py-3 text-sm text-gray-900">${emp.employee_type || '-'}</td>`;
                html += `<td class="px-4 py-3 text-sm">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${colorClass}">
                        ${emp.change_type || '-'}
                    </span>
                </td>`;
                html += `<td class="px-4 py-3 text-sm text-gray-900">${emp.change_date || '-'}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
        } else {
            html += '<p class="text-sm text-gray-500">暂无雇佣记录</p>';
        }
        
        html += '</div>';
        html += '</div>';
        
        content.innerHTML = html;
        modal.classList.remove('hidden');
    } catch (error) {
        alert('加载失败: ' + error.message);
    }
}

// 关闭模态框
document.getElementById('close-modal').onclick = () => {
    document.getElementById('employment-modal').classList.add('hidden');
};

// 渲染表格
function renderTable(employments) {
    const headerRow = document.getElementById('table-header');
    const tbody = document.getElementById('table-body');
    
    // 清空
    headerRow.innerHTML = '';
    tbody.innerHTML = '';
    
    // 定义表格列（只显示雇佣关系相关信息，人员联系方式在详情中显示）
    const columns = [
        { key: 'person_name', label: '姓名', type: 'person' },
        { key: 'company_name', label: '公司', type: 'company' },
        { key: 'position', label: '职位', type: 'employment' },
        { key: 'department', label: '部门', type: 'employment' },
        { key: 'employee_number', label: '员工号', type: 'employment' },
        { key: 'employee_type', label: '员工类别', type: 'employment' },
        { key: 'change_type', label: '变动类型', type: 'employment' },
        { key: 'change_date', label: '变动日期', type: 'employment' },
    ];
    
    // 生成表头
    columns.forEach(col => {
        const th = document.createElement('th');
        th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
        th.textContent = col.label;
        headerRow.appendChild(th);
    });
    
    // 按 person_id 分组，只保留最新的雇佣关系
    const employmentByPerson = {};
    employments.forEach(emp => {
        const personId = emp.person_id;
        if (!personId) return;
        
        if (!employmentByPerson[personId]) {
            employmentByPerson[personId] = emp;
        } else {
            // 比较 change_date，保留最新的
            const currentDate = employmentByPerson[personId].change_date || '';
            const newDate = emp.change_date || '';
            if (newDate > currentDate) {
                employmentByPerson[personId] = emp;
            }
        }
    });
    
    // 转换为数组并排序（按姓名）
    const sortedEmployments = Object.values(employmentByPerson).sort((a, b) => {
        const nameA = a.person_name || '';
        const nameB = b.person_name || '';
        return nameA.localeCompare(nameB, 'zh-CN');
    });
    
    // 生成表格行
    sortedEmployments.forEach(emp => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50 cursor-pointer';
        tr.onclick = () => showPersonEmployments(emp.person_id);
        
        columns.forEach(col => {
            const td = document.createElement('td');
            td.className = 'whitespace-nowrap px-6 py-4 text-sm text-gray-900';
            
            let value = emp[col.key] || '';
            
            // 特殊处理变动类型（添加颜色标签）
            if (col.key === 'change_type' && value) {
                const changeTypeColors = {
                    '入职': 'bg-green-100 text-green-800',
                    '转岗': 'bg-blue-100 text-blue-800',
                    '转公司': 'bg-purple-100 text-purple-800',
                    '离职': 'bg-red-100 text-red-800'
                };
                const colorClass = changeTypeColors[value] || 'bg-gray-100 text-gray-800';
                td.innerHTML = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${colorClass}">${value}</span>`;
            } else {
                td.textContent = value || '-';
            }
            
            tr.appendChild(td);
        });
        
        tbody.appendChild(tr);
    });
}

// 加载雇佣关系列表（表格形式）
async function loadEmployments() {
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const container = document.getElementById('employments-container');
    
    try {
        const response = await fetch('/api/twins/person_company_employment?enrich=true');
        const result = await response.json();
        
        loading.classList.add('hidden');
        
        if (!result.success) {
            error.classList.remove('hidden');
            document.getElementById('error-message').textContent = result.error;
            return;
        }
        
        error.classList.add('hidden');
        container.classList.remove('hidden');
        
        // 渲染表格
        if (result.data && result.data.length > 0) {
            renderTable(result.data);
        } else {
            container.innerHTML = '<div class="text-center py-12 text-gray-500">暂无数据</div>';
        }
    } catch (err) {
        loading.classList.add('hidden');
        error.classList.remove('hidden');
        document.getElementById('error-message').textContent = err.message;
    }
}

// 页面加载时获取数据
window.addEventListener('DOMContentLoaded', loadEmployments);
</script>
{% endblock %}
