{% extends "base.html" %}

{% block title %}订单管理 - HRMS{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <div class="mb-6 flex justify-between items-center">
        <div>
            <h2 class="text-2xl font-bold text-gray-900">订单管理</h2>
            <p class="mt-1 text-sm text-gray-500">订单列表、从合同拆分订单、内部项目关联订单</p>
        </div>
        <button id="split-order-btn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md shadow-sm">
            + 从合同拆分订单
        </button>
    </div>

    <!-- Tab 导航 -->
    <div class="border-b border-gray-200 mb-6">
        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
            <button id="tab-orders" class="tab-button border-indigo-500 text-indigo-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                订单列表
            </button>
            <button id="tab-project-orders" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                项目关联订单
            </button>
        </nav>
    </div>

    <!-- Tab 内容：订单列表 -->
    <div id="tab-content-orders" class="tab-content">
        <!-- 加载状态 -->
        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
            <p class="mt-2 text-sm text-gray-500">加载中...</p>
        </div>

        <!-- 错误提示 -->
        <div id="error" class="hidden bg-red-50 border border-red-200 rounded-md p-4 mb-4">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">加载失败</h3>
                    <p id="error-message" class="mt-2 text-sm text-red-700"></p>
                </div>
            </div>
        </div>

        <!-- 订单表格 -->
        <div id="orders-container" class="hidden overflow-x-auto shadow border border-gray-200 md:rounded-lg">
            <table class="min-w-full divide-y divide-gray-300">
                <thead class="bg-gray-50">
                    <tr id="table-header">
                        <!-- 动态生成表头 -->
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 bg-white" id="table-body">
                    <!-- 动态生成表格行 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Tab 内容：项目关联订单 -->
    <div id="tab-content-project-orders" class="tab-content hidden">
        <!-- 加载状态 -->
        <div id="loading-project-orders" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
            <p class="mt-2 text-sm text-gray-500">加载中...</p>
        </div>

        <!-- 三栏关系展示 -->
        <div id="project-orders-container" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- 内部项目栏 -->
                <div class="bg-white rounded-lg shadow border border-gray-200">
                    <div class="px-4 py-3 bg-gray-50 border-b border-gray-200 rounded-t-lg">
                        <h3 class="text-sm font-semibold text-gray-900">内部项目</h3>
                    </div>
                    <div id="projects-column" class="divide-y divide-gray-200 max-h-[600px] overflow-y-auto">
                        <!-- 动态生成项目卡片 -->
                    </div>
                </div>

                <!-- 订单栏 -->
                <div class="bg-white rounded-lg shadow border border-gray-200">
                    <div class="px-4 py-3 bg-gray-50 border-b border-gray-200 rounded-t-lg">
                        <h3 class="text-sm font-semibold text-gray-900">订单</h3>
                    </div>
                    <div id="orders-column" class="divide-y divide-gray-200 max-h-[600px] overflow-y-auto">
                        <!-- 动态生成订单卡片 -->
                    </div>
                </div>

                <!-- 客户合同栏 -->
                <div class="bg-white rounded-lg shadow border border-gray-200">
                    <div class="px-4 py-3 bg-gray-50 border-b border-gray-200 rounded-t-lg">
                        <h3 class="text-sm font-semibold text-gray-900">客户合同</h3>
                    </div>
                    <div id="contracts-column" class="divide-y divide-gray-200 max-h-[600px] overflow-y-auto">
                        <!-- 动态生成合同卡片 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 订单详情模态框 -->
    <div id="order-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" style="background-color: rgba(0,0,0,0.5);">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">订单详情</h3>
                    <div class="flex gap-2">
                        <button id="edit-order-btn" class="text-indigo-600 hover:text-indigo-700 text-sm font-medium">
                            编辑
                        </button>
                        <button id="associate-project-btn" class="text-green-600 hover:text-green-700 text-sm font-medium">
                            关联项目
                        </button>
                        <button id="associate-person-btn" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                            关联人员
                        </button>
                        <button id="close-modal" class="text-gray-400 hover:text-gray-500">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div id="order-detail-content">
                    <!-- 动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 从合同拆分订单模态框 -->
    <div id="split-order-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" style="background-color: rgba(0,0,0,0.5);">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">从合同拆分订单</h3>
                    <button id="close-split-modal" class="text-gray-400 hover:text-gray-500">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                
                <form id="split-order-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start py-2">
                        <div class="md:col-span-1">
                            <label for="split-contract-id" class="block text-sm font-medium text-gray-700 pt-2 text-right">客户合同 <span class="text-red-500">*</span></label>
                        </div>
                        <div class="md:col-span-2">
                            <select id="split-contract-id" name="client_contract_id" required class="block w-full px-3 py-2 bg-white border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">请选择合同</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="split-order-form-fields">
                        <!-- 动态生成订单表单字段 -->
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start py-2">
                        <div class="md:col-span-1">
                            <label for="split-reason" class="block text-sm font-medium text-gray-700 pt-2 text-right">拆分原因</label>
                        </div>
                        <div class="md:col-span-2">
                            <textarea id="split-reason" name="split_reason" rows="3" class="block w-full px-3 py-2 bg-white border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="请输入拆分原因"></textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end gap-3 pt-4 border-t">
                        <button type="button" id="cancel-split-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                            取消
                        </button>
                        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700">
                            创建订单
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 关联人员模态框 -->
    <div id="associate-person-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" style="background-color: rgba(0,0,0,0.5);">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">关联人员到订单</h3>
                    <button id="close-associate-person-modal" class="text-gray-400 hover:text-gray-500">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                
                <form id="associate-person-form" class="space-y-4">
                    <input type="hidden" id="associate-person-order-id" name="order_id">
                    <input type="hidden" id="associate-person-activity-id" name="activity_id">
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start py-2">
                        <div class="md:col-span-1">
                            <label for="associate-person-person-id" class="block text-sm font-medium text-gray-700 pt-2 text-right">人员 <span class="text-red-500">*</span></label>
                        </div>
                        <div class="md:col-span-2">
                            <select id="associate-person-person-id" name="person_id" required class="block w-full px-3 py-2 bg-white border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">请选择人员</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start py-2">
                        <div class="md:col-span-1">
                            <label for="associate-person-participation-type" class="block text-sm font-medium text-gray-700 pt-2 text-right">参与类型 <span class="text-red-500">*</span></label>
                        </div>
                        <div class="md:col-span-2">
                            <select id="associate-person-participation-type" name="participation_type" required class="block w-full px-3 py-2 bg-white border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">请选择</option>
                                <option value="实际参加">实际参加</option>
                                <option value="名义参加">名义参加</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 劳务订单相关字段（根据订单类型和参与类型动态显示） -->
                    <div id="labor-order-fields" class="hidden space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start py-2">
                            <div class="md:col-span-1">
                                <label for="associate-person-start-date" class="block text-sm font-medium text-gray-700 pt-2 text-right">开始时间</label>
                            </div>
                            <div class="md:col-span-2">
                                <input type="date" id="associate-person-start-date" name="start_date" class="block w-full px-3 py-2 bg-white border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start py-2">
                            <div class="md:col-span-1">
                                <label for="associate-person-end-date" class="block text-sm font-medium text-gray-700 pt-2 text-right">结束时间</label>
                            </div>
                            <div class="md:col-span-2">
                                <input type="date" id="associate-person-end-date" name="end_date" class="block w-full px-3 py-2 bg-white border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start py-2">
                            <div class="md:col-span-1">
                                <label for="associate-person-attendance-method" class="block text-sm font-medium text-gray-700 pt-2 text-right">打卡方式</label>
                            </div>
                            <div class="md:col-span-2">
                                <select id="associate-person-attendance-method" name="attendance_method" class="block w-full px-3 py-2 bg-white border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="">请选择</option>
                                    <option value="现场打卡">现场打卡</option>
                                    <option value="线上打卡">线上打卡</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start py-2">
                            <div class="md:col-span-1">
                                <label for="associate-person-entry-progress" class="block text-sm font-medium text-gray-700 pt-2 text-right">入项进度</label>
                            </div>
                            <div class="md:col-span-2">
                                <select id="associate-person-entry-progress" name="entry_progress" class="block w-full px-3 py-2 bg-white border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="">请选择</option>
                                    <option value="材料准备中">材料准备中</option>
                                    <option value="已提交">已提交</option>
                                    <option value="面试中">面试中</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end gap-3 pt-4 border-t">
                        <button type="button" id="cancel-associate-person-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                            取消
                        </button>
                        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">
                            保存关联
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 关联内部项目模态框 -->
    <div id="associate-project-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" style="background-color: rgba(0,0,0,0.5);">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">关联内部项目</h3>
                    <button id="close-associate-modal" class="text-gray-400 hover:text-gray-500">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                
                <form id="associate-project-form" class="space-y-4">
                    <input type="hidden" id="associate-order-id" name="order_id">
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start py-2">
                        <div class="md:col-span-1">
                            <label for="associate-project-id" class="block text-sm font-medium text-gray-700 pt-2 text-right">内部项目 <span class="text-red-500">*</span></label>
                        </div>
                        <div class="md:col-span-2">
                            <select id="associate-project-id" name="internal_project_id" required class="block w-full px-3 py-2 bg-white border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">请选择项目</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start py-2">
                        <div class="md:col-span-1">
                            <label for="associate-reason" class="block text-sm font-medium text-gray-700 pt-2 text-right">关联原因</label>
                        </div>
                        <div class="md:col-span-2">
                            <textarea id="associate-reason" name="association_reason" rows="3" class="block w-full px-3 py-2 bg-white border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="请输入关联原因"></textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end gap-3 pt-4 border-t">
                        <button type="button" id="cancel-associate-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                            取消
                        </button>
                        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">
                            保存关联
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/schema-utils.js"></script>
<script>
// Schema 定义（从后端传递）
const orderSchema = {{ order_schema | tojson }};
const contractOrderSchema = {{ contract_order_schema | tojson }};
const projectOrderSchema = {{ project_order_schema | tojson }};

ensureFieldOrder(orderSchema);

let currentEditOrderId = null;
let currentSplitContractId = null;

// Tab 切换功能
function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });
    
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('border-indigo-500', 'text-indigo-600');
        btn.classList.add('border-transparent', 'text-gray-500');
    });
    
    const content = document.getElementById(`tab-content-${tabName}`);
    if (content) {
        content.classList.remove('hidden');
    }
    
    const button = document.getElementById(`tab-${tabName}`);
    if (button) {
        button.classList.add('border-indigo-500', 'text-indigo-600');
        button.classList.remove('border-transparent', 'text-gray-500');
    }
    
    if (tabName === 'orders') {
        loadOrders();
    } else if (tabName === 'project-orders') {
        loadProjectOrders();
    }
}

// 渲染订单表格
function renderOrdersTable(orders) {
    const headerRow = document.getElementById('table-header');
    const tbody = document.getElementById('table-body');
    
    if (!headerRow || !tbody) return;
    
    headerRow.innerHTML = '';
    tbody.innerHTML = '';
    
    const columns = [
        { key: 'order_number', label: '订单编号' },
        { key: 'amount', label: '订单金额' },
        { key: 'status', label: '订单状态' },
        { key: 'execution_start_date', label: '执行开始时间' },
        { key: 'expected_delivery_date', label: '预期交付日期' },
    ];
    
    columns.forEach(col => {
        const th = document.createElement('th');
        th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
        th.textContent = col.label;
        headerRow.appendChild(th);
    });
    
    orders.forEach(order => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50 cursor-pointer';
        tr.onclick = () => showOrderDetail(order.id);
        
        columns.forEach(col => {
            const td = document.createElement('td');
            td.className = 'whitespace-nowrap px-6 py-4 text-sm text-gray-900';
            
            let value = order[col.key] || '';
            
            if (col.key === 'order_type' && value) {
                const typeColors = {
                    '劳务': 'bg-blue-100 text-blue-800',
                    '专项': 'bg-purple-100 text-purple-800'
                };
                const colorClass = typeColors[value] || 'bg-gray-100 text-gray-800';
                td.innerHTML = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${colorClass}">${value}</span>`;
            } else if (col.key === 'amount' && value) {
                td.textContent = `¥${parseFloat(value).toLocaleString()}`;
            } else if (col.key === 'status' && value) {
                const statusColors = {
                    '待确认': 'bg-yellow-100 text-yellow-800',
                    '已确认': 'bg-blue-100 text-blue-800',
                    '执行中': 'bg-green-100 text-green-800',
                    '已完成': 'bg-purple-100 text-purple-800',
                    '已取消': 'bg-red-100 text-red-800'
                };
                const colorClass = statusColors[value] || 'bg-gray-100 text-gray-800';
                td.innerHTML = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${colorClass}">${value}</span>`;
            } else {
                td.textContent = value || '-';
            }
            
            tr.appendChild(td);
        });
        
        tbody.appendChild(tr);
    });
}

// 加载订单列表
async function loadOrders() {
    try {
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const container = document.getElementById('orders-container');
        
        // 检查 URL 参数，如果有 split_contract，则打开拆分订单模态框
        const urlParams = new URLSearchParams(window.location.search);
        const splitContractId = urlParams.get('split_contract');
        if (splitContractId) {
            currentSplitContractId = parseInt(splitContractId);
            openSplitOrderModal();
            // 清除 URL 参数
            window.history.replaceState({}, document.title, window.location.pathname);
        }
        
        const response = await fetch('/api/twins/order');
        const result = await response.json();
        
        loading.classList.add('hidden');
        
        if (!result.success) {
            error.classList.remove('hidden');
            document.getElementById('error-message').textContent = result.error || '加载失败';
            return;
        }
        
        error.classList.add('hidden');
        container.classList.remove('hidden');
        
        if (result.data && result.data.length > 0) {
            renderOrdersTable(result.data);
        } else {
            container.innerHTML = '<div class="text-center py-12 text-gray-500">暂无数据</div>';
        }
    } catch (err) {
        console.error('加载订单列表失败:', err);
    }
}

// 显示订单详情
async function showOrderDetail(orderId) {
    try {
        const response = await fetch(`/api/twins/order/${orderId}`);
        const result = await response.json();
        
        if (!result.success) {
            alert('加载失败: ' + result.error);
            return;
        }
        
        const order = result.data;
        currentEditOrderId = orderId;
        const modal = document.getElementById('order-modal');
        const content = document.getElementById('order-detail-content');
        
        document.getElementById('edit-order-btn').onclick = () => {
            // TODO: 实现编辑订单功能
            alert('编辑订单功能待实现');
        };
        
        document.getElementById('associate-project-btn').onclick = () => {
            modal.classList.add('hidden');
            openAssociateProjectModal(orderId);
        };
        
        const orderType = order.current.order_type || '专项';
        document.getElementById('associate-person-btn').onclick = () => {
            modal.classList.add('hidden');
            openAssociatePersonModal(orderId, orderType);
        };
        
        let html = '<div class="space-y-6">';
        html += '<div>';
        html += '<h4 class="text-md font-semibold text-gray-900 mb-3">订单信息</h4>';
        html += '<div class="bg-gray-50 rounded-lg p-4 space-y-3">';
        
        const fields = orderSchema.fields || {};
        const fieldNames = Object.keys(fields);
        for (const fieldName of fieldNames) {
            const fieldDef = fields[fieldName];
            const value = order.current[fieldName];
            if (value !== undefined && value !== null && value !== '') {
                const label = fieldDef.label || fieldName;
                let displayValue = value;
                
                if (fieldName === 'amount') {
                    displayValue = `¥${parseFloat(value).toLocaleString()}`;
                }
                
                html += `<div class="flex">
                    <span class="text-sm font-medium text-gray-700 w-32">${label}:</span>
                    <span class="text-sm text-gray-900 flex-1">${displayValue}</span>
                </div>`;
            }
        }
        
        html += '</div></div>';
        
        // 获取关联的客户合同
        try {
            const contractResponse = await fetch(`/api/twins/client_contract_order?order_id=${orderId}&enrich=client_contract`);
            const contractResult = await contractResponse.json();
            if (contractResult.success && contractResult.data && contractResult.data.length > 0) {
                const contractOrder = contractResult.data[0];
                html += '<div>';
                html += '<h4 class="text-md font-semibold text-gray-900 mb-3">关联合同</h4>';
                html += '<div class="bg-gray-50 rounded-lg p-4 space-y-3">';
                html += `<div class="flex">
                    <span class="text-sm font-medium text-gray-700 w-32">合同名称:</span>
                    <span class="text-sm text-gray-900 flex-1">${contractOrder.client_contract_contract_name || '-'}</span>
                </div>`;
                html += `<div class="flex">
                    <span class="text-sm font-medium text-gray-700 w-32">拆分日期:</span>
                    <span class="text-sm text-gray-900 flex-1">${contractOrder.split_date || '-'}</span>
                </div>`;
                html += '</div></div>';
            }
        } catch (err) {
            console.error('加载关联合同失败:', err);
        }
        
        // 获取关联的内部项目
        try {
            const projectResponse = await fetch(`/api/twins/internal_project_order?order_id=${orderId}&enrich=internal_project`);
            const projectResult = await projectResponse.json();
            if (projectResult.success && projectResult.data && projectResult.data.length > 0) {
                html += '<div>';
                html += '<h4 class="text-md font-semibold text-gray-900 mb-3">关联内部项目</h4>';
                html += '<div class="overflow-x-auto">';
                html += '<table class="min-w-full divide-y divide-gray-200">';
                html += '<thead class="bg-gray-50"><tr>';
                html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">项目名称</th>';
                html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">关联日期</th>';
                html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">关联原因</th>';
                html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
                
                projectResult.data.forEach(item => {
                    html += `<tr>`;
                    html += `<td class="px-4 py-3 text-sm text-gray-900">${item.internal_project_name || '-'}</td>`;
                    html += `<td class="px-4 py-3 text-sm text-gray-900">${item.association_date || '-'}</td>`;
                    html += `<td class="px-4 py-3 text-sm text-gray-900">${item.association_reason || '-'}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table></div></div>';
            }
        } catch (err) {
            console.error('加载关联项目失败:', err);
        }
        
        // 获取关联的人员
        try {
            const personResponse = await fetch(`/api/twins/person_order_participation?order_id=${orderId}&enrich=person`);
            const personResult = await personResponse.json();
            if (personResult.success && personResult.data && personResult.data.length > 0) {
                html += '<div>';
                html += '<h4 class="text-md font-semibold text-gray-900 mb-3">参与人员</h4>';
                html += '<div class="overflow-x-auto">';
                html += '<table class="min-w-full divide-y divide-gray-200">';
                html += '<thead class="bg-gray-50"><tr>';
                html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">姓名</th>';
                html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">参与类型</th>';
                html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">开始时间</th>';
                html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">结束时间</th>';
                html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">打卡方式</th>';
                html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">入项进度</th>';
                html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">操作</th>';
                html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
                
                personResult.data.forEach(item => {
                    const participationType = item.participation_type || '-';
                    const participationTypeColor = participationType === '实际参加' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
                    
                    html += `<tr>`;
                    html += `<td class="px-4 py-3 text-sm text-gray-900">${item.person_name || '-'}</td>`;
                    html += `<td class="px-4 py-3 text-sm"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${participationTypeColor}">${participationType}</span></td>`;
                    html += `<td class="px-4 py-3 text-sm text-gray-900">${item.start_date || '-'}</td>`;
                    html += `<td class="px-4 py-3 text-sm text-gray-900">${item.end_date || '-'}</td>`;
                    html += `<td class="px-4 py-3 text-sm text-gray-900">${item.attendance_method || '-'}</td>`;
                    html += `<td class="px-4 py-3 text-sm text-gray-900">${item.entry_progress || '-'}</td>`;
                    html += `<td class="px-4 py-3 text-sm">
                        <button onclick="editPersonParticipation(${item.activity_id}, ${orderId})" class="text-indigo-600 hover:text-indigo-700 mr-2">编辑</button>
                        <button onclick="deletePersonParticipation(${item.activity_id})" class="text-red-600 hover:text-red-700">删除</button>
                    </td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table></div></div>';
            } else {
                html += '<div>';
                html += '<h4 class="text-md font-semibold text-gray-900 mb-3">参与人员</h4>';
                html += '<div class="text-sm text-gray-500">暂无参与人员</div>';
                html += '</div>';
            }
        } catch (err) {
            console.error('加载参与人员失败:', err);
        }
        
        html += '</div>';
        content.innerHTML = html;
        modal.classList.remove('hidden');
    } catch (error) {
        alert('加载失败: ' + error.message);
    }
}

// 打开从合同拆分订单模态框
async function openSplitOrderModal() {
    // 加载客户合同列表
    try {
        const contractsResponse = await fetch('/api/twins/client_contract');
        const contractsResult = await contractsResponse.json();
        
        const contractSelect = document.getElementById('split-contract-id');
        contractSelect.innerHTML = '<option value="">请选择合同</option>';
        
        // 存储合同信息，用于后续获取合同类型
        window.contractsMap = new Map();
        
        if (contractsResult.success && contractsResult.data) {
            contractsResult.data.forEach(contract => {
                const option = document.createElement('option');
                option.value = contract.id;
                option.textContent = `${contract.contract_number} - ${contract.contract_name}`;
                if (currentSplitContractId && contract.id === currentSplitContractId) {
                    option.selected = true;
                }
                contractSelect.appendChild(option);
                
                // 存储合同信息
                window.contractsMap.set(contract.id, contract);
            });
        }
        
        // 添加合同选择变化事件监听
        contractSelect.onchange = async function() {
            const selectedContractId = parseInt(this.value);
            if (selectedContractId && window.contractsMap.has(selectedContractId)) {
                const contract = window.contractsMap.get(selectedContractId);
                const contractType = contract.contract_type;
                
                // 如果订单类型字段已渲染，自动设置
                const orderTypeField = document.getElementById('order-order_type');
                if (orderTypeField && contractType) {
                    orderTypeField.value = contractType;
                } else {
                    // 如果字段还未渲染，重新渲染表单并设置类型
                    const orderData = contractType ? { order_type: contractType } : {};
                    renderOrderFormFields('split-order-form-fields', orderData);
                }
            }
        };
        
        // 渲染订单表单字段
        renderOrderFormFields('split-order-form-fields', {});
        
        // 如果已有选中的合同，触发一次 change 事件
        if (currentSplitContractId) {
            contractSelect.dispatchEvent(new Event('change'));
        }
        
        document.getElementById('split-order-modal').classList.remove('hidden');
    } catch (error) {
        alert('加载合同列表失败: ' + error.message);
    }
}

// 渲染订单表单字段
function renderOrderFormFields(containerId, data = {}) {
    const fields = orderSchema.fields || {};
    const formFields = document.getElementById(containerId);
    if (!formFields) return;
    
    formFields.innerHTML = '';
    
    const fieldNames = Object.keys(fields);
    for (const fieldName of fieldNames) {
        const fieldDef = fields[fieldName];
        const label = fieldDef.label || fieldName;
        let value = data[fieldName] || '';
        
        const required = fieldDef.required || false;
        const fieldType = fieldDef.type || 'string';
        const uiComponent = fieldDef.ui?.component || 'text_input';
        
        let fieldHtml = '<div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start py-2">';
        fieldHtml += `<div class="md:col-span-1">
            <label for="order-${fieldName}" class="block text-sm font-medium text-gray-700 pt-2 text-right">${label}${required ? ' <span class="text-red-500">*</span>' : ''}</label>
        </div>`;
        fieldHtml += '<div class="md:col-span-2">';
        
        const inputBaseClasses = "block w-full px-3 py-2 bg-white border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 hover:border-gray-400 transition-colors";
        
        if (uiComponent === 'textarea') {
            fieldHtml += `<textarea id="order-${fieldName}" name="${fieldName}" rows="3" class="${inputBaseClasses}" ${required ? 'required' : ''}>${value}</textarea>`;
        } else if (fieldType === 'enum' && fieldDef.options) {
            fieldHtml += `<select id="order-${fieldName}" name="${fieldName}" class="${inputBaseClasses}" ${required ? 'required' : ''}>`;
            fieldHtml += '<option value="">请选择</option>';
            for (const option of fieldDef.options) {
                fieldHtml += `<option value="${option}" ${value === option ? 'selected' : ''}>${option}</option>`;
            }
            fieldHtml += '</select>';
        } else if (fieldType === 'date') {
            fieldHtml += `<input type="date" id="order-${fieldName}" name="${fieldName}" value="${value}" class="${inputBaseClasses}" ${required ? 'required' : ''}>`;
        } else if (fieldType === 'decimal' || fieldType === 'number') {
            fieldHtml += `<div class="flex items-center gap-2">`;
            fieldHtml += `<input type="number" id="order-${fieldName}" name="${fieldName}" value="${value}" step="${fieldType === 'decimal' ? '0.01' : '1'}" min="${fieldDef.validation?.min || ''}" placeholder="请输入${label}" class="${inputBaseClasses}" ${required ? 'required' : ''}>`;
            if (fieldDef.ui?.suffix) {
                fieldHtml += `<span class="text-sm text-gray-500 whitespace-nowrap">${fieldDef.ui.suffix}</span>`;
            }
            fieldHtml += `</div>`;
        } else {
            fieldHtml += `<input type="text" id="order-${fieldName}" name="${fieldName}" value="${value}" placeholder="请输入${label}" class="${inputBaseClasses}" ${required ? 'required' : ''}>`;
        }
        
        fieldHtml += '</div></div>';
        
        formFields.innerHTML += fieldHtml;
    }
}

// 提交拆分订单表单
async function submitSplitOrderForm(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    const contractId = parseInt(formData.get('client_contract_id'));
    if (!contractId) {
        alert('请选择客户合同');
        return;
    }
    
    // 获取合同类型，确保订单类型与合同类型一致
    let contractType = null;
    if (window.contractsMap && window.contractsMap.has(contractId)) {
        contractType = window.contractsMap.get(contractId).contract_type;
    }
    
    // 构建订单数据
    const orderData = {};
    const fields = orderSchema.fields || {};
    const fieldNames = Object.keys(fields);
    for (const fieldName of fieldNames) {
        const value = formData.get(fieldName);
        if (value !== null && value !== '') {
            const fieldDef = fields[fieldName];
            if (fieldDef.type === 'decimal' || fieldDef.type === 'number') {
                orderData[fieldName] = parseFloat(value);
            } else {
                orderData[fieldName] = value.trim();
            }
        }
    }
    
    // 确保订单类型与合同类型一致
    if (contractType && (!orderData.order_type || orderData.order_type !== contractType)) {
        orderData.order_type = contractType;
    }
    
    try {
        // 先创建订单
        const orderResponse = await fetch('/api/twins/order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(orderData)
        });
        
        const orderResult = await orderResponse.json();
        
        if (!orderResult.success) {
            alert('创建订单失败: ' + orderResult.error);
            return;
        }
        
        const orderId = orderResult.data.id;
        
        // 创建客户合同-订单关联
        const splitDate = new Date().toISOString().split('T')[0];
        const associationData = {
            client_contract_id: contractId,
            order_id: orderId,
            split_date: splitDate,
            split_reason: formData.get('split_reason') || '',
            split_by: '当前用户', // TODO: 从用户会话获取
        };
        
        const associationResponse = await fetch('/api/twins/client_contract_order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(associationData)
        });
        
        const associationResult = await associationResponse.json();
        
        if (!associationResult.success) {
            alert('创建关联失败: ' + associationResult.error);
            return;
        }
        
        document.getElementById('split-order-modal').classList.add('hidden');
        loadOrders();
        alert('订单创建成功！');
    } catch (error) {
        alert('创建失败: ' + error.message);
    }
}

// 加载项目关联订单（三栏展示）
async function loadProjectOrders() {
    try {
        const loading = document.getElementById('loading-project-orders');
        const container = document.getElementById('project-orders-container');
        const projectsColumn = document.getElementById('projects-column');
        const ordersColumn = document.getElementById('orders-column');
        const contractsColumn = document.getElementById('contracts-column');
        
        // 并行获取所有关联数据
        const [projectOrdersResponse, contractOrdersResponse] = await Promise.all([
            fetch('/api/twins/internal_project_order?enrich=internal_project,order'),
            fetch('/api/twins/client_contract_order?enrich=client_contract,order')
        ]);
        
        const projectOrdersResult = await projectOrdersResponse.json();
        const contractOrdersResult = await contractOrdersResponse.json();
        
        loading.classList.add('hidden');
        
        if (!projectOrdersResult.success || !contractOrdersResult.success) {
            container.innerHTML = '<div class="text-center py-12 text-red-500">加载失败</div>';
            return;
        }
        
        container.classList.remove('hidden');
        
        // 建立关系映射
        // orderId -> { project: {...}, contract: {...}, order: {...} }
        const relationMap = new Map();
        
        // 处理内部项目-订单关联
        if (projectOrdersResult.data) {
            projectOrdersResult.data.forEach(item => {
                const orderId = item.order_id;
                if (!relationMap.has(orderId)) {
                    relationMap.set(orderId, {});
                }
                const relation = relationMap.get(orderId);
                relation.project = {
                    id: item.internal_project_id,
                    name: item.internal_project_name || `项目 ${item.internal_project_id}`,
                    department: item.internal_project_department || '',
                    association_date: item.association_date || '',
                    association_reason: item.association_reason || ''
                };
                relation.order = {
                    id: item.order_id,
                    order_number: item.order_order_number || '',
                    amount: item.order_amount || 0,
                    status: item.order_status || '',
                    execution_start_date: item.order_execution_start_date || ''
                };
            });
        }
        
        // 处理客户合同-订单关联
        if (contractOrdersResult.data) {
            contractOrdersResult.data.forEach(item => {
                const orderId = item.order_id;
                if (!relationMap.has(orderId)) {
                    relationMap.set(orderId, {});
                }
                const relation = relationMap.get(orderId);
                relation.contract = {
                    id: item.client_contract_id,
                    contract_number: item.client_contract_contract_number || '',
                    contract_name: item.client_contract_contract_name || `合同 ${item.client_contract_id}`,
                    client_company: item.client_contract_client_company || '',
                    split_date: item.split_date || '',
                    split_reason: item.split_reason || ''
                };
                // 如果订单信息还没有，补充订单信息
                if (!relation.order) {
                    relation.order = {
                        id: item.order_id,
                        order_number: item.order_order_number || '',
                        amount: item.order_amount || 0,
                        status: item.order_status || '',
                        execution_start_date: item.order_execution_start_date || ''
                    };
                }
            });
        }
        
        // 收集所有唯一的数据
        const projectsMap = new Map();
        const ordersMap = new Map();
        const contractsMap = new Map();
        
        relationMap.forEach((relation, orderId) => {
            if (relation.project) {
                projectsMap.set(relation.project.id, relation.project);
            }
            if (relation.order) {
                ordersMap.set(relation.order.id, relation.order);
            }
            if (relation.contract) {
                contractsMap.set(relation.contract.id, relation.contract);
            }
        });
        
        // 渲染内部项目栏
        projectsColumn.innerHTML = '';
        if (projectsMap.size > 0) {
            projectsMap.forEach((project, projectId) => {
                const card = document.createElement('div');
                card.className = 'p-4 hover:bg-gray-50 cursor-pointer transition-colors';
                card.dataset.projectId = projectId;
                card.onclick = () => highlightRelations(projectId, 'project');
                
                card.innerHTML = `
                    <div class="font-medium text-gray-900">${project.name}</div>
                    ${project.department ? `<div class="text-sm text-gray-500 mt-1">${project.department}</div>` : ''}
                `;
                projectsColumn.appendChild(card);
            });
        } else {
            projectsColumn.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">暂无项目</div>';
        }
        
        // 渲染订单栏
        ordersColumn.innerHTML = '';
        if (ordersMap.size > 0) {
            ordersMap.forEach((order, orderId) => {
                const card = document.createElement('div');
                card.className = 'p-4 hover:bg-gray-50 cursor-pointer transition-colors';
                card.dataset.orderId = orderId;
                card.onclick = () => {
                    highlightRelations(orderId, 'order');
                    showOrderDetail(orderId);
                };
                
                const statusColors = {
                    '待确认': 'bg-yellow-100 text-yellow-800',
                    '已确认': 'bg-blue-100 text-blue-800',
                    '执行中': 'bg-green-100 text-green-800',
                    '已完成': 'bg-purple-100 text-purple-800',
                    '已取消': 'bg-red-100 text-red-800'
                };
                const statusColor = statusColors[order.status] || 'bg-gray-100 text-gray-800';
                
                card.innerHTML = `
                    <div class="font-medium text-gray-900">${order.order_number || `订单 ${orderId}`}</div>
                    <div class="text-sm text-gray-500 mt-1">${order.amount ? '¥' + parseFloat(order.amount).toLocaleString() : '-'}</div>
                    ${order.status ? `<div class="mt-2"><span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${statusColor}">${order.status}</span></div>` : ''}
                `;
                ordersColumn.appendChild(card);
            });
        } else {
            ordersColumn.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">暂无订单</div>';
        }
        
        // 渲染客户合同栏
        contractsColumn.innerHTML = '';
        if (contractsMap.size > 0) {
            contractsMap.forEach((contract, contractId) => {
                const card = document.createElement('div');
                card.className = 'p-4 hover:bg-gray-50 cursor-pointer transition-colors';
                card.dataset.contractId = contractId;
                card.onclick = () => highlightRelations(contractId, 'contract');
                
                card.innerHTML = `
                    <div class="font-medium text-gray-900">${contract.contract_name}</div>
                    <div class="text-sm text-gray-500 mt-1">${contract.contract_number || ''}</div>
                    ${contract.client_company ? `<div class="text-sm text-gray-500 mt-1">${contract.client_company}</div>` : ''}
                `;
                contractsColumn.appendChild(card);
            });
        } else {
            contractsColumn.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">暂无合同</div>';
        }
        
        // 保存关系映射供高亮使用
        window.relationMap = relationMap;
    } catch (err) {
        console.error('加载项目关联订单失败:', err);
        const container = document.getElementById('project-orders-container');
        container.innerHTML = '<div class="text-center py-12 text-red-500">加载失败: ' + err.message + '</div>';
    }
}

// 高亮关联关系
function highlightRelations(id, type) {
    // 清除所有高亮
    document.querySelectorAll('[data-project-id], [data-order-id], [data-contract-id]').forEach(el => {
        el.classList.remove('bg-indigo-50', 'ring-2', 'ring-indigo-500');
    });
    
    if (!window.relationMap) return;
    
    // 找到相关的关联关系
    const relatedProjects = new Set();
    const relatedOrders = new Set();
    const relatedContracts = new Set();
    
    window.relationMap.forEach((relation, orderId) => {
        let shouldHighlight = false;
        
        if (type === 'project' && relation.project && relation.project.id === id) {
            shouldHighlight = true;
            if (relation.order) relatedOrders.add(relation.order.id);
            if (relation.contract) relatedContracts.add(relation.contract.id);
        } else if (type === 'order' && relation.order && relation.order.id === id) {
            shouldHighlight = true;
            if (relation.project) relatedProjects.add(relation.project.id);
            if (relation.contract) relatedContracts.add(relation.contract.id);
        } else if (type === 'contract' && relation.contract && relation.contract.id === id) {
            shouldHighlight = true;
            if (relation.project) relatedProjects.add(relation.project.id);
            if (relation.order) relatedOrders.add(relation.order.id);
        }
    });
    
    // 高亮当前选中的卡片
    if (type === 'project') {
        document.querySelector(`[data-project-id="${id}"]`)?.classList.add('bg-indigo-50', 'ring-2', 'ring-indigo-500');
    } else if (type === 'order') {
        document.querySelector(`[data-order-id="${id}"]`)?.classList.add('bg-indigo-50', 'ring-2', 'ring-indigo-500');
    } else if (type === 'contract') {
        document.querySelector(`[data-contract-id="${id}"]`)?.classList.add('bg-indigo-50', 'ring-2', 'ring-indigo-500');
    }
    
    // 高亮相关的卡片
    relatedProjects.forEach(projectId => {
        document.querySelector(`[data-project-id="${projectId}"]`)?.classList.add('bg-indigo-50', 'ring-2', 'ring-indigo-500');
    });
    
    relatedOrders.forEach(orderId => {
        document.querySelector(`[data-order-id="${orderId}"]`)?.classList.add('bg-indigo-50', 'ring-2', 'ring-indigo-500');
    });
    
    relatedContracts.forEach(contractId => {
        document.querySelector(`[data-contract-id="${contractId}"]`)?.classList.add('bg-indigo-50', 'ring-2', 'ring-indigo-500');
    });
}

// 打开关联内部项目模态框
async function openAssociateProjectModal(orderId) {
    document.getElementById('associate-order-id').value = orderId;
    
    // 加载内部项目列表
    try {
        const projectsResponse = await fetch('/api/twins/internal_project');
        const projectsResult = await projectsResponse.json();
        
        const projectSelect = document.getElementById('associate-project-id');
        projectSelect.innerHTML = '<option value="">请选择项目</option>';
        
        if (projectsResult.success && projectsResult.data) {
            projectsResult.data.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name || `项目 ${project.id}`;
                projectSelect.appendChild(option);
            });
        }
        
        document.getElementById('associate-project-modal').classList.remove('hidden');
    } catch (error) {
        alert('加载项目列表失败: ' + error.message);
    }
}

// 提交关联内部项目表单
async function submitAssociateProjectForm(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    const orderId = parseInt(formData.get('order_id'));
    const projectId = parseInt(formData.get('internal_project_id'));
    
    if (!orderId || !projectId) {
        alert('请选择内部项目');
        return;
    }
    
    const associationDate = new Date().toISOString().split('T')[0];
    const associationData = {
        internal_project_id: projectId,
        order_id: orderId,
        association_date: associationDate,
        association_reason: formData.get('association_reason') || '',
    };
    
    try {
        const response = await fetch('/api/twins/internal_project_order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(associationData)
        });
        
        const result = await response.json();
        
        if (!result.success) {
            alert('创建关联失败: ' + result.error);
            return;
        }
        
        document.getElementById('associate-project-modal').classList.add('hidden');
        loadProjectOrders();
        alert('关联成功！');
    } catch (error) {
        alert('创建关联失败: ' + error.message);
    }
}

// 绑定事件
document.getElementById('split-order-btn').onclick = openSplitOrderModal;
document.getElementById('close-split-modal').onclick = () => {
    document.getElementById('split-order-modal').classList.add('hidden');
};
document.getElementById('cancel-split-btn').onclick = () => {
    document.getElementById('split-order-modal').classList.add('hidden');
};
document.getElementById('split-order-form').onsubmit = submitSplitOrderForm;

document.getElementById('close-associate-modal').onclick = () => {
    document.getElementById('associate-project-modal').classList.add('hidden');
};
document.getElementById('cancel-associate-btn').onclick = () => {
    document.getElementById('associate-project-modal').classList.add('hidden');
};
document.getElementById('associate-project-form').onsubmit = submitAssociateProjectForm;

// 打开关联人员模态框
async function openAssociatePersonModal(orderId, orderType) {
    document.getElementById('associate-person-order-id').value = orderId;
    document.getElementById('associate-person-activity-id').value = '';
    
    // 清空表单
    document.getElementById('associate-person-form').reset();
    document.getElementById('associate-person-order-id').value = orderId;
    
    // 加载人员列表
    try {
        const personsResponse = await fetch('/api/twins/person');
        const personsResult = await personsResponse.json();
        
        const personSelect = document.getElementById('associate-person-person-id');
        personSelect.innerHTML = '<option value="">请选择人员</option>';
        
        if (personsResult.success && personsResult.data) {
            personsResult.data.forEach(person => {
                const option = document.createElement('option');
                option.value = person.id;
                const name = person.name || person.id_card || `人员 ${person.id}`;
                option.textContent = name;
                personSelect.appendChild(option);
            });
        }
        
        // 根据订单类型显示/隐藏劳务相关字段
        const laborFields = document.getElementById('labor-order-fields');
        if (orderType === '劳务') {
            laborFields.classList.remove('hidden');
        } else {
            laborFields.classList.add('hidden');
        }
        
        // 监听参与类型变化，如果是劳务订单且是实际参加，显示劳务字段
        const participationTypeSelect = document.getElementById('associate-person-participation-type');
        participationTypeSelect.onchange = function() {
            if (orderType === '劳务' && this.value === '实际参加') {
                laborFields.classList.remove('hidden');
            } else if (orderType === '劳务' && this.value === '名义参加') {
                laborFields.classList.add('hidden');
            }
        };
        
        document.getElementById('associate-person-modal').classList.remove('hidden');
    } catch (error) {
        alert('加载人员列表失败: ' + error.message);
    }
}

// 编辑人员参与
async function editPersonParticipation(activityId, orderId) {
    try {
        // 获取订单类型
        const orderResponse = await fetch(`/api/twins/order/${orderId}`);
        const orderResult = await orderResponse.json();
        const orderType = orderResult.data?.current?.order_type || '专项';
        
        // 获取参与记录
        const participationResponse = await fetch(`/api/twins/person_order_participation/${activityId}`);
        const participationResult = await participationResponse.json();
        
        if (!participationResult.success) {
            alert('加载失败: ' + participationResult.error);
            return;
        }
        
        const participation = participationResult.data;
        document.getElementById('associate-person-order-id').value = orderId;
        document.getElementById('associate-person-activity-id').value = activityId;
        document.getElementById('associate-person-person-id').value = participation.current.person_id;
        document.getElementById('associate-person-participation-type').value = participation.current.participation_type || '';
        
        // 根据订单类型和参与类型显示/隐藏字段
        const laborFields = document.getElementById('labor-order-fields');
        if (orderType === '劳务' && participation.current.participation_type === '实际参加') {
            laborFields.classList.remove('hidden');
            document.getElementById('associate-person-start-date').value = participation.current.start_date || '';
            document.getElementById('associate-person-end-date').value = participation.current.end_date || '';
            document.getElementById('associate-person-attendance-method').value = participation.current.attendance_method || '';
            document.getElementById('associate-person-entry-progress').value = participation.current.entry_progress || '';
        } else {
            laborFields.classList.add('hidden');
        }
        
        // 加载人员列表
        const personsResponse = await fetch('/api/twins/person');
        const personsResult = await personsResponse.json();
        
        const personSelect = document.getElementById('associate-person-person-id');
        personSelect.innerHTML = '<option value="">请选择人员</option>';
        
        if (personsResult.success && personsResult.data) {
            personsResult.data.forEach(person => {
                const option = document.createElement('option');
                option.value = person.id;
                const name = person.name || person.id_card || `人员 ${person.id}`;
                option.textContent = name;
                if (person.id === participation.current.person_id) {
                    option.selected = true;
                }
                personSelect.appendChild(option);
            });
        }
        
        // 监听参与类型变化
        const participationTypeSelect = document.getElementById('associate-person-participation-type');
        participationTypeSelect.onchange = function() {
            if (orderType === '劳务' && this.value === '实际参加') {
                laborFields.classList.remove('hidden');
            } else {
                laborFields.classList.add('hidden');
            }
        };
        
        document.getElementById('associate-person-modal').classList.remove('hidden');
    } catch (error) {
        alert('加载失败: ' + error.message);
    }
}

// 删除人员参与
async function deletePersonParticipation(activityId) {
    if (!confirm('确定要删除这条参与记录吗？')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/twins/person_order_participation/${activityId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (!result.success) {
            alert('删除失败: ' + result.error);
            return;
        }
        
        // 如果订单详情模态框是打开的，刷新它
        const orderModal = document.getElementById('order-modal');
        if (!orderModal.classList.contains('hidden')) {
            const orderId = currentEditOrderId;
            if (orderId) {
                showOrderDetail(orderId);
            }
        } else {
            loadOrders();
        }
        
        alert('删除成功！');
    } catch (error) {
        alert('删除失败: ' + error.message);
    }
}

// 提交关联人员表单
async function submitAssociatePersonForm(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    const orderId = parseInt(formData.get('order_id'));
    const personId = parseInt(formData.get('person_id'));
    const activityId = formData.get('activity_id');
    const participationType = formData.get('participation_type');
    
    if (!orderId || !personId || !participationType) {
        alert('请填写必填字段');
        return;
    }
    
    // 获取订单类型
    const orderResponse = await fetch(`/api/twins/order/${orderId}`);
    const orderResult = await orderResponse.json();
    const orderType = orderResult.data?.current?.order_type || '专项';
    
    // 构建参与数据
    const participationData = {
        person_id: personId,
        order_id: orderId,
        participation_type: participationType,
    };
    
    // 如果是劳务订单且是实际参加，添加劳务相关字段
    if (orderType === '劳务' && participationType === '实际参加') {
        const startDate = formData.get('start_date');
        const endDate = formData.get('end_date');
        const attendanceMethod = formData.get('attendance_method');
        const entryProgress = formData.get('entry_progress');
        
        if (startDate) participationData.start_date = startDate;
        if (endDate) participationData.end_date = endDate;
        if (attendanceMethod) participationData.attendance_method = attendanceMethod;
        if (entryProgress) participationData.entry_progress = entryProgress;
    }
    
    try {
        let response;
        if (activityId) {
            // 更新
            response = await fetch(`/api/twins/person_order_participation/${activityId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(participationData)
            });
        } else {
            // 创建
            response = await fetch('/api/twins/person_order_participation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(participationData)
            });
        }
        
        const result = await response.json();
        
        if (!result.success) {
            alert('保存失败: ' + result.error);
            return;
        }
        
        document.getElementById('associate-person-modal').classList.add('hidden');
        
        // 如果订单详情模态框是打开的，刷新它
        const orderModal = document.getElementById('order-modal');
        if (!orderModal.classList.contains('hidden')) {
            showOrderDetail(orderId);
        } else {
            loadOrders();
        }
        
        alert('保存成功！');
    } catch (error) {
        alert('保存失败: ' + error.message);
    }
}

document.getElementById('close-associate-person-modal').onclick = () => {
    document.getElementById('associate-person-modal').classList.add('hidden');
};
document.getElementById('cancel-associate-person-btn').onclick = () => {
    document.getElementById('associate-person-modal').classList.add('hidden');
};
document.getElementById('associate-person-form').onsubmit = submitAssociatePersonForm;

document.getElementById('close-modal').onclick = () => {
    document.getElementById('order-modal').classList.add('hidden');
};

document.getElementById('tab-orders').addEventListener('click', () => switchTab('orders'));
document.getElementById('tab-project-orders').addEventListener('click', () => switchTab('project-orders'));

// 页面加载时获取数据
if (document.readyState === 'loading') {
    window.addEventListener('DOMContentLoaded', () => {
        switchTab('orders');
    });
} else {
    switchTab('orders');
}
</script>
{% endblock %}
