{% extends "base.html" %}

{% block title %}社保公积金配置 - HRMS{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <div class="mb-6 flex justify-between items-center">
        <div>
            <h2 class="text-2xl font-bold text-gray-900">社保公积金配置</h2>
            <p class="mt-1 text-sm text-gray-500">管理系统级社保和公积金缴费比例及参数配置</p>
        </div>
        <button id="add-config-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-md shadow-sm">
            + 新增配置
        </button>
    </div>

    <!-- 加载状态 -->
    <div id="loading" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
        <p class="mt-2 text-sm text-gray-500">加载中...</p>
    </div>

    <!-- 错误提示 -->
    <div id="error" class="hidden bg-red-50 border border-red-200 rounded-md p-4 mb-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">加载失败</h3>
                <p id="error-message" class="mt-2 text-sm text-red-700"></p>
            </div>
        </div>
    </div>

    <!-- 配置卡片容器 -->
    <div id="configs-container" class="hidden">
        <!-- 当前生效配置选择 -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">选择配置版本：</label>
            <select id="config-selector" class="block w-full md:w-64 px-3 py-2 bg-white border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                <option value="">加载中...</option>
            </select>
        </div>
        
        <!-- 参数卡片网格 -->
        <div id="params-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            <!-- 动态生成参数卡片 -->
        </div>
    </div>

    <!-- 配置详情模态框 -->
    <div id="config-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-4/5 lg:w-3/4 shadow-lg rounded-md bg-white max-h-[90vh] overflow-y-auto">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">配置详情</h3>
                    <div class="flex gap-2">
                        <button id="edit-config-btn" class="text-indigo-600 hover:text-indigo-700 text-sm font-medium">
                            编辑
                        </button>
                        <button id="close-modal" class="text-gray-400 hover:text-gray-500">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div id="config-detail-content">
                    <!-- 动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 配置表单模态框（新增/编辑） -->
    <div id="config-form-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-4/5 lg:w-3/4 shadow-lg rounded-md bg-white max-h-[90vh] overflow-y-auto">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="config-form-modal-title" class="text-lg font-medium text-gray-900">新增配置</h3>
                    <button id="close-config-form-modal" class="text-gray-400 hover:text-gray-500">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                
                <form id="config-form" class="space-y-4">
                    <div id="config-form-fields">
                        <!-- 动态生成表单字段 -->
                    </div>
                    
                    <div class="flex justify-end gap-3 pt-4 border-t">
                        <button type="button" id="cancel-config-form-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                            取消
                        </button>
                        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">
                            保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/schema-utils.js"></script>
<script>
// Schema 定义（从后端传递）
const schema = {{ schema | tojson }};
ensureFieldOrder(schema);

let currentEditConfigId = null;

// 基于 Schema 动态渲染配置表单字段
function renderConfigFormFields(data = {}) {
    const fields = schema.fields || {};
    const formFields = document.getElementById('config-form-fields');
    formFields.innerHTML = '';
    
    const fieldNames = Object.keys(fields);
    for (const fieldName of fieldNames) {
        const fieldDef = fields[fieldName];
        const label = fieldDef.label || fieldName;
        let value = data[fieldName] || '';
        
        if (!value && fieldDef.auto) {
            if (fieldDef.auto === 'date') {
                value = new Date().toISOString().split('T')[0];
            }
        }
        
        const required = fieldDef.required || false;
        const fieldType = fieldDef.type || 'string';
        const uiComponent = fieldDef.ui?.component || 'text_input';
        
        let fieldHtml = '<div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start py-2">';
        fieldHtml += `<div class="md:col-span-1">
            <label for="config-${fieldName}" class="block text-sm font-medium text-gray-700 pt-2 text-right">${label}${required ? ' <span class="text-red-500">*</span>' : ''}</label>
        </div>`;
        fieldHtml += '<div class="md:col-span-2">';
        
        const inputBaseClasses = "block w-full px-3 py-2 bg-white border-2 border-gray-300 rounded-md shadow-sm text-sm text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 hover:border-gray-400 transition-colors";
        
        if (uiComponent === 'textarea') {
            fieldHtml += `<textarea id="config-${fieldName}" name="${fieldName}" rows="3" class="${inputBaseClasses}" ${required ? 'required' : ''}>${value}</textarea>`;
        } else if (fieldType === 'enum' && fieldDef.options) {
            fieldHtml += `<select id="config-${fieldName}" name="${fieldName}" class="${inputBaseClasses}" ${required ? 'required' : ''}>`;
            fieldHtml += '<option value="">请选择</option>';
            for (const option of fieldDef.options) {
                fieldHtml += `<option value="${option}" ${value === option ? 'selected' : ''}>${option}</option>`;
            }
            fieldHtml += '</select>';
        } else if (fieldType === 'date') {
            fieldHtml += `<input type="date" id="config-${fieldName}" name="${fieldName}" value="${value}" class="${inputBaseClasses}" ${required ? 'required' : ''}>`;
        } else if (fieldType === 'decimal' || fieldType === 'number') {
            fieldHtml += `<div class="flex items-center gap-2">`;
            const step = fieldDef.ui?.step || (fieldType === 'decimal' ? '0.01' : '1');
            const min = fieldDef.validation?.min || '';
            const max = fieldDef.validation?.max || '';
            fieldHtml += `<input type="number" id="config-${fieldName}" name="${fieldName}" value="${value}" step="${step}" ${min !== '' ? `min="${min}"` : ''} ${max !== '' ? `max="${max}"` : ''} placeholder="请输入${label}" class="${inputBaseClasses}" ${required ? 'required' : ''}>`;
            if (fieldDef.ui?.suffix) {
                fieldHtml += `<span class="text-sm text-gray-500 whitespace-nowrap">${fieldDef.ui.suffix}</span>`;
            }
            fieldHtml += `</div>`;
        } else {
            fieldHtml += `<input type="text" id="config-${fieldName}" name="${fieldName}" value="${value}" placeholder="请输入${label}" class="${inputBaseClasses}" ${required ? 'required' : ''}>`;
        }
        
        if (fieldDef.description) {
            fieldHtml += `<p class="mt-1 text-xs text-gray-500">${fieldDef.description}</p>`;
        }
        
        fieldHtml += '</div></div>';
        
        formFields.innerHTML += fieldHtml;
    }
}

// 参数分组定义
const paramGroups = [
    {
        title: '养老保险',
        params: [
            { key: 'pension_employer_rate', label: '单位缴费比例', suffix: '%', type: 'rate' },
            { key: 'pension_employee_rate', label: '个人缴费比例', suffix: '%', type: 'rate' }
        ]
    },
    {
        title: '工伤保险',
        params: [
            { key: 'work_injury_employer_rate', label: '单位缴费比例', suffix: '%', type: 'rate' }
        ]
    },
    {
        title: '失业保险',
        params: [
            { key: 'unemployment_employer_rate', label: '单位缴费比例', suffix: '%', type: 'rate' },
            { key: 'unemployment_employee_rate', label: '个人缴费比例', suffix: '%', type: 'rate' }
        ]
    },
    {
        title: '医疗保险',
        params: [
            { key: 'medical_employer_rate', label: '单位缴费比例', suffix: '%', type: 'rate' },
            { key: 'medical_employee_rate', label: '个人缴费比例', suffix: '%', type: 'rate' }
        ]
    },
    {
        title: '生育保险',
        params: [
            { key: 'maternity_employer_rate', label: '单位缴费比例', suffix: '%', type: 'rate' }
        ]
    },
    {
        title: '大病保险',
        params: [
            { key: 'serious_illness_employee_amount', label: '个人缴费金额', suffix: '元/月', type: 'amount' }
        ]
    },
    {
        title: '住房公积金',
        params: [
            { key: 'housing_fund_employer_rate', label: '单位缴费比例', suffix: '%', type: 'rate' },
            { key: 'housing_fund_employee_rate', label: '个人缴费比例', suffix: '%', type: 'rate' }
        ]
    }
];

let currentConfigId = null;
let currentConfigData = null;

// 渲染参数卡片
function renderParamCards(config) {
    const grid = document.getElementById('params-grid');
    if (!grid) {
        console.error('params-grid 元素未找到');
        return;
    }
    
    if (!config) {
        console.error('配置数据为空');
        return;
    }
    
    grid.innerHTML = '';
    currentConfigData = config;
    
    paramGroups.forEach(group => {
        group.params.forEach(param => {
            const value = config[param.key];
            let displayValue = '-';
            
            if (value !== null && value !== undefined && value !== '') {
                if (param.type === 'rate') {
                    displayValue = (parseFloat(value) * 100).toFixed(2);
                } else {
                    displayValue = parseFloat(value).toFixed(2);
                }
            }
            
            // 根据参数类型设置不同的背景色
            const isEmployee = param.key.includes('_employee_') || param.key.includes('employee_');
            const isEmployer = param.key.includes('_employer_') || param.key.includes('employer_');
            
            let bgColor = 'bg-white'; // 默认白色
            let borderColor = 'border-gray-200';
            let textColor = 'text-indigo-600';
            let hoverTextColor = 'hover:text-indigo-700';
            
            if (isEmployer) {
                // 单位：蓝色系
                bgColor = 'bg-blue-50';
                borderColor = 'border-blue-200';
                textColor = 'text-blue-600';
                hoverTextColor = 'hover:text-blue-700';
            } else if (isEmployee) {
                // 个人：绿色系
                bgColor = 'bg-green-50';
                borderColor = 'border-green-200';
                textColor = 'text-green-600';
                hoverTextColor = 'hover:text-green-700';
            }
            
            const card = document.createElement('div');
            card.className = `${bgColor} rounded-lg shadow-md border ${borderColor} p-6 hover:shadow-lg transition-shadow`;
            card.dataset.paramKey = param.key;
            
            card.innerHTML = `
                <div class="text-center">
                    <div class="text-sm font-medium text-gray-600 mb-2">${group.title}</div>
                    <div class="text-xs text-gray-500 mb-3">${param.label}</div>
                    <div class="text-4xl font-bold ${textColor} cursor-pointer ${hoverTextColor} transition-colors" 
                         onclick="editParam('${param.key}', '${param.label}', '${param.type}', '${param.suffix}')">
                        ${displayValue}<span class="text-2xl">${param.suffix}</span>
                    </div>
                </div>
            `;
            
            grid.appendChild(card);
        });
    });
}

// 编辑单个参数
function editParam(paramKey, paramLabel, paramType, paramSuffix) {
    if (!currentConfigData) {
        alert('请先选择配置版本');
        return;
    }
    
    const currentValue = currentConfigData[paramKey];
    let inputValue = '';
    if (currentValue !== null && currentValue !== undefined && currentValue !== '') {
        if (paramType === 'rate') {
            // 比例字段：显示为百分比输入，但存储为小数
            inputValue = (parseFloat(currentValue) * 100).toFixed(2);
        } else {
            inputValue = parseFloat(currentValue).toFixed(2);
        }
    }
    
    const newValue = prompt(`请输入新的${paramLabel}：\n${paramSuffix ? `单位：${paramSuffix}` : ''}`, inputValue);
    
    if (newValue === null) return; // 用户取消
    
    let parsedValue = parseFloat(newValue);
    if (isNaN(parsedValue)) {
        alert('请输入有效的数字');
        return;
    }
    
    if (paramType === 'rate') {
        // 将百分比转换为小数
        parsedValue = parsedValue / 100;
        if (parsedValue < 0 || parsedValue > 1) {
            alert('比例必须在 0% 到 100% 之间');
            return;
        }
    } else {
        if (parsedValue < 0) {
            alert('金额不能为负数');
            return;
        }
    }
    
    // 更新配置数据
    const updatedData = { ...currentConfigData };
    updatedData[paramKey] = parsedValue;
    
    // 保存到服务器
    saveConfigUpdate(updatedData);
}

// 保存配置更新
async function saveConfigUpdate(updatedData) {
    try {
        const url = currentConfigId 
            ? `/api/twins/social_security_config/${currentConfigId}`
            : '/api/twins/social_security_config';
        const method = currentConfigId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updatedData)
        });
        
        const result = await response.json();
        
        if (!result.success) {
            alert('保存失败: ' + result.error);
            return;
        }
        
        // 重新加载配置列表和当前配置
        await loadConfigs();
        if (currentConfigId) {
            await loadCurrentConfig(currentConfigId);
        }
        
        alert('保存成功！');
    } catch (error) {
        alert('保存失败: ' + error.message);
    }
}

// 加载当前配置
async function loadCurrentConfig(configId) {
    try {
        const response = await fetch(`/api/twins/social_security_config/${configId}`);
        const result = await response.json();
        
        if (!result.success) {
            alert('加载失败: ' + result.error);
            return;
        }
        
        currentConfigId = configId;
        renderParamCards(result.data.current);
    } catch (error) {
        alert('加载失败: ' + error.message);
    }
}

// 渲染表格
function renderTable(configs) {
    const headerRow = document.getElementById('table-header');
    const tbody = document.getElementById('table-body');
    
    if (!headerRow || !tbody) return;
    
    headerRow.innerHTML = '';
    tbody.innerHTML = '';
    
    // 按生效日期降序排列，最新的在前
    configs.sort((a, b) => {
        const dateA = a.effective_date || '';
        const dateB = b.effective_date || '';
        return dateB.localeCompare(dateA);
    });
    
    const columns = [
        { key: 'region', label: '适用地区' },
        { key: 'effective_date', label: '生效日期' },
        { key: 'pension_employer_rate', label: '养老单位%' },
        { key: 'pension_employee_rate', label: '养老个人%' },
        { key: 'medical_employer_rate', label: '医疗单位%' },
        { key: 'medical_employee_rate', label: '医疗个人%' },
        { key: 'housing_fund_employer_rate', label: '公积金单位%' },
        { key: 'housing_fund_employee_rate', label: '公积金个人%' },
    ];
    
    columns.forEach(col => {
        const th = document.createElement('th');
        th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
        th.textContent = col.label;
        headerRow.appendChild(th);
    });
    
    configs.forEach(config => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50 cursor-pointer';
        tr.onclick = () => showConfigDetail(config.id);
        
        columns.forEach(col => {
            const td = document.createElement('td');
            td.className = 'whitespace-nowrap px-6 py-4 text-sm text-gray-900';
            
            let value = config[col.key];
            
            if (value === null || value === undefined || value === '') {
                td.textContent = '-';
            } else if (col.key.includes('_rate')) {
                // 比例字段显示为百分比
                const percentage = (parseFloat(value) * 100).toFixed(2);
                td.textContent = `${percentage}%`;
            } else if (col.key === 'effective_date') {
                td.textContent = value;
            } else {
                td.textContent = value;
            }
            
            tr.appendChild(td);
        });
        
        tbody.appendChild(tr);
    });
}

// 显示配置详情
async function showConfigDetail(configId) {
    try {
        const response = await fetch(`/api/twins/social_security_config/${configId}`);
        const result = await response.json();
        
        if (!result.success) {
            alert('加载失败: ' + result.error);
            return;
        }
        
        const config = result.data;
        currentEditConfigId = configId;
        const modal = document.getElementById('config-modal');
        const content = document.getElementById('config-detail-content');
        
        document.getElementById('edit-config-btn').onclick = () => {
            modal.classList.add('hidden');
            openEditConfigForm(configId);
        };
        
        let html = '<div class="space-y-6">';
        html += '<div>';
        html += '<h4 class="text-md font-semibold text-gray-900 mb-3">当前配置</h4>';
        html += '<div class="bg-gray-50 rounded-lg p-4 space-y-3">';
        
        const fields = schema.fields || {};
        const fieldNames = Object.keys(fields);
        for (const fieldName of fieldNames) {
            const fieldDef = fields[fieldName];
            const value = config.current[fieldName];
            if (value !== undefined && value !== null && value !== '') {
                const label = fieldDef.label || fieldName;
                let displayValue = value;
                
                // 如果是比例字段，显示为百分比
                if (fieldName.includes('_rate')) {
                    displayValue = (parseFloat(value) * 100).toFixed(2) + '%';
                }
                
                html += `<div class="flex">
                    <span class="text-sm font-medium text-gray-700 w-40">${label}:</span>
                    <span class="text-sm text-gray-900 flex-1">${displayValue}</span>
                </div>`;
            }
        }
        
        html += '</div></div>';
        
        if (config.history && config.history.length > 1) {
            html += '<div>';
            html += '<h4 class="text-md font-semibold text-gray-900 mb-3">历史版本</h4>';
            html += '<div class="overflow-x-auto">';
            html += '<table class="min-w-full divide-y divide-gray-200">';
            html += '<thead class="bg-gray-50"><tr>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">版本</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">生效日期</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">适用地区</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">养老单位%</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">养老个人%</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">医疗单位%</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">医疗个人%</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">公积金单位%</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">公积金个人%</th>';
            html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
            
            for (const record of config.history) {
                html += '<tr>';
                html += `<td class="px-4 py-3 text-sm text-gray-900">${record.version}</td>`;
                html += `<td class="px-4 py-3 text-sm text-gray-900">${record.data.effective_date || '-'}</td>`;
                html += `<td class="px-4 py-3 text-sm text-gray-900">${record.data.region || '全国'}</td>`;
                html += `<td class="px-4 py-3 text-sm text-gray-900">${record.data.pension_employer_rate ? (parseFloat(record.data.pension_employer_rate) * 100).toFixed(2) + '%' : '-'}</td>`;
                html += `<td class="px-4 py-3 text-sm text-gray-900">${record.data.pension_employee_rate ? (parseFloat(record.data.pension_employee_rate) * 100).toFixed(2) + '%' : '-'}</td>`;
                html += `<td class="px-4 py-3 text-sm text-gray-900">${record.data.medical_employer_rate ? (parseFloat(record.data.medical_employer_rate) * 100).toFixed(2) + '%' : '-'}</td>`;
                html += `<td class="px-4 py-3 text-sm text-gray-900">${record.data.medical_employee_rate ? (parseFloat(record.data.medical_employee_rate) * 100).toFixed(2) + '%' : '-'}</td>`;
                html += `<td class="px-4 py-3 text-sm text-gray-900">${record.data.housing_fund_employer_rate ? (parseFloat(record.data.housing_fund_employer_rate) * 100).toFixed(2) + '%' : '-'}</td>`;
                html += `<td class="px-4 py-3 text-sm text-gray-900">${record.data.housing_fund_employee_rate ? (parseFloat(record.data.housing_fund_employee_rate) * 100).toFixed(2) + '%' : '-'}</td>`;
                html += '</tr>';
            }
            
            html += '</tbody></table></div></div>';
        }
        
        html += '</div>';
        content.innerHTML = html;
        modal.classList.remove('hidden');
    } catch (error) {
        alert('加载失败: ' + error.message);
    }
}

// 加载配置列表
async function loadConfigs() {
    try {
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const container = document.getElementById('configs-container');
        const selector = document.getElementById('config-selector');
        const paramsGrid = document.getElementById('params-grid');
        
        if (!container || !selector || !paramsGrid) {
            console.error('必要的DOM元素未找到');
            if (error) {
                error.classList.remove('hidden');
                document.getElementById('error-message').textContent = '页面元素加载失败，请刷新页面';
            }
            return;
        }
        
        const response = await fetch('/api/twins/social_security_config');
        const result = await response.json();
        
        if (loading) loading.classList.add('hidden');
        
        if (!result.success) {
            if (error) {
                error.classList.remove('hidden');
                document.getElementById('error-message').textContent = result.error || '加载失败';
            }
            return;
        }
        
        if (error) error.classList.add('hidden');
        container.classList.remove('hidden');
        
        if (result.data && result.data.length > 0) {
            // 按生效日期降序排列，最新的在前
            result.data.sort((a, b) => {
                const dateA = a.effective_date || '';
                const dateB = b.effective_date || '';
                return dateB.localeCompare(dateA);
            });
            
            // 填充选择器
            if (selector) {
                selector.innerHTML = '<option value="">请选择配置版本</option>';
                result.data.forEach(config => {
                    const option = document.createElement('option');
                    option.value = config.id;
                    const region = config.region || '全国';
                    const date = config.effective_date || '';
                    option.textContent = `${region} - ${date} (ID: ${config.id})`;
                    selector.appendChild(option);
                });
                
                // 默认选择最新的配置
                if (result.data.length > 0) {
                    const latestConfig = result.data[0];
                    selector.value = latestConfig.id;
                    currentConfigId = latestConfig.id;
                    renderParamCards(latestConfig);
                }
            }
        } else {
            // 没有数据时，清空选择器并显示提示
            if (selector) {
                selector.innerHTML = '<option value="">暂无配置</option>';
            }
            if (paramsGrid) {
                paramsGrid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500">暂无配置，请点击"新增配置"创建</div>';
            }
        }
    } catch (err) {
        console.error('加载配置列表失败:', err);
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        if (loading) loading.classList.add('hidden');
        if (error) {
            error.classList.remove('hidden');
            const errorMsg = document.getElementById('error-message');
            if (errorMsg) {
                errorMsg.textContent = err.message || '加载失败，请刷新页面重试';
            }
        }
    }
}

// 打开新增表单
function openAddForm() {
    currentEditConfigId = null;
    document.getElementById('config-form-modal-title').textContent = '新增配置';
    renderConfigFormFields({});
    document.getElementById('config-form-modal').classList.remove('hidden');
}

// 打开编辑表单
async function openEditConfigForm(configId) {
    try {
        const response = await fetch(`/api/twins/social_security_config/${configId}`);
        const result = await response.json();
        
        if (!result.success) {
            alert('加载失败: ' + result.error);
            return;
        }
        
        currentEditConfigId = configId;
        document.getElementById('config-form-modal-title').textContent = '编辑配置（将创建新版本）';
        renderConfigFormFields(result.data.current);
        document.getElementById('config-form-modal').classList.remove('hidden');
    } catch (error) {
        alert('加载失败: ' + error.message);
    }
}

// 提交表单
async function submitForm(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    const data = {};
    const fields = schema.fields || {};
    const fieldNames = Object.keys(fields);
    
    for (const fieldName of fieldNames) {
        const value = formData.get(fieldName);
        if (value !== null && value !== '') {
            const fieldDef = fields[fieldName];
            if (fieldDef.type === 'decimal' || fieldDef.type === 'number') {
                data[fieldName] = parseFloat(value);
            } else {
                data[fieldName] = value.trim();
            }
        }
    }
    
    try {
        const url = currentEditConfigId 
            ? `/api/twins/social_security_config/${currentEditConfigId}`
            : '/api/twins/social_security_config';
        const method = currentEditConfigId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (!result.success) {
            alert('保存失败: ' + result.error);
            return;
        }
        
        // 关闭表单模态框
        document.getElementById('config-form-modal').classList.add('hidden');
        
        // 重新加载配置列表
        loadConfigs();
        
        // 如果是编辑，也关闭详情模态框
        if (currentEditConfigId) {
            document.getElementById('config-modal').classList.add('hidden');
        }
        
        alert('保存成功！');
    } catch (error) {
        alert('保存失败: ' + error.message);
    }
}

// 绑定事件
document.getElementById('add-config-btn').onclick = openAddForm;
document.getElementById('close-config-form-modal').onclick = () => {
    document.getElementById('config-form-modal').classList.add('hidden');
};
document.getElementById('cancel-config-form-btn').onclick = () => {
    document.getElementById('config-form-modal').classList.add('hidden');
};
document.getElementById('config-form').onsubmit = submitForm;

document.getElementById('close-modal').onclick = () => {
    document.getElementById('config-modal').classList.add('hidden');
};

// 配置选择器变化事件
document.getElementById('config-selector').addEventListener('change', async function() {
    const configId = parseInt(this.value);
    if (configId) {
        await loadCurrentConfig(configId);
    }
});

// 页面加载时获取数据
if (document.readyState === 'loading') {
    window.addEventListener('DOMContentLoaded', loadConfigs);
} else {
    loadConfigs();
}
</script>
{% endblock %}
