schema:
  version: "1.0"
  description: "Twin 类型系统定义 - Entity 和 Activity"

twins:
  # ========== Entity Twins ==========
  person:
    type: entity
    label: "人员"
    description: "人员实体"
    table: "persons"
    state_table: "person_history"
    mode: versioned
    unique_key: [person_id, version]
    
    fields:
      name:
        type: string
        required: true
        label: "姓名"
        validation:
          min_length: 1
          max_length: 50
        ui:
          component: text_input
      
      id_card:
        type: string
        required: false
        label: "身份证号"
        validation:
          pattern: "^[0-9X]{18}$"
        ui:
          component: text_input
      
      phone:
        type: string
        required: false
        label: "电话"
        validation:
          pattern: "^1[3-9]\\d{9}$"
        ui:
          component: tel_input
      
      email:
        type: string
        required: false
        label: "邮箱"
        validation:
          pattern: "^[\\w\\.-]+@[\\w\\.-]+\\.[a-zA-Z]{2,}$"
        ui:
          component: email_input
      
      address:
        type: string
        required: false
        label: "地址"
        ui:
          component: textarea
      
      avatar:
        type: string
        required: false
        label: "头像URL"
        ui:
          component: image_upload

  company:
    type: entity
    label: "公司"
    table: "companies"
    state_table: "company_history"
    mode: versioned
    unique_key: [company_id, version]
    
    fields:
      name:
        type: string
        required: true
        label: "公司名称"
        ui:
          component: text_input
      
      registration_number:
        type: string
        required: false
        label: "注册号"
        ui:
          component: text_input

  internal_project:
    type: entity
    label: "内部项目"
    description: "公司内部立项形成的项目"
    table: "internal_projects"
    state_table: "internal_project_history"
    mode: versioned
    unique_key: [internal_project_id, version]
    
    fields:
      name:
        type: string
        required: true
        label: "项目名称"
        ui:
          component: text_input
      
      department:
        type: string
        required: false
        label: "归属部门"
        ui:
          component: text_input
      
      project_manager:
        type: string
        required: false
        label: "项目经理"
        ui:
          component: text_input
      
      description:
        type: string
        required: false
        label: "项目描述"
        ui:
          component: textarea
      
      status:
        type: enum
        required: false
        label: "项目状态"
        options: ["筹备中", "进行中", "已暂停", "已完成", "已取消"]
        ui:
          component: select
      
      start_date:
        type: date
        required: false
        label: "开始日期"
        ui:
          component: date_picker
      
      end_date:
        type: date
        required: false
        label: "结束日期"
        ui:
          component: date_picker

  client_contract:
    type: entity
    label: "客户合同"
    description: "公司与客户签订的合同"
    table: "client_contracts"
    state_table: "client_contract_history"
    mode: versioned
    unique_key: [client_contract_id, version]
    
    fields:
      contract_number:
        type: string
        required: true
        label: "合同编号"
        ui:
          component: text_input
      
      contract_name:
        type: string
        required: true
        label: "合同名称"
        ui:
          component: text_input
      
      contract_type:
        type: enum
        required: true
        label: "合同类型"
        options: ["劳务", "专项"]
        ui:
          component: select
      
      client_company:
        type: string
        required: true
        label: "甲方单位"
        ui:
          component: text_input
      
      client_department:
        type: string
        required: false
        label: "甲方部门"
        ui:
          component: text_input
      
      client_manager:
        type: string
        required: false
        label: "甲方经理"
        ui:
          component: text_input
      
      contract_date:
        type: date
        required: false
        label: "合同签订日期"
        ui:
          component: date_picker
      
      contract_amount:
        type: decimal
        required: false
        label: "合同金额"
        validation:
          min: 0
        ui:
          component: number_input
          suffix: "元"
      
      status:
        type: enum
        required: false
        label: "合同状态"
        options: ["草稿", "已签订", "执行中", "已完成", "已终止", "已取消"]
        ui:
          component: select
      
      description:
        type: string
        required: false
        label: "合同描述"
        ui:
          component: textarea
      
  order:
    type: entity
    label: "订单"
    description: "客户合同逻辑拆分出的订单"
    table: "orders"
    state_table: "order_history"
    mode: versioned
    unique_key: [order_id, version]
    
    fields:
      order_number:
        type: string
        required: true
        label: "订单编号"
        ui:
          component: text_input
      
      order_type:
        type: enum
        required: true
        label: "订单类型"
        options: ["劳务", "专项"]
        ui:
          component: select
      
      amount:
        type: decimal
        required: false
        label: "订单金额"
        validation:
          min: 0
        ui:
          component: number_input
          suffix: "元"
      
      status:
        type: enum
        required: false
        label: "订单状态"
        options: ["待确认", "已确认", "执行中", "已完成", "已取消"]
        ui:
          component: select
      
      execution_start_date:
        type: date
        required: false
        label: "执行开始时间"
        description: "订单开始执行的日期"
        ui:
          component: date_picker
      
      description:
        type: string
        required: false
        label: "订单描述"
        ui:
          component: textarea
      
      expected_delivery_date:
        type: date
        required: false
        label: "预期交付日期"
        ui:
          component: date_picker
      
      actual_delivery_date:
        type: date
        required: false
        label: "实际交付日期"
        ui:
          component: date_picker

  # ========== Activity Twins ==========
  person_company_employment:
    type: activity
    label: "人员-公司聘用活动"
    description: "记录人员与公司的聘用管理活动"
    table: "person_company_employment_activities"
    
    related_entities:
      - entity: person
        role: employee
        key: person_id
        required: true
      - entity: company
        role: employer
        key: company_id
        required: true
    
    state_table: "person_company_employment_history"
    mode: versioned
    unique_key: [activity_id, version]
    
    fields:
      person_id:
        type: reference
        reference_entity: person
        required: true
        storage: foreign_key
      
      company_id:
        type: reference
        reference_entity: company
        required: true
        storage: foreign_key
      
      position:
        type: string
        required: false
        label: "职位"
        ui:
          component: text_input
      
      department:
        type: string
        required: false
        label: "部门"
        ui:
          component: text_input
      
      employee_number:
        type: string
        required: false
        label: "员工号"
        ui:
          component: text_input
      
      employee_type:
        type: enum
        required: false
        label: "员工类别"
        description: "实习、试用、外聘、正式，显示时用不同颜色"
        options: ["实习", "试用", "外聘", "正式"]
        ui:
          component: select
      
      position_category:
        type: enum
        required: false
        label: "岗位类别"
        description: "普通员工、部门负责人、BOSS，显示时用不同颜色"
        options: ["普通员工", "部门负责人", "BOSS"]
        ui:
          component: select
      
      job_level:
        type: enum
        required: false
        label: "职位级别"
        description: "初级、中级、高级、其他，显示时用不同颜色"
        options: ["初级", "中级", "高级", "其他"]
        ui:
          component: select
      
      salary_type:
        type: enum
        required: false
        label: "薪资类型"
        description: "薪资计量方式"
        options: ["年薪", "月薪", "日薪"]
        ui:
          component: select
      
      salary:
        type: decimal
        required: false
        label: "薪资"
        description: "当前薪资金额"
        validation:
          min: 0
        ui:
          component: number_input
          suffix: "元"
      
      change_type:
        type: enum
        required: true
        label: "变动类型"
        options: ["入职", "转岗", "调部门", "转公司", "停薪留职", "返岗", "离职"]
        ui:
          component: select
      
      change_date:
        type: date
        required: true
        label: "变动日期"
        ui:
          component: date_picker

  person_company_attendance:
    type: activity
    label: "人员-公司打卡活动"
    table: "person_company_attendance_activities"
    
    related_entities:
      - entity: person
        role: attendee
        key: person_id
        required: true
      - entity: company
        role: company
        key: company_id
        required: true
    
    state_table: "person_company_attendance_history"
    mode: time_series
    unique_key: [activity_id, date]
    
    fields:
      person_id:
        type: reference
        reference_entity: person
        required: true
        storage: foreign_key
      
      company_id:
        type: reference
        reference_entity: company
        required: true
        storage: foreign_key
      
      date:
        type: date
        required: true
        label: "日期"
        storage: unique_key
        ui:
          component: date_picker
      
      check_in_time:
        type: time
        required: false
        label: "上班时间"
        ui:
          component: time_picker
      
      check_out_time:
        type: time
        required: false
        label: "下班时间"
        ui:
          component: time_picker
      
      work_hours:
        type: decimal
        required: false
        label: "工作时长"
        validation:
          min: 0
          max: 24
        ui:
          component: number_input
          suffix: "小时"

  person_company_attendance_record:
    type: activity
    label: "人员-公司考勤记录"
    description: "记录人员每月的考勤汇总数据，包括事假、病假、其他情况和奖惩金额"
    table: "person_company_attendance_record_activities"
    
    related_entities:
      - entity: person
        role: employee
        key: person_id
        required: true
      - entity: company
        role: employer
        key: company_id
        required: true
    
    state_table: "person_company_attendance_record_history"
    mode: time_series
    unique_key: [activity_id, period]
    
    fields:
      person_id:
        type: reference
        reference_entity: person
        required: true
        storage: foreign_key
      
      company_id:
        type: reference
        reference_entity: company
        required: true
        storage: foreign_key
      
      period:
        type: string
        required: true
        label: "考勤周期"
        description: "考勤记录所属周期，格式：YYYY-MM，如 2024-01"
        validation:
          pattern: "^\\d{4}-\\d{2}$"
        storage: unique_key
        ui:
          component: text_input
      
      sick_leave_days:
        type: decimal
        required: false
        label: "病假天数"
        description: "当月病假天数"
        validation:
          min: 0
        default: 0
        ui:
          component: number_input
          suffix: "天"
      
      personal_leave_days:
        type: decimal
        required: false
        label: "事假天数"
        description: "当月事假天数"
        validation:
          min: 0
        default: 0
        ui:
          component: number_input
          suffix: "天"
      
      other:
        type: string
        required: false
        label: "其他"
        description: "其他考勤情况说明（用户自定义输入）"
        ui:
          component: textarea
      
      reward_punishment_amount:
        type: decimal
        required: false
        label: "奖惩金额"
        description: "当月奖惩金额，正数表示奖励，负数表示惩罚"
        default: 0
        ui:
          component: number_input
          suffix: "元"

  person_assessment:
    type: activity
    label: "人员考核活动"
    description: "记录针对人员的考核情况，包括考核周期、考核日期、考核等级和评语"
    table: "person_assessment_activities"
    
    related_entities:
      - entity: person
        role: assessee
        key: person_id
        required: true
    
    state_table: "person_assessment_history"
    mode: versioned
    unique_key: [activity_id, version]
    
    fields:
      person_id:
        type: reference
        reference_entity: person
        required: true
        storage: foreign_key
      
      assessment_period:
        type: string
        required: true
        label: "考核周期"
        description: "考核所属的周期，如'2024年第一季度'、'2024年度'等"
        ui:
          component: text_input
      
      assessment_date:
        type: date
        required: true
        label: "考核日期"
        description: "进行考核的日期"
        ui:
          component: date_picker
      
      grade:
        type: enum
        required: true
        label: "考核等级"
        options: ["A", "B", "C", "D", "E"]
        ui:
          component: select
      
      comments:
        type: string
        required: false
        label: "考核评语"
        description: "考核的详细评语和意见"
        ui:
          component: textarea

  social_security_config:
    type: entity
    label: "社保公积金配置"
    description: "系统级社保和公积金缴费比例及参数配置，支持版本化管理"
    table: "social_security_configs"
    state_table: "social_security_config_history"
    mode: versioned
    unique_key: [config_id, version]
    
    fields:
      region:
        type: string
        required: false
        label: "适用地区"
        description: "配置适用的地区（如：北京、上海），为空表示全国通用"
        ui:
          component: text_input
      
      effective_date:
        type: date
        required: true
        label: "生效日期"
        description: "配置生效的日期，用于版本控制"
        ui:
          component: date_picker
      
      # ===== 养老保险 =====
      pension_employer_rate:
        type: decimal
        required: true
        label: "养老单位缴费比例"
        description: "养老保险单位缴费比例（如：0.16 表示 16%）"
        validation:
          min: 0
          max: 1
        ui:
          component: number_input
          suffix: "%"
          step: 0.01
      
      pension_employee_rate:
        type: decimal
        required: true
        label: "养老个人缴费比例"
        description: "养老保险个人缴费比例（如：0.08 表示 8%）"
        validation:
          min: 0
          max: 1
        ui:
          component: number_input
          suffix: "%"
          step: 0.01
      
      # ===== 工伤保险 =====
      work_injury_employer_rate:
        type: decimal
        required: true
        label: "工伤单位缴费比例"
        description: "工伤保险单位缴费比例（个人不缴费）"
        validation:
          min: 0
          max: 1
        ui:
          component: number_input
          suffix: "%"
          step: 0.01
      
      # ===== 失业保险 =====
      unemployment_employer_rate:
        type: decimal
        required: true
        label: "失业单位缴费比例"
        description: "失业保险单位缴费比例"
        validation:
          min: 0
          max: 1
        ui:
          component: number_input
          suffix: "%"
          step: 0.01
      
      unemployment_employee_rate:
        type: decimal
        required: true
        label: "失业个人缴费比例"
        description: "失业保险个人缴费比例"
        validation:
          min: 0
          max: 1
        ui:
          component: number_input
          suffix: "%"
          step: 0.01
      
      # ===== 医疗保险 =====
      medical_employer_rate:
        type: decimal
        required: true
        label: "医疗单位缴费比例"
        description: "医疗保险单位缴费比例"
        validation:
          min: 0
          max: 1
        ui:
          component: number_input
          suffix: "%"
          step: 0.01
      
      medical_employee_rate:
        type: decimal
        required: true
        label: "医疗个人缴费比例"
        description: "医疗保险个人缴费比例"
        validation:
          min: 0
          max: 1
        ui:
          component: number_input
          suffix: "%"
          step: 0.01
      
      # ===== 生育保险 =====
      maternity_employer_rate:
        type: decimal
        required: true
        label: "生育单位缴费比例"
        description: "生育保险单位缴费比例（个人不缴费）"
        validation:
          min: 0
          max: 1
        ui:
          component: number_input
          suffix: "%"
          step: 0.01
      
      # ===== 大病保险 =====
      serious_illness_employee_amount:
        type: decimal
        required: true
        label: "大病个人缴费金额"
        description: "大病保险个人缴费金额（固定金额，非比例）"
        validation:
          min: 0
        ui:
          component: number_input
          suffix: "元/月"
          step: 0.01
      
      # ===== 住房公积金 =====
      housing_fund_employer_rate:
        type: decimal
        required: true
        label: "公积金单位缴费比例"
        description: "住房公积金单位缴费比例"
        validation:
          min: 0
          max: 1
        ui:
          component: number_input
          suffix: "%"
          step: 0.01
      
      housing_fund_employee_rate:
        type: decimal
        required: true
        label: "公积金个人缴费比例"
        description: "住房公积金个人缴费比例"
        validation:
          min: 0
          max: 1
        ui:
          component: number_input
          suffix: "%"
          step: 0.01
      
      description:
        type: string
        required: false
        label: "备注说明"
        description: "配置的备注说明，如政策依据、变更原因等"
        ui:
          component: textarea

  position_salary_ratio:
    type: entity
    label: "岗位薪资结构配置"
    description: "按岗位类别划分聘用薪资为基础薪资与绩效薪资的比例，用于应发计算第1步"
    table: "position_salary_ratios"
    state_table: "position_salary_ratio_history"
    mode: versioned
    unique_key: [position_salary_ratio_id, version]
    
    fields:
      position_category:
        type: enum
        required: true
        label: "岗位类别"
        description: "与聘用活动中的岗位类别一致"
        options: ["普通员工", "部门负责人", "BOSS"]
        ui:
          component: select
      
      base_ratio:
        type: decimal
        required: true
        label: "基础薪资占比"
        description: "聘用薪资中划为基础薪资的比例，如 0.7 表示 70%"
        validation:
          min: 0
          max: 1
        ui:
          component: number_input
          step: 0.01
      
      performance_ratio:
        type: decimal
        required: true
        label: "绩效薪资占比"
        description: "聘用薪资中划为绩效薪资的比例，如 0.3 表示 30%；与基础占比之和应为 1"
        validation:
          min: 0
          max: 1
        ui:
          component: number_input
          step: 0.01
      
      effective_date:
        type: date
        required: false
        label: "生效日期"
        description: "本比例配置生效的日期"
        ui:
          component: date_picker
      
      description:
        type: string
        required: false
        label: "备注"
        ui:
          component: textarea

  employee_type_discount:
    type: entity
    label: "员工类别折算配置"
    description: "按员工类别（试用/正式等）对基础薪资与绩效薪资的折算系数，用于应发计算第2步"
    table: "employee_type_discounts"
    state_table: "employee_type_discount_history"
    mode: versioned
    unique_key: [employee_type_discount_id, version]
    
    fields:
      employee_type:
        type: enum
        required: true
        label: "员工类别"
        description: "与聘用活动中的员工类别一致"
        options: ["实习", "试用", "外聘", "正式"]
        ui:
          component: select
      
      discount_ratio:
        type: decimal
        required: true
        label: "折算系数"
        description: "基础/绩效薪资乘以该系数，如试用 0.8 表示八折、正式 1.0 表示不打折"
        validation:
          min: 0
          max: 1
        ui:
          component: number_input
          step: 0.01
      
      effective_date:
        type: date
        required: false
        label: "生效日期"
        ui:
          component: date_picker
      
      description:
        type: string
        required: false
        label: "备注"
        ui:
          component: textarea

  assessment_grade_coefficient:
    type: entity
    label: "考核等级绩效系数配置"
    description: "考核等级对应的绩效系数，实际绩效薪资 = 折算后绩效薪资 × 该系数，用于应发计算第3步"
    table: "assessment_grade_coefficients"
    state_table: "assessment_grade_coefficient_history"
    mode: versioned
    unique_key: [assessment_grade_coefficient_id, version]
    
    fields:
      grade:
        type: enum
        required: true
        label: "考核等级"
        options: ["A", "B", "C", "D", "E"]
        ui:
          component: select
      
      coefficient:
        type: decimal
        required: true
        label: "绩效系数"
        description: "如 A=1.2、B=1.0、C=0.8 等"
        validation:
          min: 0
        ui:
          component: number_input
          step: 0.01
      
      effective_date:
        type: date
        required: false
        label: "生效日期"
        ui:
          component: date_picker
      
      description:
        type: string
        required: false
        label: "备注"
        ui:
          component: textarea

  client_contract_order:
    type: activity
    label: "客户合同-订单关联"
    description: "记录订单从客户合同拆分出来的关系"
    table: "client_contract_order_activities"
    
    related_entities:
      - entity: client_contract
        role: contract
        key: client_contract_id
        required: true
      - entity: order
        role: order
        key: order_id
        required: true
    
    state_table: "client_contract_order_history"
    mode: versioned
    unique_key: [activity_id, version]
    
    fields:
      client_contract_id:
        type: reference
        reference_entity: client_contract
        required: true
        storage: foreign_key
      
      order_id:
        type: reference
        reference_entity: order
        required: true
        storage: foreign_key
      
      split_date:
        type: date
        required: false
        label: "拆分日期"
        description: "订单从合同拆分出来的日期"
        ui:
          component: date_picker
      
      split_reason:
        type: string
        required: false
        label: "拆分原因"
        description: "订单拆分的原因说明"
        ui:
          component: textarea
      
      split_by:
        type: string
        required: false
        label: "拆分人"
        description: "执行拆分操作的人员"
        ui:
          component: text_input

  internal_project_order:
    type: activity
    label: "内部项目-订单关联"
    description: "记录内部项目与订单的关联关系"
    table: "internal_project_order_activities"
    
    related_entities:
      - entity: internal_project
        role: project
        key: internal_project_id
        required: true
      - entity: order
        role: order
        key: order_id
        required: true
    
    state_table: "internal_project_order_history"
    mode: versioned
    unique_key: [activity_id, version]
    
    fields:
      internal_project_id:
        type: reference
        reference_entity: internal_project
        required: true
        storage: foreign_key
      
      order_id:
        type: reference
        reference_entity: order
        required: true
        storage: foreign_key
      
      association_date:
        type: date
        required: false
        label: "关联日期"
        description: "内部项目与订单关联的日期"
        auto: date
        ui:
          component: date_picker
      
      association_reason:
        type: string
        required: false
        label: "关联原因"
        description: "内部项目与订单关联的原因说明"
        ui:
          component: textarea

  person_order_participation:
    type: activity
    label: "人员-订单参与活动"
    description: "记录人员参与订单的情况，包括参与类型、劳务订单的打卡方式和入项进度"
    table: "person_order_participation_activities"
    
    related_entities:
      - entity: person
        role: participant
        key: person_id
        required: true
      - entity: order
        role: order
        key: order_id
        required: true
    
    state_table: "person_order_participation_history"
    mode: versioned
    unique_key: [activity_id, version]
    
    fields:
      person_id:
        type: reference
        reference_entity: person
        required: true
        storage: foreign_key
      
      order_id:
        type: reference
        reference_entity: order
        required: true
        storage: foreign_key
      
      participation_type:
        type: enum
        required: true
        label: "参与类型"
        options: ["实际参加", "名义参加"]
        ui:
          component: select
      
      start_date:
        type: date
        required: false
        label: "开始时间"
        description: "劳务订单的开始时间（仅劳务订单需要）"
        ui:
          component: date_picker
      
      end_date:
        type: date
        required: false
        label: "结束时间"
        description: "劳务订单的结束时间（仅劳务订单需要）"
        ui:
          component: date_picker
      
      attendance_method:
        type: enum
        required: false
        label: "打卡方式"
        description: "劳务订单的打卡方式（仅劳务订单需要）"
        options: ["现场打卡", "线上打卡"]
        ui:
          component: select
      
      entry_progress:
        type: enum
        required: false
        label: "入项进度"
        description: "劳务订单的入项进度（仅劳务订单需要）"
        options: ["材料准备中", "已提交", "面试中"]
        ui:
          component: select

  person_company_social_security_base:
    type: activity
    label: "人员-公司社保基数"
    description: "记录人员在公司参保时的社保缴费基数及其变更历史"
    table: "person_company_social_security_base_activities"
    
    related_entities:
      - entity: person
        role: insured
        key: person_id
        required: true
      - entity: company
        role: employer
        key: company_id
        required: true
    
    state_table: "person_company_social_security_base_history"
    mode: versioned
    unique_key: [activity_id, version]
    
    fields:
      person_id:
        type: reference
        reference_entity: person
        required: true
        storage: foreign_key
      
      company_id:
        type: reference
        reference_entity: company
        required: true
        storage: foreign_key
      
      base_amount:
        type: decimal
        required: true
        label: "缴费基数"
        description: "社保缴费基数金额"
        validation:
          min: 0
        ui:
          component: number_input
          suffix: "元"
      
      effective_date:
        type: date
        required: true
        label: "生效日期"
        description: "本次社保缴费基数生效的日期"
        auto: date
        ui:
          component: date_picker

  person_company_housing_fund_base:
    type: activity
    label: "人员-公司公积金基数"
    description: "记录人员在公司参保时的公积金缴费基数及其变更历史"
    table: "person_company_housing_fund_base_activities"
    
    related_entities:
      - entity: person
        role: insured
        key: person_id
        required: true
      - entity: company
        role: employer
        key: company_id
        required: true
    
    state_table: "person_company_housing_fund_base_history"
    mode: versioned
    unique_key: [activity_id, version]
    
    fields:
      person_id:
        type: reference
        reference_entity: person
        required: true
        storage: foreign_key
      
      company_id:
        type: reference
        reference_entity: company
        required: true
        storage: foreign_key
      
      base_amount:
        type: decimal
        required: true
        label: "缴费基数"
        description: "公积金缴费基数金额"
        validation:
          min: 0
        ui:
          component: number_input
          suffix: "元"
      
      effective_date:
        type: date
        required: true
        label: "生效日期"
        description: "本次公积金缴费基数生效的日期"
        auto: date
        ui:
          component: date_picker

  person_tax_deduction:
    type: activity
    label: "人员专项附加扣除"
    description: "记录人员的个人所得税专项附加扣除信息及其变更历史"
    table: "person_tax_deduction_activities"
    
    related_entities:
      - entity: person
        role: taxpayer
        key: person_id
        required: true
    
    state_table: "person_tax_deduction_history"
    mode: versioned
    unique_key: [activity_id, version]
    
    fields:
      person_id:
        type: reference
        reference_entity: person
        required: true
        storage: foreign_key
      
      children_education_amount:
        type: decimal
        required: false
        label: "子女教育扣除金额"
        description: "每月子女教育专项附加扣除金额（单位：元）"
        validation:
          min: 0
          max: 2000
        ui:
          component: number_input
          suffix: "元/月"
      
      continuing_education_amount:
        type: decimal
        required: false
        label: "继续教育扣除金额"
        description: "每月继续教育专项附加扣除金额（单位：元）"
        validation:
          min: 0
          max: 400
        ui:
          component: number_input
          suffix: "元/月"
      
      medical_expense_amount:
        type: decimal
        required: false
        label: "大病医疗扣除金额"
        description: "年度大病医疗专项附加扣除金额（单位：元），按实际支出扣除，最高不超过80000元"
        validation:
          min: 0
          max: 80000
        ui:
          component: number_input
          suffix: "元/年"
      
      housing_loan_interest_amount:
        type: decimal
        required: false
        label: "住房贷款利息扣除金额"
        description: "每月住房贷款利息专项附加扣除金额（单位：元）"
        validation:
          min: 0
          max: 1000
        ui:
          component: number_input
          suffix: "元/月"
      
      housing_rent_amount:
        type: decimal
        required: false
        label: "住房租金扣除金额"
        description: "每月住房租金专项附加扣除金额（单位：元）"
        validation:
          min: 0
          max: 1500
        ui:
          component: number_input
          suffix: "元/月"
      
      elderly_support_amount:
        type: decimal
        required: false
        label: "赡养老人扣除金额"
        description: "每月赡养老人专项附加扣除金额（单位：元）"
        validation:
          min: 0
          max: 2000
        ui:
          component: number_input
          suffix: "元/月"
      
      infant_childcare_amount:
        type: decimal
        required: false
        label: "3岁以下婴幼儿照护扣除金额"
        description: "每月3岁以下婴幼儿照护专项附加扣除金额（单位：元）"
        validation:
          min: 0
          max: 2000
        ui:
          component: number_input
          suffix: "元/月"
      
      effective_date:
        type: date
        required: true
        label: "生效日期"
        description: "本次扣除生效的起始日期"
        auto: date
        ui:
          component: date_picker
      
      expiry_date:
        type: date
        required: false
        label: "失效日期"
        description: "扣除失效的日期（如子女毕业、贷款还清等）"
        ui:
          component: date_picker
      
      status:
        type: enum
        required: true
        label: "状态"
        description: "扣除状态"
        options: ["生效中", "已失效"]
        default: "生效中"
        ui:
          component: select
      
      remarks:
        type: string
        required: false
        label: "备注"
        description: "其他说明信息（如子女姓名、学校名称、贷款合同号、租赁地址等）"
        ui:
          component: textarea

  person_company_payroll:
    type: activity
    label: "人员-公司工资发放"
    description: "记录人员每月的工资计算和发放情况（包含计算依据快照和结果）"
    table: "person_company_payroll_activities"
    
    related_entities:
      - entity: person
        role: employee
        key: person_id
        required: true
      - entity: company
        role: employer
        key: company_id
        required: true
    
    state_table: "person_company_payroll_history"
    mode: time_series
    unique_key: [activity_id, period]
    
    fields:
      person_id:
        type: reference
        reference_entity: person
        required: true
        storage: foreign_key
      
      company_id:
        type: reference
        reference_entity: company
        required: true
        storage: foreign_key
      
      period:
        type: string
        required: true
        label: "发放周期"
        description: "工资发放周期，格式：YYYY-MM，如 2024-01"
        validation:
          pattern: "^\\d{4}-\\d{2}$"
        ui:
          component: text_input
      
      # ===== 计算依据快照 =====
      base_salary:
        type: decimal
        required: false
        label: "基本薪资（旧）"
        description: "兼容旧逻辑，新逻辑使用聘用薪资及应发各步中间结果"
        validation:
          min: 0
        ui:
          component: number_input
          suffix: "元"
      
      salary_type:
        type: enum
        required: false
        label: "薪资类型"
        options: ["年薪", "月薪", "日薪"]
        ui:
          component: select
      
      assessment_grade:
        type: enum
        required: false
        label: "考核等级"
        description: "最近一次考核等级（影响绩效系数）"
        options: ["A", "B", "C", "D", "E"]
        ui:
          component: select
      
      # ===== 应发计算中间结果 =====
      employment_salary:
        type: decimal
        required: false
        label: "聘用薪资"
        description: "当月聘用记录中的薪资，用于岗位划分与考勤扣减公式"
        validation:
          min: 0
        ui:
          component: number_input
          suffix: "元"
      
      base_salary_part:
        type: decimal
        required: false
        label: "基础薪资部分"
        description: "第1步：按岗位类别划分的基础薪资部分"
        validation:
          min: 0
        ui:
          component: number_input
          suffix: "元"
      
      performance_salary_part:
        type: decimal
        required: false
        label: "绩效薪资部分"
        description: "第1步：按岗位类别划分的绩效薪资部分"
        validation:
          min: 0
        ui:
          component: number_input
          suffix: "元"
      
      discounted_base_salary:
        type: decimal
        required: false
        label: "折算后基础薪资"
        description: "第2步：按员工类别折算后的基础薪资"
        validation:
          min: 0
        ui:
          component: number_input
          suffix: "元"
      
      discounted_performance_salary:
        type: decimal
        required: false
        label: "折算后绩效薪资"
        description: "第2步：按员工类别折算后的绩效薪资"
        validation:
          min: 0
        ui:
          component: number_input
          suffix: "元"
      
      performance_coefficient:
        type: decimal
        required: false
        label: "绩效系数"
        description: "第3步：考核等级对应的绩效系数"
        ui:
          component: number_input
      
      actual_performance_salary:
        type: decimal
        required: false
        label: "实际绩效薪资"
        description: "第3步：折算后绩效薪资 × 绩效系数"
        validation:
          min: 0
        ui:
          component: number_input
          suffix: "元"
      
      personal_leave_deduction:
        type: decimal
        required: false
        label: "事假扣减"
        description: "第4步：聘用薪资/21.75×事假天数"
        validation:
          min: 0
        ui:
          component: number_input
          suffix: "元"
      
      sick_leave_deduction:
        type: decimal
        required: false
        label: "病假扣减"
        description: "第4步：聘用薪资/21.75×0.3×病假天数"
        validation:
          min: 0
        ui:
          component: number_input
          suffix: "元"
      
      attendance_deduction:
        type: decimal
        required: false
        label: "考勤扣减合计"
        description: "第4步：事假扣减 + 病假扣减"
        validation:
          min: 0
        ui:
          component: number_input
          suffix: "元"
      
      reward_punishment_amount:
        type: decimal
        required: false
        label: "奖惩金额"
        description: "第5步：考勤中的奖惩金额，正为奖、负为惩"
        ui:
          component: number_input
          suffix: "元"
      
      social_security_base:
        type: decimal
        required: false
        label: "社保基数"
        description: "当月生效的社保缴费基数"
        validation:
          min: 0
        ui:
          component: number_input
          suffix: "元"
      
      housing_fund_base:
        type: decimal
        required: false
        label: "公积金基数"
        description: "当月生效的公积金缴费基数"
        validation:
          min: 0
        ui:
          component: number_input
          suffix: "元"
      
      tax_deduction_total:
        type: decimal
        required: false
        label: "专项附加扣除总额"
        description: "当月生效的专项附加扣除总额（元/月）"
        validation:
          min: 0
        ui:
          component: number_input
          suffix: "元/月"
      
      # ===== 社保公积金扣除中间结果 =====
      social_insurance_deduction:
        type: decimal
        required: false
        label: "社保三险个人合计"
        description: "第1步：社保基数×(养老个人比例+失业个人比例+医疗个人比例)"
        validation:
          min: 0
        ui:
          component: number_input
          suffix: "元"
      
      housing_fund_deduction:
        type: decimal
        required: false
        label: "公积金个人扣除"
        description: "第2步：公积金基数×公积金个人缴费比例"
        validation:
          min: 0
        ui:
          component: number_input
          suffix: "元"
      
      serious_illness_amount:
        type: decimal
        required: false
        label: "大病个人缴费金额"
        description: "第3步：从社保公积金配置中取出的大病个人缴费金额"
        validation:
          min: 0
        ui:
          component: number_input
          suffix: "元"
      
      social_housing_total_deduction:
        type: decimal
        required: false
        label: "社保公积金扣除合计"
        description: "第4步：社保三险个人 + 公积金个人 + 大病个人"
        validation:
          min: 0
        ui:
          component: number_input
          suffix: "元"
      
      # ===== 计算结果 =====
      base_amount:
        type: decimal
        required: true
        label: "应发金额"
        description: "第6步：折算后基础 + 实际绩效 − 考勤扣减 + 奖惩金额"
        validation:
          min: 0
        ui:
          component: number_input
          suffix: "元"
      
      performance_bonus:
        type: decimal
        required: false
        label: "绩效奖金（旧）"
        description: "兼容旧逻辑，新逻辑使用 actual_performance_salary"
        ui:
          component: number_input
          suffix: "元"
      
      social_security_deduction:
        type: decimal
        required: false
        label: "社保扣除（旧）"
        description: "兼容旧逻辑，新逻辑使用 social_insurance_deduction + serious_illness_amount；或等于社保公积金扣除合计中的社保部分"
        validation:
          min: 0
        ui:
          component: number_input
          suffix: "元"
      
      taxable_income:
        type: decimal
        required: false
        label: "应纳税所得额"
        description: "应发金额 − 社保公积金扣除合计 − 专项附加扣除 − 起征点（5000）"
        ui:
          component: number_input
          suffix: "元"
      
      tax_deduction:
        type: decimal
        required: false
        label: "个税扣除"
        description: "根据应纳税所得额计算的个人所得税"
        validation:
          min: 0
        ui:
          component: number_input
          suffix: "元"
      
      total_amount:
        type: decimal
        required: true
        label: "实发金额"
        description: "应发金额 − 社保公积金扣除合计 − 个税扣除"
        validation:
          min: 0
        ui:
          component: number_input
          suffix: "元"
      
      # ===== 状态信息 =====
      payment_date:
        type: date
        required: false
        label: "发放日期"
        description: "实际发放工资的日期"
        ui:
          component: date_picker
      
      status:
        type: enum
        required: true
        label: "状态"
        options: ["待发放", "已发放", "已取消"]
        default: "待发放"
        ui:
          component: select
      
      remarks:
        type: string
        required: false
        label: "备注"
        description: "其他说明信息"
        ui:
          component: textarea
