{
  "variable_labels": {
    "employment_salary": "聘用薪资",
    "base_ratio": "基础薪资比例",
    "perf_ratio": "绩效薪资比例",
    "employee_discount": "员工类别折算系数",
    "assessment_coefficient": "绩效系数",
    "gross_2": "基础薪资部分",
    "gross_3": "绩效薪资部分",
    "gross_4": "折算后基础薪资",
    "gross_5": "折算后绩效薪资",
    "gross_6": "绩效系数",
    "gross_7": "实际绩效薪资",
    "gross_8": "事假扣减",
    "gross_9": "病假扣减",
    "gross_10": "考勤扣减合计",
    "gross_11": "奖惩金额",
    "base_amount": "应发金额",
    "MONTHLY_WORK_DAYS": "月计薪天数",
    "personal_leave_days": "事假天数",
    "sick_leave_days": "病假天数",
    "reward_punishment_amount": "奖惩金额",
    "social_security_base": "社保基数",
    "housing_fund_base": "公积金基数",
    "pension_rate": "养老个人比例",
    "unemployment_rate": "失业个人比例",
    "medical_rate": "医疗个人比例",
    "housing_rate": "公积金个人比例",
    "serious_illness_amount": "大病个人缴费金额",
    "social_1": "社保三险个人合计",
    "social_2": "大病个人缴费金额",
    "social_3": "社保个人扣除",
    "social_4": "公积金个人扣除",
    "social_5": "社保公积金扣除合计",
    "tax_deduction_children": "子女教育",
    "tax_deduction_continuing": "继续教育",
    "tax_deduction_housing_loan": "住房贷款利息",
    "tax_deduction_housing_rent": "住房租金",
    "tax_deduction_elderly": "赡养老人",
    "tax_deduction_infant": "3岁以下婴幼儿照护",
    "tax_1": "专项累计扣除",
    "tax_2": "当年专项附加扣除合计",
    "tax_3": "累计扣除项目合计",
    "ytd_tax_1": "当年至上期专项累计扣除合计",
    "ytd_base_amount": "当年至上期应发金额合计",
    "tax_4": "累计收入",
    "months_employed_in_year": "本年度在岗月数",
    "tax_5": "减除费用",
    "tax_6": "应税收入",
    "tax_7": "累计计税部分",
    "tax_8": "累计个税",
    "tax_9": "本月个税",
    "prev_tax_8": "上期累计个税"
  },
  "variable_sources": {
    "employment_salary": { "source": "transform", "from": "employment", "transform": "salary_to_monthly" },
    "base_ratio": { "source": "lookup", "from": "employment", "field": "position_category", "lookup": "position_salary_ratio", "output": "base_ratio", "default": 0.7 },
    "perf_ratio": { "source": "lookup", "from": "employment", "field": "position_category", "lookup": "position_salary_ratio", "output": "performance_ratio", "default": 0.3 },
    "employee_discount": { "source": "lookup", "from": "employment", "field": "employee_type", "lookup": "employee_type_discount", "default": 1.0 },
    "assessment_coefficient": { "source": "lookup", "from": "assessment", "field": "grade", "lookup": "assessment_grade_coefficient", "default": 1.0 },
    "personal_leave_days": { "source": "field", "from": "attendance_record", "field": "personal_leave_days", "default": 0 },
    "sick_leave_days": { "source": "field", "from": "attendance_record", "field": "sick_leave_days", "default": 0 },
    "reward_punishment_amount": { "source": "field", "from": "attendance_record", "field": "reward_punishment_amount", "default": 0 },
    "MONTHLY_WORK_DAYS": { "source": "constant", "value": 21.75 },
    "social_security_base": { "source": "field", "from": "social_base", "field": "base_amount", "default": 0 },
    "housing_fund_base": { "source": "field", "from": "housing_base", "field": "base_amount", "default": 0 },
    "pension_rate": { "source": "config", "config": "social_security_config", "keyed_by": "period", "field": "pension_employee_rate", "default": 0.105 },
    "unemployment_rate": { "source": "config", "config": "social_security_config", "keyed_by": "period", "field": "unemployment_employee_rate", "default": 0 },
    "medical_rate": { "source": "config", "config": "social_security_config", "keyed_by": "period", "field": "medical_employee_rate", "default": 0 },
    "housing_rate": { "source": "config", "config": "social_security_config", "keyed_by": "period", "field": "housing_fund_employee_rate", "default": 0.12 },
    "serious_illness_amount": { "source": "config", "config": "social_security_config", "keyed_by": "period", "field": "serious_illness_employee_amount", "default": 0 },
    "tax_deduction_children": { "source": "field", "from": "tax_deduction", "field": "children_education_amount", "default": 0 },
    "tax_deduction_continuing": { "source": "field", "from": "tax_deduction", "field": "continuing_education_amount", "default": 0 },
    "tax_deduction_housing_loan": { "source": "field", "from": "tax_deduction", "field": "housing_loan_interest_amount", "default": 0 },
    "tax_deduction_housing_rent": { "source": "field", "from": "tax_deduction", "field": "housing_rent_amount", "default": 0 },
    "tax_deduction_elderly": { "source": "field", "from": "tax_deduction", "field": "elderly_support_amount", "default": 0 },
    "tax_deduction_infant": { "source": "field", "from": "tax_deduction", "field": "infant_childcare_amount", "default": 0 }
  },
  "payroll_ytd_variables": [
    { "variable_key": "ytd_tax_1", "field": "tax_1", "aggregation": "sum" },
    { "variable_key": "ytd_base_amount", "field": "base_amount", "aggregation": "sum" },
    { "variable_key": "prev_tax_8", "field": "tax_8", "aggregation": "last" }
  ],
  "sections": {
    "gross": {
      "label": "应发薪资计算",
      "step_order": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
      "steps": [
        {"step": 1, "field_name": "聘用薪资", "source": "variable", "variable_key": "employment_salary", "default_formula": "", "desc": "当月聘用记录中的薪资，用于岗位划分与考勤公式"},
        {"step": 2, "field_name": "基础薪资部分", "source": "formula", "output_key": "gross_2", "default_formula": "employment_salary * base_ratio", "desc": "第1步：按岗位类别划分的基础薪资部分"},
        {"step": 3, "field_name": "绩效薪资部分", "source": "formula", "output_key": "gross_3", "default_formula": "employment_salary * perf_ratio", "desc": "第1步：按岗位类别划分的绩效薪资部分"},
        {"step": 4, "field_name": "折算后基础薪资", "source": "formula", "output_key": "gross_4", "default_formula": "gross_2 * employee_discount", "desc": "第2步：按员工类别折算后的基础薪资"},
        {"step": 5, "field_name": "折算后绩效薪资", "source": "formula", "output_key": "gross_5", "default_formula": "gross_3 * employee_discount", "desc": "第2步：按员工类别折算后的绩效薪资"},
        {"step": 6, "field_name": "绩效系数", "source": "variable", "variable_key": "assessment_coefficient", "output_key": "gross_6", "default_formula": "", "desc": "第3步：考核等级对应的绩效系数"},
        {"step": 7, "field_name": "实际绩效薪资", "source": "formula", "output_key": "gross_7", "default_formula": "gross_5 * gross_6", "desc": "第3步：折算后绩效薪资 × 绩效系数"},
        {"step": 8, "field_name": "事假扣减", "source": "formula", "output_key": "gross_8", "default_formula": "employment_salary / MONTHLY_WORK_DAYS * personal_leave_days", "desc": "第4步：聘用薪资/21.75×事假天数"},
        {"step": 9, "field_name": "病假扣减", "source": "formula", "output_key": "gross_9", "default_formula": "employment_salary / MONTHLY_WORK_DAYS * 0.3 * sick_leave_days", "desc": "第4步：聘用薪资/21.75×0.3×病假天数"},
        {"step": 10, "field_name": "考勤扣减合计", "source": "formula", "output_key": "gross_10", "default_formula": "gross_8 + gross_9", "desc": "第4步：事假扣减 + 病假扣减"},
        {"step": 11, "field_name": "奖惩金额", "source": "variable", "variable_key": "reward_punishment_amount", "output_key": "gross_11", "default_formula": "", "desc": "第5步：考勤中的奖惩金额"},
        {"step": 12, "field_name": "应发金额", "source": "formula", "output_key": "base_amount", "default_formula": "max(0, gross_4 + gross_7 - gross_10 + gross_11)", "desc": "第6步：折算后基础 + 实际绩效 − 考勤扣减 + 奖惩"}
      ]
    },
    "social": {
      "label": "社保公积金扣除计算",
      "step_order": [1, 2, 3, 4, 5],
      "steps": [
        {"step": 1, "field_name": "社保三险个人合计", "source": "formula", "output_key": "social_1", "default_formula": "social_security_base * (pension_rate + unemployment_rate + medical_rate)", "desc": "第1步：社保基数×(养老+失业+医疗个人比例)"},
        {"step": 2, "field_name": "大病个人缴费金额", "source": "variable", "variable_key": "serious_illness_amount", "output_key": "social_2", "default_formula": "", "desc": "第2步：从社保公积金配置中取出的大病个人缴费金额"},
        {"step": 3, "field_name": "社保个人扣除", "source": "formula", "output_key": "social_3", "default_formula": "social_1 + social_2", "desc": "第3步：三险个人 + 大病个人"},
        {"step": 4, "field_name": "公积金个人扣除", "source": "formula", "output_key": "social_4", "default_formula": "housing_fund_base * housing_rate", "desc": "第4步：公积金基数×公积金个人缴费比例"},
        {"step": 5, "field_name": "社保公积金扣除合计", "source": "formula", "output_key": "social_5", "default_formula": "social_3 + social_4", "desc": "第5步：社保个人扣除 + 公积金个人扣除"}
      ]
    },
    "tax": {
      "label": "个税计算",
      "step_order": [1, 2, 3, 4, 5, 6, 7, 8, 9],
      "steps": [
        {"step": 1, "field_name": "专项累计扣除", "source": "formula", "output_key": "tax_1", "default_formula": "social_3 + social_4", "desc": "社保个人扣除+公积金个人扣除（专项累计扣除）"},
        {"step": 2, "field_name": "当年专项附加扣除合计", "source": "formula", "output_key": "tax_2", "default_formula": "tax_deduction_children + tax_deduction_continuing + tax_deduction_housing_loan + tax_deduction_housing_rent + tax_deduction_elderly + tax_deduction_infant", "desc": "当年专项附加扣除合计（子女教育+继续教育+住房贷款利息+住房租金+赡养老人+3岁以下婴幼儿照护）"},
        {"step": 3, "field_name": "累计扣除项目合计", "source": "formula", "output_key": "tax_3", "default_formula": "ytd_tax_1 + tax_1 + tax_2", "desc": "累计扣除项目合计 = 当年第一期至上一期专项累计扣除(tax_1)合计 + 当期专项累计扣除(tax_1) + 当年专项附加扣除合计(tax_2)"},
        {"step": 4, "field_name": "累计收入", "source": "formula", "output_key": "tax_4", "default_formula": "ytd_base_amount + base_amount", "desc": "累计收入 = 当年第一期至上一期应发金额(base_amount)合计 + 本期应发金额(base_amount)"},
        {"step": 5, "field_name": "减除费用", "source": "formula", "output_key": "tax_5", "default_formula": "months_employed_in_year * 5000", "desc": "减除费用 = 本年度在岗月数（按实际在公司的月数）× 5000；在岗月数由入职/离职记录计算"},
        {"step": 6, "field_name": "应税收入", "source": "formula", "output_key": "tax_6", "default_formula": "base_amount - tax_1", "desc": "应税收入 = 当期应发金额(base_amount) - 当期专项累计扣除(tax_1)"},
        {"step": 7, "field_name": "累计计税部分", "source": "formula", "output_key": "tax_7", "default_formula": "max(0, tax_6 - tax_3 - tax_5)", "desc": "累计计税部分 = 当期应税收入(tax_6) - 当期累计扣除项目合计(tax_3) - 当期减除费用(tax_5)，≤0 时取 0"},
        {"step": 8, "field_name": "累计个税", "source": "formula", "output_key": "tax_8", "default_formula": "cumulative_tax(tax_7)", "desc": "根据第七步累计计税部分(tax_7)和个税税率表(income_tax_brackets)计算：应纳税额 = 应纳税所得额 × 税率 − 速算扣除数"},
        {"step": 9, "field_name": "本月个税", "source": "formula", "output_key": "tax_9", "default_formula": "max(0, tax_8 - prev_tax_8)", "desc": "本月个税 = 当期累计个税(tax_8) - 上期累计个税(prev_tax_8)，≤0 时取 0"}
      ]
    }
  }
}
