{
  "variable_labels": {
    "employment_salary": "聘用薪资",
    "base_ratio": "基础薪资比例",
    "perf_ratio": "绩效薪资比例",
    "employee_discount": "员工类别折算系数",
    "assessment_coefficient": "绩效系数",
    "gross_base_part": "基础薪资部分",
    "gross_perf_part": "绩效薪资部分",
    "gross_base_discount": "折算后基础薪资",
    "gross_perf_discount": "折算后绩效薪资",
    "gross_coef": "绩效系数",
    "gross_perf_actual": "实际绩效薪资",
    "gross_personal_leave": "事假扣减",
    "gross_sick_leave": "病假扣减",
    "gross_attendance_deduction": "考勤扣减合计",
    "gross_reward_punishment": "奖惩金额",
    "base_amount": "应发金额",
    "MONTHLY_WORK_DAYS": "月计薪天数",
    "personal_leave_days": "事假天数",
    "sick_leave_days": "病假天数",
    "reward_punishment_amount": "奖惩金额",
    "social_security_base": "社保基数",
    "housing_fund_base": "公积金基数",
    "pension_rate": "养老个人比例",
    "unemployment_rate": "失业个人比例",
    "medical_rate": "医疗个人比例",
    "housing_rate": "公积金个人比例",
    "serious_illness_amount": "大病个人缴费金额",
    "social_three_insurance": "社保三险个人合计",
    "social_serious_illness": "大病个人缴费金额",
    "social_deduction": "社保个人扣除",
    "social_housing_deduction": "公积金个人扣除",
    "social_deduction_total": "社保公积金扣除合计",
    "tax_deduction_children": "子女教育",
    "tax_deduction_continuing": "继续教育",
    "tax_deduction_housing_loan": "住房贷款利息",
    "tax_deduction_housing_rent": "住房租金",
    "tax_deduction_elderly": "赡养老人",
    "tax_deduction_infant": "3岁以下婴幼儿照护",
    "tax_special_cumulative": "专项累计扣除",
    "tax_additional_total": "当年专项附加扣除合计",
    "tax_deduction_total": "累计扣除项目合计",
    "ytd_tax_special_cumulative": "当年至上期专项累计扣除合计",
    "ytd_base_amount": "当年至上期应发金额合计",
    "tax_cumulative_income": "累计收入",
    "months_employed_in_year": "本年度在岗月数",
    "tax_standard_deduction": "减除费用",
    "tax_taxable_income": "应税收入",
    "tax_cumulative_part": "累计计税部分",
    "tax_cumulative": "累计个税",
    "tax_monthly": "本月个税",
    "prev_tax_cumulative": "上期累计个税"
  },
  "variable_sources": {
    "employment_salary": { "source": "transform", "from": "employment", "transform": "salary_to_monthly" },
    "base_ratio": { "source": "lookup", "from": "employment", "field": "position_category", "lookup": "position_salary_ratio", "output": "base_ratio", "default": 0.7 },
    "perf_ratio": { "source": "lookup", "from": "employment", "field": "position_category", "lookup": "position_salary_ratio", "output": "performance_ratio", "default": 0.3 },
    "employee_discount": { "source": "lookup", "from": "employment", "field": "employee_type", "lookup": "employee_type_discount", "default": 1 },
    "assessment_coefficient": { "source": "lookup", "from": "assessment", "field": "grade", "lookup": "assessment_grade_coefficient", "default": 1 },
    "personal_leave_days": { "source": "field", "from": "attendance_record", "field": "personal_leave_days", "default": 0 },
    "sick_leave_days": { "source": "field", "from": "attendance_record", "field": "sick_leave_days", "default": 0 },
    "reward_punishment_amount": { "source": "field", "from": "attendance_record", "field": "reward_punishment_amount", "default": 0 },
    "MONTHLY_WORK_DAYS": { "source": "constant", "value": 21.75 },
    "social_security_base": { "source": "field", "from": "social_base", "field": "base_amount", "default": 0 },
    "housing_fund_base": { "source": "field", "from": "housing_base", "field": "base_amount", "default": 0 },
    "pension_rate": { "source": "config", "config": "social_security_config", "keyed_by": "period", "field": "pension_employee_rate", "default": 0.105 },
    "unemployment_rate": { "source": "config", "config": "social_security_config", "keyed_by": "period", "field": "unemployment_employee_rate", "default": 0 },
    "medical_rate": { "source": "config", "config": "social_security_config", "keyed_by": "period", "field": "medical_employee_rate", "default": 0 },
    "housing_rate": { "source": "config", "config": "social_security_config", "keyed_by": "period", "field": "housing_fund_employee_rate", "default": 0.12 },
    "serious_illness_amount": { "source": "config", "config": "social_security_config", "keyed_by": "period", "field": "serious_illness_employee_amount", "default": 0 },
    "tax_deduction_children": { "source": "field", "from": "tax_deduction", "field": "children_education_amount", "default": 0 },
    "tax_deduction_continuing": { "source": "field", "from": "tax_deduction", "field": "continuing_education_amount", "default": 0 },
    "tax_deduction_housing_loan": { "source": "field", "from": "tax_deduction", "field": "housing_loan_interest_amount", "default": 0 },
    "tax_deduction_housing_rent": { "source": "field", "from": "tax_deduction", "field": "housing_rent_amount", "default": 0 },
    "tax_deduction_elderly": { "source": "field", "from": "tax_deduction", "field": "elderly_support_amount", "default": 0 },
    "tax_deduction_infant": { "source": "field", "from": "tax_deduction", "field": "infant_childcare_amount", "default": 0 }
  },
  "payroll_ytd_variables": [
    { "variable_key": "ytd_tax_special_cumulative", "field": "tax_special_cumulative", "aggregation": "sum" },
    { "variable_key": "ytd_base_amount", "field": "base_amount", "aggregation": "sum" },
    { "variable_key": "prev_tax_cumulative", "field": "tax_cumulative", "aggregation": "last" }
  ],
  "sections": {
    "gross": {
      "label": "应发薪资计算",
      "step_order": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
      "steps": [
        { "step": 1, "field_name": "聘用薪资", "source": "variable", "variable_key": "employment_salary", "default_formula": "", "desc": "当月聘用记录中的月薪，用于岗位划分与考勤扣减公式" },
        { "step": 2, "field_name": "基础薪资部分", "source": "formula", "output_key": "gross_base_part", "default_formula": "employment_salary * base_ratio", "desc": "聘用薪资 × 基础薪资比例(base_ratio)，按岗位类别划分" },
        { "step": 3, "field_name": "绩效薪资部分", "source": "formula", "output_key": "gross_perf_part", "default_formula": "employment_salary * perf_ratio", "desc": "聘用薪资 × 绩效薪资比例(perf_ratio)，按岗位类别划分" },
        { "step": 4, "field_name": "折算后基础薪资", "source": "formula", "output_key": "gross_base_discount", "default_formula": "gross_base_part * employee_discount", "desc": "基础薪资部分(gross_base_part) × 员工类别折算系数(employee_discount)" },
        { "step": 5, "field_name": "折算后绩效薪资", "source": "formula", "output_key": "gross_perf_discount", "default_formula": "gross_perf_part * employee_discount", "desc": "绩效薪资部分(gross_perf_part) × 员工类别折算系数(employee_discount)" },
        { "step": 6, "field_name": "绩效系数", "source": "variable", "variable_key": "assessment_coefficient", "output_key": "gross_coef", "default_formula": "", "desc": "考核等级对应的绩效系数(assessment_coefficient)，来自 assessment_grade_coefficient 配置" },
        { "step": 7, "field_name": "实际绩效薪资", "source": "formula", "output_key": "gross_perf_actual", "default_formula": "gross_perf_discount * gross_coef", "desc": "折算后绩效薪资(gross_perf_discount) × 绩效系数(gross_coef)" },
        { "step": 8, "field_name": "事假扣减", "source": "formula", "output_key": "gross_personal_leave", "default_formula": "employment_salary / MONTHLY_WORK_DAYS * personal_leave_days", "desc": "聘用薪资 ÷ 月计薪天数(21.75) × 事假天数(personal_leave_days)" },
        { "step": 9, "field_name": "病假扣减", "source": "formula", "output_key": "gross_sick_leave", "default_formula": "employment_salary / MONTHLY_WORK_DAYS * 0.3 * sick_leave_days", "desc": "聘用薪资 ÷ 月计薪天数(21.75) × 0.3 × 病假天数(sick_leave_days)" },
        { "step": 10, "field_name": "考勤扣减合计", "source": "formula", "output_key": "gross_attendance_deduction", "default_formula": "gross_personal_leave + gross_sick_leave", "desc": "事假扣减(gross_personal_leave) + 病假扣减(gross_sick_leave)" },
        { "step": 11, "field_name": "奖惩金额", "source": "variable", "variable_key": "reward_punishment_amount", "output_key": "gross_reward_punishment", "default_formula": "", "desc": "考勤记录中的奖惩金额(reward_punishment_amount)" },
        { "step": 12, "field_name": "应发金额", "source": "formula", "output_key": "base_amount", "default_formula": "max(0, gross_base_discount + gross_perf_actual - gross_attendance_deduction + gross_reward_punishment)", "desc": "折算后基础(gross_base_discount) + 实际绩效(gross_perf_actual) − 考勤扣减合计(gross_attendance_deduction) + 奖惩(gross_reward_punishment)，结果≥0" }
      ]
    },
    "social": {
      "label": "社保公积金扣除计算",
      "step_order": [1, 2, 3, 4, 5],
      "steps": [
        { "step": 1, "field_name": "社保三险个人合计", "source": "formula", "output_key": "social_three_insurance", "default_formula": "social_security_base * (pension_rate + unemployment_rate + medical_rate)", "desc": "社保基数(social_security_base) × (养老+失业+医疗个人比例)，比例来自当期 social_security_config" },
        { "step": 2, "field_name": "大病个人缴费金额", "source": "variable", "variable_key": "serious_illness_amount", "output_key": "social_serious_illness", "default_formula": "", "desc": "当期社保公积金配置中的大病个人缴费金额(serious_illness_amount)" },
        { "step": 3, "field_name": "社保个人扣除", "source": "formula", "output_key": "social_deduction", "default_formula": "social_three_insurance + social_serious_illness", "desc": "社保三险个人合计(social_three_insurance) + 大病个人(social_serious_illness)" },
        { "step": 4, "field_name": "公积金个人扣除", "source": "formula", "output_key": "social_housing_deduction", "default_formula": "housing_fund_base * housing_rate", "desc": "公积金基数(housing_fund_base) × 公积金个人比例(housing_rate)" },
        { "step": 5, "field_name": "社保公积金扣除合计", "source": "formula", "output_key": "social_deduction_total", "default_formula": "social_deduction + social_housing_deduction", "desc": "社保个人扣除(social_deduction) + 公积金个人扣除(social_housing_deduction)" }
      ]
    },
    "tax": {
      "label": "个税计算",
      "step_order": [1, 2, 3, 4, 5, 6, 7, 8, 9],
      "steps": [
        { "step": 1, "field_name": "专项累计扣除", "source": "formula", "output_key": "tax_special_cumulative", "default_formula": "social_deduction + social_housing_deduction", "desc": "当期社保个人扣除(social_deduction) + 公积金个人扣除(social_housing_deduction)，即专项累计扣除" },
        { "step": 2, "field_name": "当年专项附加扣除合计", "source": "formula", "output_key": "tax_additional_total", "default_formula": "tax_deduction_children + tax_deduction_continuing + tax_deduction_housing_loan + tax_deduction_housing_rent + tax_deduction_elderly + tax_deduction_infant", "desc": "子女教育+继续教育+住房贷款利息+住房租金+赡养老人+3岁以下婴幼儿照护六项专项附加扣除之和，来自当期 tax_deduction" },
        { "step": 3, "field_name": "累计扣除项目合计", "source": "formula", "output_key": "tax_deduction_total", "default_formula": "ytd_tax_special_cumulative + tax_special_cumulative + tax_additional_total", "desc": "ytd_tax_special_cumulative(当年至上期专项累计扣除合计) + tax_special_cumulative(当期) + tax_additional_total(当年专项附加扣除)" },
        { "step": 4, "field_name": "累计收入", "source": "formula", "output_key": "tax_cumulative_income", "default_formula": "ytd_base_amount + base_amount", "desc": "ytd_base_amount(当年至上期应发合计) + base_amount(本期应发金额)" },
        { "step": 5, "field_name": "减除费用", "source": "formula", "output_key": "tax_standard_deduction", "default_formula": "months_employed_in_year * 5000", "desc": "本年度在岗月数(months_employed_in_year) × 5000。在岗月数在参考日所在年自然年内，按入职/离职记录计算；参考日=期数下一月 PAYROLL_REFERENCE_DAY 日" },
        { "step": 6, "field_name": "应税收入", "source": "formula", "output_key": "tax_taxable_income", "default_formula": "base_amount - tax_special_cumulative", "desc": "当期应发金额(base_amount) − 当期专项累计扣除(tax_special_cumulative)" },
        { "step": 7, "field_name": "累计计税部分", "source": "formula", "output_key": "tax_cumulative_part", "default_formula": "max(0, tax_taxable_income - tax_deduction_total - tax_standard_deduction)", "desc": "max(0, 应税收入(tax_taxable_income) − 累计扣除项目合计(tax_deduction_total) − 减除费用(tax_standard_deduction))" },
        { "step": 8, "field_name": "累计个税", "source": "formula", "output_key": "tax_cumulative", "default_formula": "cumulative_tax(tax_cumulative_part)", "desc": "按累计计税部分(tax_cumulative_part)和 income_tax_brackets 税率表计算：应纳税额 = 应纳税所得额 × 税率 − 速算扣除数" },
        { "step": 9, "field_name": "本月个税", "source": "formula", "output_key": "tax_monthly", "default_formula": "max(0, tax_cumulative - prev_tax_cumulative)", "desc": "max(0, 当期累计个税(tax_cumulative) − 上期累计个税(prev_tax_cumulative))" }
      ]
    }
  }
}
