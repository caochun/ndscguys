# 项目进展记录 - 2025年

## 2025-01-XX - 薪酬批量发放预览表格优化与DSL系统简化

### 一、DSL系统简化

#### 1.1 简化配置结构
- **变更**：将复杂的DSL系统简化为仅保留配置映射部分
- **移除**：删除了复杂的 `rules` 和 `calculations` 定义
- **保留**：只保留 `configs` 部分，包含：
  - `performance_factors`: 绩效系数映射
  - `split_ratios`: 基数/绩效拆分比例
  - `probation_discount`: 试用期折扣
  - `default_work_days`: 默认工作天数
- **优势**：更简单、更安全，用户只需修改配置参数，计算逻辑由系统固定

#### 1.2 代码调整
- 修改 `PersonService._load_dsl_config()` 方法，只返回 `configs` 部分
- 修改 `PersonService._calculate_payroll_for_person()` 方法，从配置中读取参数但使用固定计算逻辑
- 更新 API 验证逻辑，只验证 `configs` 部分
- 更新前端编辑器，简化默认模板

#### 1.3 文件清理
- 删除了 `DSL_README.md` 和 `DSL_IMPLEMENTATION.md` 文档文件

### 二、薪酬批量发放预览表格优化

#### 2.1 两层表头设计
- **实现**：将单层表头改为两层表头结构
- **第一层（分组标题）**：
  - 基础信息（5列）
  - 考勤信息（1列）
  - 社保公积金基数（2列）
  - 月薪制计算参数（2列）
  - 薪资构成（4列）
  - 扣款项（4列）
  - 应发（税前）（1列）
- **第二层（具体列名）**：显示每个分组下的具体列名
- **样式**：
  - 第一层：蓝色背景（#2196F3），白色文字，加粗
  - 第二层：浅蓝色背景（#42A5F5），白色文字

#### 2.2 列合并优化
- **考勤信息**：将"预期天数"、"实际天数"、"缺勤天数"三列合并为一列
  - 显示格式：`22/20/2`（预期/实际/缺勤）
  - 表头两层：第一层显示"考勤信息"，第二层显示"预期/实际/缺勤"
- **基数/绩效比例**：将"基数比例"和"绩效比例"合并为一列
  - 显示格式：`0.7/0.3`（基数比例/绩效比例）
- **考核等级与绩效系数**：将"考核等级"和"绩效系数"合并为一列
  - 显示格式：`B(1.0)`（考核等级(绩效系数)）
  - 列名简化为"考核"

#### 2.3 列位置调整
- **调整后薪资**：从"月薪制计算参数"组移动到"基础信息"组
  - 位置：在"原始薪资"之后，"员工类别"之前
- **考核等级**：从"基础信息"组移动到"月薪制计算参数"组
  - 与"绩效系数"合并显示

#### 2.4 表格列数优化
- **优化前**：24列
- **优化后**：20列
- **表格宽度**：从 2000px 调整为 1800px

### 三、考核等级下拉选择功能

#### 3.1 API端点
- **新增**：`GET /api/payroll/config/performance-factors`
- **功能**：获取绩效系数配置（从激活的DSL规则或默认配置）
- **返回**：绩效系数映射字典，例如 `{A: 1.2, B: 1.0, C: 0.8, D: 0.5, E: 0.0}`

#### 3.2 前端功能
- **下拉列表**：在预览模式下，"考核"列显示下拉选择框
- **选项格式**：`A(1.2)`, `B(1.0)` 等，显示考核等级和对应绩效系数
- **自动计算**：选择考核等级后，自动：
  - 更新绩效系数
  - 重新计算绩效金额 = 绩效基数 × 绩效系数
  - 重新计算扣前应发 = 基数部分 + 绩效金额
  - 重新计算应发（税前）= 扣前应发 - 考勤扣款 - 个人社保 - 个人公积金 - 其他补扣
- **数据保存**：确认时保存考核等级和绩效系数的修改

#### 3.3 后端支持
- **更新方法**：修改 `PersonService.update_payroll_batch_items()` 方法
- **支持字段**：
  - `assessment_grade`: 考核等级
  - `performance_factor`: 绩效系数
  - `performance_amount`: 绩效金额（自动计算）
  - `gross_amount_before_deductions`: 扣前应发（自动计算）
  - `net_amount_before_tax`: 应发（税前）（自动计算）

#### 3.4 用户体验
- **实时反馈**：选择考核等级后立即更新相关金额
- **视觉提示**：下拉列表显示格式清晰（等级(系数)）
- **数据来源**：从DSL配置读取，确保与系统规则一致

### 四、技术细节

#### 4.1 文件修改清单
- `app/services/person_service.py`: DSL配置加载和薪资计算逻辑
- `app/api.py`: 新增绩效系数配置API端点
- `app/static/js/payroll_batch.js`: 表格渲染和考核等级选择功能
- `app/templates/payroll_batch.html`: 表格样式优化
- `config/payroll_rules.yaml`: 简化的DSL配置文件

#### 4.2 数据库字段
- `payroll_batch_items` 表支持更新：
  - `assessment_grade`
  - `performance_factor`
  - `performance_amount`
  - `gross_amount_before_deductions`
  - `net_amount_before_tax`

### 五、改进效果

1. **表格更清晰**：两层表头结构，信息分组明确
2. **空间更节省**：从24列减少到20列，表格宽度减少200px
3. **操作更便捷**：考核等级可通过下拉选择，自动计算相关金额
4. **配置更简单**：DSL系统只保留配置映射，降低使用门槛
5. **维护更容易**：计算逻辑固定，只需调整配置参数

### 六、后续优化建议

1. 考虑添加更多可编辑字段的下拉选择（如员工类别、薪资类型等）
2. 优化表格响应式设计，在小屏幕上自动调整列宽
3. 添加批量修改考核等级的功能
4. 考虑添加考核等级变更历史记录
5. 优化表格性能，支持大量数据的分页或虚拟滚动
